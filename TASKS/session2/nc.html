<!DOCTYPE html>
<html>
	<head>
		<title>Choose Your Treasure</title>
		<script src="jspsych-6.0.5/jspsych.js"></script>
		<script src="jspsych-6.0.5/plugins/jspsych-fullscreen.js"></script>
		<script src="jspsych-6.0.5/plugins/jspsych-external-html.js"></script>
		<script src="jspsych-6.0.5/plugins/jspsych-instructions.js"></script>
		<script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
		<script src="jspsych-6.0.5/plugins/jspsych-html-button-response.js"></script>
	  <script src="jspsych-6.0.5/plugins/jspsych-survey-multi-choice.js"></script>
		<script src='jspsych-6.0.5/plugins/jspsych-survey-text.js'></script>
		<script src='jspsych-6.0.5/plugins/numerosity-comparison-plugin.js'></script>
		<script src="jspsych-6.0.5/plugins/jspsych-call-function.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<script src='jspsych-6.0.5/plugins/jspsych-survey-text.js'></script>
		<link rel="stylesheet" href="jspsych-6.0.5/css/jspsych_nc.css"></link>
		<link rel='stylesheet' type='text/css' href='jspsych-6.0.5/css/jspsych_nc.css'>
		<link rel="stylesheet" href="jspsych-6.0.5/css/style.css"></link>
	</head>
	<body></body>
	<script>

// quick change variables

			nextTask_name = "Lottery Ticket Game";
			nextTask_Id = "lt";

			var trial_reps = 8//8 // multiples of 2 for the 2 controls
			var reps_in_block = 40//40 // multiples of 2 for the 2 controls (2 reps in block yields 4 trials)
			bonus_fraction = 20/(reps_in_block*2*2)// 2 blocks
			error_rate_cap = 0.60//0.60 // if they get more than 50% of the answers wrong they are flagged as suspicious

// start timeline

			timeline = []
// add identifying information for primary key

			// weeks of participation
			var weekId = "1"; // change weekly
			jsPsych.data.addProperties({
				weekId: weekId
			});

			// experiment Id -  numerosity comparison (formerly magnitude estimation) = nc
			var expId = "nc_" + jsPsych.randomization.randomID(8);
			var eId = "nc";
			jsPsych.data.addProperties({
				expId: eId
			});

			var fullurl = window.location.href;
			jsPsych.data.addProperties({
				url: fullurl
			});

			var subjectId = jsPsych.data.getURLVariable('workerId');
			jsPsych.data.addProperties({
				subjectId: subjectId
			});

			var assignmentId = jsPsych.data.getURLVariable('assignmentId');
			jsPsych.data.addProperties({
				assignmentId: assignmentId
			});

			var hitId = jsPsych.data.getURLVariable('hitId');
			jsPsych.data.addProperties({
				hitId: hitId
			});

// fullscreen mode

			var fullscreen_intro = {
					type: 'instructions',
					pages: [
						"<p>On the next screen you will be asked to put your browser in full screen mode.</p>" +
						"<p>After entering full screen mode it is very important that you do not exit, switch tabs, minimize, or adjust the browser for the remainder of the game.</p>" +
						"<p>Doing so changes the display of the game and the game does not pause once started.</p>" +
						"<p>We can detect if you exit fullscreen, minimize the window, or switch to another tab, and we reserve the right to withold bonus/payment if this is indicated.</p>",
						],
				 show_clickable_nav: true,
				 on_finish: function(data) {
					jsPsych.data.addDataToLastTrial({
						exp_stage:"fullscreen",
						primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
						exp_part: "fullscreen"
					})
				}
			};
			timeline.push(fullscreen_intro)

			var fullscreen = {
				type: 'fullscreen',
				fullscreen_mode: true,
				on_finish: function(data) {
					jsPsych.data.addDataToLastTrial({
						exp_stage:"fullscreen",
						primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
						exp_part: "fullscreen"
					})
				}
			}

			timeline.push(fullscreen)


// instructions block

			var instructions = {
			    type: 'instructions',
					pages: [
					  '<p>Welcome to the <b>Choose Your Treasure</b> Game!</p> <p>This game will take approximately 10 minutes to complete. </p> <p> Click next to read the instructions.</p>',

					    "<p align='left'> For this game, you will be briefly be shown two treasure chests and the gold they hold .</p>" +
							"<p align='left'> Every gold coin, regarless of it's size is worth the same amount. .</p>" +
							"<p align='left'> Your job is to decide, as quickly as possible, whether the left chest or right chest has more gold coins. </p>" +
					    '<img src="img/gold.png"></img><p>',

					    "<p align='left'> If you do not decide quickly enough, your response will be invalidated.</p>"+

							"<p align='left'> You will indicate your choice by pressing keys on your keyboard." +
							"<p align='left'> If you believe that the chest on the <b>left has more gold coins</b>, press the <b>left arrow key</b> on your keyboard" +
							"<p align='left'> If you believe that the chest on the <b>right has more gold coins</b>, press the <b>right arrow key</b> on your keyboard" +
							"<p align='left'> If you press a key other than one of the arrow keys or if you are too slow, your response will be recorded as invalid. </p>",

							"<p align='left'> Next, you will answer some questions to make sure you understand the task. Then you will do a practice trial to gain familiarity with the task.</p> "+
							"<p align='left'> During this practice round, you will be shown whether your response was <q>Correct</q>, <q>Incorrect</q>, or an <q>Invalid Response</q>.</p> " +
							"<p align='left'> You will only be given this feedback during the practice trial and <b>not during the actual experiment</b>. </p>" +
							"<p align='left'> Press the <q>Next</q> button to answer the instruction comprehension questions.</p>"

					   ],
				  show_clickable_nav: true,
					on_finish: function(data) {
						jsPsych.data.addDataToLastTrial({
							exp_stage:"instructions",
							primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
							exp_part: "instructions"
						})
					}
			};
			timeline.push(instructions)

// instruction comprehension questions

			var instruction_questions = {
					type:'survey-multi-choice',
					questions: [
						{prompt: "What choice do you want to indicate in this task?",
							options: ["I choose the side with more gold coins", "I choose the side with fewer gold coins", "I choose the side with larger gold coins", "I choose the side with smaller gold coins"]},
						{prompt: "How do you indicate what your choice is?",
							options: ["I click my preferred choice on the screen", "I press the '1' or '2' keys on my keyboard to indicate my choice of the first or second option", "I press the left or right arrow keys on my keyboard to indicate my choice of the left or right option", "I press the 'Q' or 'P' keys on my keyboard to indicate my choice of the left(Q) or right(P) option" ]}
						],
					required: true,
					on_finish: function(data) {
						jsPsych.data.addDataToLastTrial({
							exp_stage:"instruction_questions",
							primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
							exp_part: "instructions"
						})
					}
			};

			timeline.push(instruction_questions);

			// what they see if they answered one or both questions incorrectly the first time
			var redo_instructions = {
					type: 'instructions',
					pages: [
						"<p> Hmm...Based on one or more of your answers to the previous questions, it looks as if you may not fully understand the task. </p>" +
						"<p> If you are unable to answer the questions correctly again, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
						"<p> Please click 'Next' to return to the instructions. </p>"

					],
					show_clickable_nav: true,
					on_finish: function(data) {
						jsPsych.data.addDataToLastTrial({
							exp_stage:"instruction_fail_first",
							primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
							exp_part: "instructions"
						})
					},
			};

			// what they see if they answered one or both of the questions incorrectly more than once
			var failed_instructions = {
					type: 'instructions',
					pages: [
						"<p> We're sorry, it appears as if you have failed to answer one or both of the instruction comprehension questions twice. </p>" +
						"<p> You may not receive a bonus payment for this task </p>" +
						"<p> <b> If you fail to answer the instruction comprehension questions a third time you may be asked to leave the study. </b></p>"
					],
					show_clickable_nav: true,
					on_finish: function(data) {
						jsPsych.data.addDataToLastTrial({
							exp_stage:"instruction_fail_again",
							primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
							exp_part: "instructions"
						})
					},
			};

			// evaluates question responses and loops timeline if questions are incorrect (part 3)
			// Note: you need all three parts (next two follow) for this function to work
			var instructions_understood3 = {
					timeline: [failed_instructions, instructions, instruction_questions],
					conditional_function:   function() {
							var dat = jsPsych.data.getLastTrialData().values()[0];
							var dat1 = jsPsych.data.getLastTrialData().values()[1];
							var answer1 = JSON.parse(dat.responses).Q0;
							var answer2 = JSON.parse(dat.responses).Q1;
							if(answer1.includes('more gold') == true && answer2.includes('arrow') == true) {
									return false;
							} else {
									return true;
							}
						},
				};

			// evaluates question responses and loops timeline if questions are incorrect (part 2)
			var instructions_understood2 = {
					timeline: [failed_instructions, instructions, instruction_questions, instructions_understood3],
					conditional_function:   function() {
							var dat = jsPsych.data.getLastTrialData().values()[0];
							var dat1 = jsPsych.data.getLastTrialData().values()[1];
							var answer1 = JSON.parse(dat.responses).Q0;
							var answer2 = JSON.parse(dat.responses).Q1;
							if(answer1.includes('more gold') == true && answer2.includes('arrow') == true) {
									return false;
							} else {
									return true;
							}
						},
				};

			// evaluates question responses and loops timeline if questions are incorrect (part 1)
			var instructions_understood = {
					timeline: [redo_instructions, instructions, instruction_questions, instructions_understood2],
					conditional_function:   function() {
							var dat = jsPsych.data.getLastTrialData().values()[0];
							var dat1 = jsPsych.data.getLastTrialData().values()[1];
							var answer1 = JSON.parse(dat.responses).Q0;
							var answer2 = JSON.parse(dat.responses).Q1;
							if(answer1.includes('more gold') == true && answer2.includes('arrow') == true) {
									return false;
							} else {
									return true;
							}
						},
				};

			timeline.push(instructions_understood);

// helper functions

			var controls = [
					{ control_type: "SA", data: { control_type: "SA"} },
					{ control_type: "radius", data: { control_type: "radius"}},
				];

			function make_stim(block, stage, part){
				return {
					type:'numerosity-task',
					choices: [37, 39],
					control_type: jsPsych.timelineVariable('control_type'),
					data: jsPsych.timelineVariable('data'),
					circle_color:'yellow',
					background_color: 'black',
					trial_duration: 1000,
					feedback: true,
					image_below: 'img/chest3.png',
					on_finish: function(data) {
						if (data.correct == true) {
							data.trial_bonus = bonus_fraction
						} else {
							data.trial_bonus = "0"
						}

						if (data.key_press == 37) {
							data.key_choice = "left"
						} else if (data.key_press == 39) {
							data.key_choice = "right"
						} else if (data.key_press == -1) {
							data.key_choice = "no_choice"
						}
						all_correct = jsPsych.data.get().filter({correct: true}).count()
						practice_correct = jsPsych.data.get().filter({correct: true, exp_stage: 'practice_choice'}).count()
						data.curr_bonus = (all_correct - practice_correct)* bonus_fraction
						data.block = block
						data.exp_stage = stage
						data.exp_part = part
						jsPsych.data.addDataToLastTrial({
							primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
						})
					}
				};
			}

			function make_break(percent) {
				return {
					type: "html-keyboard-response",
					trial_duration: 60000,
				 stimulus: function(){
					 var curr_bonus = jsPsych.data.get().last(1).values()[0].curr_bonus;
					 var rounded_bonus = Math.round(curr_bonus)

					 return "<p>You have completed " + percent + "% of the task and earned <b>"+ rounded_bonus + "</b> bonus points in total!</p>" +
					 "<p>Feel free to take a few seconds break, but not too long. This will time out after 1 minute.</p>" +
					 "<p>Press any key to resume the task.</p>"},
					 on_finish: function(data) {
						 var curr_block = jsPsych.data.get().last(2).values()[0].block;
						 data.num_lefts = jsPsych.data.get().filter({key_press: 37, block: curr_block}).count()
						 data.num_rights = jsPsych.data.get().filter({key_press: 39, block: curr_block}).count()
						 data.num_na = jsPsych.data.get().filter({key_press: -1, block: curr_block}).count()

						 ttl_correct = jsPsych.data.get().filter({correct: true, block: curr_block}).count()
						 error_rate = 1 - (ttl_correct/(reps_in_block*2))
						 data.error_block = error_rate

						 if (data.num_lefts == reps_in_block*2 || data.num_rights == reps_in_block*2){
							 data.suspicious_type = 'all_one'
							 data.suspicious = true
						 }
						 else if (error_rate >= error_rate_cap){
							 data.suspicious_type = 'error_rate'
							 data.suspicious = true
						 }
						 else if (data.num_na == reps_in_block*2){
							 data.suspicious_type = 'time_outs'
							 data.suspicious = true
						 }
						 else {
							 data.suspicious = true
						 }
						 data.block = curr_block // defines as this block after the filtering to determine num gos
	           data.exp_part = 'main'

						 jsPsych.data.addDataToLastTrial({
							 exp_stage:"between_block",
							 primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
						 })
					 }
				 }
			 }

// practice block :

			// precursor
			var trial_start = {
				type: 'html-keyboard-response',
				stimulus: 'Press any key to start the practice trial </p>',
				on_finish: function(data) {
					jsPsych.data.addDataToLastTrial({
						exp_stage:"practice_start",
						primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
						exp_part: "practice"
					})
				}
		};

			timeline.push(trial_start)

			// trial feedback
			var practice_feedback = {
						type: 'html-keyboard-response',
						choices: jsPsych.NO_KEYS,
						trial_duration: 500,
						on_load: function(data){
							jsPsych.data.addDataToLastTrial({
								curr_bonus: jsPsych.data.get().filter({correct: true, exp_stage: 'practice_choice'}).count() * bonus_fraction
							})
						},
						stimulus: function(){
							var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
							var last_choice = jsPsych.data.get().last(1).values()[0].key_press;
							document.body.style.background = "black";
							if(last_trial_correct){
								return "<p><font size='5' color='green'>Correct</font></p>";
							}
							else if (last_choice == -1){
								return "<p><font size='5' color='dimgray'>Invalid Response</font></p>"
							}
							else {
								return "<p><font size='5' color='red'>Incorrect</font></p>"
							}
						},
					on_finish: function(data){
						document.body.style.background = "White";
          	jsPsych.data.addDataToLastTrial({
						block: "block_p",
            exp_stage:"practice_feedback",
            primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
          })
        }
    };

			// trial procedure
			var practice_procedure = {
			  timeline: [make_stim('block_p', 'practice_choice', 'practice'), practice_feedback],
			  repetitions: trial_reps,
			  randomize_order: true,
				timeline_variables: controls,
				data: {exp_part:'practice'},
			}
			timeline.push(practice_procedure);

			// end of trial
			var end_trial = {
				type: 'html-keyboard-response',
				stimulus: '<p>This marks the end of the Practice Trial.</p> <p>Press any key to continue to the main experiment.</p>',
				on_finish: function(data) {
					num_lefts = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: 37, block: "block_p"}).count()
					num_rights = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: 39, block: "block_p"}).count()
					num_na = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: -1, block: "block_p"}).count()
					num_corr = jsPsych.data.get().last(2*2*trial_reps+1).filter({block: "block_p", correct: true}).count()
					data.error_block = 1 - (num_corr/(trial_reps*2))
					data.num_lefts = num_lefts
					data.num_rights = num_rights
					data.num_na = num_na
					jsPsych.data.addDataToLastTrial({
						exp_stage:"practice_end",
						exp_part: "practice",
						primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
						suspicious: 'false',
						block: "block_p"
					})
				}
			}

			// trial completed without suspicion
			var no_sus = {
				timeline: [end_trial],
				conditional_function:   function(data) {
					num_lefts = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: 37, block: "block_p", exp_stage: "practice_choice"}).count()
					num_rights = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: 39, block: "block_p", exp_stage: "practice_choice"}).count()
					num_na = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: -1, block: "block_p", exp_stage: "practice_choice"}).count()

						correct_oi = jsPsych.data.get().last(2*2*trial_reps+1).filter({correct: true}).count()
						error_rate = 1 - (correct_oi/(2*trial_reps))

						if (num_lefts ==  2*trial_reps || num_rights ==  2*trial_reps){
							return false;
						}
						else if (num_na ==  2*trial_reps){
							return false;
						}
						else if (error_rate >= error_rate_cap){
							return false;
						}
						else{
							return true
						}
					},
				on_finish: function(data){
					data.num_lefts = num_lefts
					data.num_rights = num_rights
					data.num_na = num_na
				}
			};
			timeline.push(no_sus);

			var sus_1 = {
				type: 'instructions',
				pages: function(data){
					num_lefts = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: 37, block: "block_p", exp_stage: "practice_choice"}).count()
					num_rights = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: 39, block: "block_p", exp_stage: "practice_choice"}).count()
					num_na = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: -1, block: "block_p", exp_stage: "practice_choice"}).count()

					if (num_lefts ==  2*trial_reps || num_rights ==  2*trial_reps){
						return [
							"<p align='left'> Hmm... You only ever selected one chest. It looks as if you may not fully understand the task. </p>" +
							"<p align='left'> If you are unable to better perform in the practice trial a second time, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
							"<p align='left'> Please click 'Next' to return to the instructions. </p>"
						]
					}
					else if (num_na ==  2*trial_reps){
						return [
							"<p align='left'> Hmm... You never pressed an arrow key to indicate which chest you would prefer. It looks as if you may not fully understand the task. </p>" +
							"<p align='left'> If you are unable to better perform in the practice trial a second time, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
							"<p align='left'> Please click 'Next' to return to the instructions. </p>"
						]
					}
					else if (error_rate >= error_rate_cap){
						return [
							"<p align='left'> Hmm... Your choices indicate that you may not fully understand the task. </p>" +
							"<p align='left'> If you are unable to better perform in the practice trial a second time, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
							"<p align='left'> Please click 'Next' to return to the instructions. </p>"
						]
					}
				},
				show_clickable_nav: true,
				on_finish: function(data){

					data.primary_key =  subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
					data.suspicious = true

					data.num_lefts = num_lefts
					data.num_rights = num_rights
					data.num_na = num_na
					num_corr = jsPsych.data.get().last(2*2*trial_reps+1).filter({block: "block_p", correct: true}).count()
					data.error_block = 1 - (num_corr/(trial_reps*2))

					data.block = "block_p"
					data.exp_part = "practice"
					data.exp_stage = "practice_suspicion_flag"
					if (num_lefts ==  2*trial_reps || num_rights ==  2*trial_reps){
						data.suspicious_type = 'all_one'
					}
					else if (num_na ==  2*trial_reps){
						data.suspicious_type = 'time_outs'
					}
					else {
						data.suspicious_type = 'error_rate'
					}

				}
			}

			var sus_2 = {
				type: 'instructions',
				pages: function(data){
					num_lefts = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: 37, block: "block_p", exp_stage: "practice_choice"}).count()
					num_rights = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: 39, block: "block_p", exp_stage: "practice_choice"}).count()
					num_na = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: -1, block: "block_p", exp_stage: "practice_choice"}).count()

					if (num_lefts ==  2*trial_reps || num_rights ==  2*trial_reps){
						return [
							"<p align='left'> Hmm... You only ever selected one chest. It looks as if you may not fully understand the task. </p>" +
							"<p align='left'> If you are unable to better perform in the practice trial a second time, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
							"<p align='left'> Please click 'Next' to return to the instructions. </p>"
						]
					}
					else if (num_na ==  2*trial_reps){
						return [
							"<p align='left'> Hmm... You never pressed an arrow key to indicate which chest you would prefer. It looks as if you may not fully understand the task. </p>" +
							"<p align='left'> If you are unable to better perform in the practice trial a second time, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
							"<p align='left'> Please click 'Next' to return to the instructions. </p>"
						]
					}
					else if (error_rate >= error_rate_cap){
						return [
							"<p align='left'> Hmm... Your choices indicate that you may not fully understand the task. </p>" +
							"<p align='left'> If you are unable to better perform in the practice trial a second time, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
							"<p align='left'> Please click 'Next' to return to the instructions. </p>"
						]
					}
				},
				show_clickable_nav: true,
				on_finish: function(data){
					data.primary_key =  subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
					data.suspicious = true

					data.num_lefts = num_lefts
					data.num_rights = num_rights
					data.num_na = num_na
					num_corr = jsPsych.data.get().last(2*2*trial_reps+1).filter({block: "block_p", correct: true}).count()
					data.error_block = 1 - (num_corr/(trial_reps*2))

					data.exp_part = "practice"
					data.exp_stage = "practice_suspicion_flag"
					if (num_lefts ==  2*trial_reps || num_rights ==  2*trial_reps){
						data.suspicious_type = 'all_one'
					}
					else if (num_na ==  2*trial_reps){
						data.suspicious_type = 'time_outs'
					}
					else {
						data.suspicious_type = 'error_rate'
					}

				}
			}

			var final_bad = {
				type: 'instructions',
				pages: function(data){
					num_lefts = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: 37, block: "block_p", exp_stage: "practice_choice"}).count()
					num_rights = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: 39, block: "block_p", exp_stage: "practice_choice"}).count()
					num_na = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: -1, block: "block_p", exp_stage: "practice_choice"}).count()

					return [
						"<p align='left'> We're sorry, it appears as if you still do not fully understand the task. </p>" +
						"<p align='left'> We reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
						"<p align='left'> Please click 'Next' to begin the main task. </p>"
					]

				},
				show_clickable_nav: true,
				on_finish: function(data){
					data.primary_key =  subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
					data.suspicious = true

					data.num_lefts = num_lefts
					data.num_rights = num_rights
					data.num_na = num_na
					num_corr = jsPsych.data.get().last(2*2*trial_reps+1).filter({block: "block_p", correct: true}).count()
					data.error_block = 1 - (num_corr/(trial_reps*2))
					data.exp_part = "practice"
					data.exp_stage = "practice_suspicion_flag"
					if (num_lefts ==  2*trial_reps || num_rights ==  2*trial_reps){
						data.suspicious_type = 'all_one'
					}
					else if (num_na ==  2*trial_reps){
						data.suspicious_type = 'time_outs'
					}
					else {
						data.suspicious_type = 'error_rate'
					}

				}
			}

			var sus_procedure3 = {
				timeline: [final_bad],
				data: {exp_part: 'practice'},
				conditional_function:   function() {
					num_lefts = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: 37, block: "block_p", exp_stage: "practice_choice"}).count()
					num_rights = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: 39, block: "block_p", exp_stage: "practice_choice"}).count()
					num_na = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: -1, block: "block_p", exp_stage: "practice_choice"}).count()

					correct_oi = jsPsych.data.get().last(2*2*trial_reps+1).filter({correct: true}).count()
					error_rate = 1 - (correct_oi/(2*trial_reps))

					if (num_lefts ==  2*trial_reps || num_rights ==  2*trial_reps){
						return true;
					}
					else if (num_na ==  2*trial_reps){
						return true;
					}
					else if (error_rate >= error_rate_cap){
						return true;
					}
					else{
						return false
					}
					},

			}

			var sus_procedure2 = {
					timeline: [sus_2, instructions, practice_procedure, no_sus, sus_procedure3],
					data: {exp_part: 'practice'},
					conditional_function:   function() {
						num_lefts = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: 37, block: "block_p", exp_stage: "practice_choice"}).count()
						num_rights = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: 39, block: "block_p", exp_stage: "practice_choice"}).count()
						num_na = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: -1, block: "block_p", exp_stage: "practice_choice"}).count()

						correct_oi = jsPsych.data.get().last(2*2*trial_reps+1).filter({correct: true}).count()
						error_rate = 1 - (correct_oi/(2*trial_reps))

						if (num_lefts ==  2*trial_reps || num_rights ==  2*trial_reps){
							return true;
						}
						else if (num_na ==  2*trial_reps){
							return true;
						}
						else if (error_rate >= error_rate_cap){
							return true;
						}
						else{
							return false
						}
						},
				};


			var sus_procedure = {
					timeline: [sus_1, instructions, practice_procedure, no_sus, sus_procedure2],
					data: {exp_part: 'practice'},
					conditional_function:   function() {
						num_lefts = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: 37, block: "block_p", exp_stage: "practice_choice"}).count()
						num_rights = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: 39, block: "block_p", exp_stage: "practice_choice"}).count()
						num_na = jsPsych.data.get().last(2*2*trial_reps+1).filter({key_press: -1, block: "block_p", exp_stage: "practice_choice"}).count()

						correct_oi = jsPsych.data.get().last(2*2*trial_reps+1).filter({correct: true}).count()
						error_rate = 1 - (correct_oi/(2*trial_reps))

						if (num_lefts ==  2*trial_reps || num_rights ==  2*trial_reps){
							return true;
						}
						else if (num_na ==  2*trial_reps){
							return true;
						}
						else if (error_rate >= error_rate_cap){
							return true;
						}
						else{
							return false
						}
						},
				};

			timeline.push(sus_procedure);



// main experiment

			var block1_procedure = {
			  timeline: [make_stim('block_1', 'main_choice', 'main')],
			  repetitions: reps_in_block,
			  randomize_order: true,
				timeline_variables: controls,
			}

			var block2_procedure = {
			  timeline: [make_stim('block_2', 'main_choice', 'main')],
			  repetitions: reps_in_block,
			  randomize_order: true,
				timeline_variables: controls,
			}

			timeline.push(block1_procedure, make_break(50), block2_procedure)

// end of task - bonus feedback

			var bonus_block = {
				type: 'instructions',
				pages: function() {
					var curr_bonus = jsPsych.data.get().last(1).values()[0].curr_bonus;
					var rounded_bonus = Math.round(curr_bonus)

					return ['<p>This marks the end of the experiment.</p>' +
					'<p>You earned <b>' + rounded_bonus + ' bonus points </b>!</p>' +
					'<p>Thank you so much for your participation.</p>' +
					'<p>Press <q>Next</q> to continue to the feedback survey.</p>'];
				},
				show_clickable_nav: true,
				on_finish: function(data) {

					var curr_block = jsPsych.data.get().last(2).values()[0].block;
					data.num_lefts = jsPsych.data.get().filter({key_press: 37, block: curr_block}).count()
					data.num_rights = jsPsych.data.get().filter({key_press: 39, block: curr_block}).count()
					data.num_na = jsPsych.data.get().filter({key_press: -1, block: curr_block}).count()

					ttl_correct = jsPsych.data.get().filter({correct: true, block: curr_block}).count()
					error_rate = 1 - (ttl_correct/(reps_in_block*2))
					data.error_block = error_rate

					if (data.num_lefts == reps_in_block*2 || data.num_rights == reps_in_block*2){
						data.suspicious_type = 'all_one'
						data.suspicious = true
					}
					else if (error_rate >= error_rate_cap){
						data.suspicious_type = 'error_rate'
						data.suspicious = true
					}
					else if (data.num_na == reps_in_block*2){
						data.suspicious_type = 'time_outs'
						data.suspicious = true
					}
					else {
						data.suspicious = 'false'
					}
					data.block = curr_block // defines as this block after the filtering to determine num gos
					data.exp_part = 'main'

					jsPsych.data.addDataToLastTrial({
						exp_stage:"end_bonus",
						primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
					})
				}
			}

			timeline.push(bonus_block);


// post-task feedback block

// suspicious

var fb_warning_ss = {
    type: 'instructions',
    pages: [
      "<p align='left'> This task has several built in alarms that signal when a worker may be trying to 'trick' at a task" +
      "<p align='left'> (i.e. by selecting the same answer every time, or never answering at all). " +
      "<p align='left'>  Something about your responses for part or all of this task has triggered one of these alarms." ,

      "<p align='left'>  Your bonus will be witheld until an experimenter can manually review your answers to check if there was a mistake on our end, or if you did try to 'trick' the task." +
      "<p align='left'>  In the following feedback survey, you will have the chance to explain anything that may have made your answers appear irregular. " +
      "<p align='left'>  In the event that an honest mistake was made or our code was incorrect, you will receive your bonus as planned" +
      "<p align='left'>  However, if it appears that you tried to 'trick' the system, we reserve the right to withold your bonus, and if cheating behavior continues you will be asked to leave the study."
        ],
     show_clickable_nav: true,
     on_finish: function(data) {
      jsPsych.data.addDataToLastTrial({
        fb_type: "suspicious",
        exp_stage:"feedback_warning",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
				exp_part: "feedback"
      })
    }
  };

// first question - tech problems
			var fb_q1_ss = {
					type: 'survey-multi-choice',
					preamble: '<h4> Feedback Survey 1/4 </h4>', // +
					questions: [
						{prompt: "Did you experience any technological issues during this task?   (i.e. experiment glitch, accidentally closed window, mixed up keys, etc.) <br>  If you answer 'Yes' or 'I am unsure' you will have the opportunity to explain",
							options: [" Yes", " No", " I am unsure"],
							// horizontal: true,
							required: true,
							name: 'tech problems'},
							],
							on_finish: function(data){
								var dat1 = jsPsych.data.getLastTrialData().values()[0];
								var answer1 = JSON.parse(dat1.responses).Q0;
								if(answer1.includes('Yes') == true || answer1.includes('unsure')) {
									jsPsych.data.addDataToLastTrial({
										fb_type: "suspicious",
										fb_issue:'tech',
										exp_stage:"feedback_tech",
										primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
										exp_part: "feedback"
									})
								} else {
									jsPsych.data.addDataToLastTrial({
										fb_type: "suspicious",
										exp_stage:"feedback_tech",
										primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
										exp_part: "feedback"
									})
								}
							}
					};

		// first question - tech problems - if yes, please explain
			var fb_q1_follow_ss = {
					type: 'survey-text',
					preamble: '<h4> Feedback Survey 1/4 </h4>', // +
					questions: [
						{prompt: "Please tell us about the technical difficulties you experienced: ",
							required: true,
							name: 'tech problems follow up'},
							],
							on_finish: function(data){
								var dat1 = jsPsych.data.getLastTrialData().values()[0];
								var answer1 = JSON.parse(dat1.responses).Q0;
								jsPsych.data.addDataToLastTrial({
									fb_type: "suspicious",
									fb_issue: 'tech',
									fb_issue_txt: answer1,
									exp_stage:"feedback_tech_followup",
									primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
									exp_part: "feedback"
								})
							}
					};

		// determines if subject answered yes, and explanation is required
			var fb_q1_eval_ss = {
					timeline: [fb_q1_follow_ss],
					conditional_function:   function() {
							var dat1 = jsPsych.data.getLastTrialData().values()[0];
							var answer1 = JSON.parse(dat1.responses).Q0;
							if(answer1.includes('Yes') == true || answer1.includes('unsure')) {
									return true;
							} else {
									return false;
							}
						},
				};


// second question - distractions
			var fb_q2_ss = {
					type: 'survey-multi-choice',
					preamble: '<h4> Feedback Survey 2/4 </h4>', // +
					questions: [{
							prompt: "Did you experience any major distractions or interruptions during this task? <br> If you answer 'Yes' you will have the opportunity to explain",
							options: [" Yes", " No"],
							required: true,
							name: 'distractions'
						},
					],
					on_finish: function(data){
						var dat2 = jsPsych.data.getLastTrialData().values()[0];
						var answer2 = JSON.parse(dat2.responses).Q0;
						if(answer2.includes('Yes') == true) {
							jsPsych.data.addDataToLastTrial({
								fb_type: "suspicious",
								fb_issue:'distraction',
								exp_stage:"feedback_distraction",
								primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
								exp_part: "feedback"
							})
						} else {
							jsPsych.data.addDataToLastTrial({
								fb_type: "suspicious",
								exp_stage:"feedback_distraction",
								primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
								exp_part: "feedback"
							})
						}
					}
				};

		// second question - distractions - if yes, please explain
			var fb_q2_follow_ss = {
					type: 'survey-text',
					preamble: '<h4> Feedback Survey 2/4 </h4>', // +
					questions: [
						{prompt: "Please describe how the distraction may have effected your performance, and if possible, at what point in the task this distraction occured:",
							name: 'tech problems follow up'},
							],
							on_finish: function(data){
								var dat2 = jsPsych.data.getLastTrialData().values()[0];
								var answer2 = JSON.parse(dat2.responses).Q0;
								jsPsych.data.addDataToLastTrial({
									fb_type: "suspicious",
									fb_issue: 'distraction',
									fb_issue_txt: answer2,
									exp_stage:"feedback_distraction_followup",
									primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
									exp_part: "feedback"
								})
							}
					};

		// determines if subject answered yes, and explanation is required
			var fb_q2_eval_ss = {
					timeline: [fb_q2_follow_ss],
					conditional_function:   function() {
							var dat2 = jsPsych.data.getLastTrialData().values()[0];
							var answer2 = JSON.parse(dat2.responses).Q0;
							if(answer2.includes('Yes') == true) {
									return true;
							} else {
									return false;
							}
						},
				};


// third question: engagement
			var fb_q3_ss = {
					type: 'survey-multi-choice',
					preamble: '<h4> Feedback Survey 3/4 </h4>', // +
					questions: [{
							prompt: "On the following scale from 1 to 4, how engaging (attention holding) did you find this task?",
							options: [" 1 - Not at all engaging", " 2 - Somewhat not engaging", " 3 - Somewhat engaging", " 4 - Very engaging"],
							required: true,
							name: 'engagement'
						},
					],
							on_finish: function(data){
								var dat3 = jsPsych.data.getLastTrialData().values()[0];
								var answer3 = JSON.parse(dat3.responses).Q0;
								jsPsych.data.addDataToLastTrial({
									fb_type: "suspicious",
									fb_engagement: answer3,
									exp_stage:"feedback_engaged",
									primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
									exp_part: "feedback"
								})
							}
					};

// fourth question: anything else
			var fb_q4_ss = {
					type: 'survey-text',
					preamble: '<h4> Feedback Survey 4/4 </h4>' ,
					questions: [{
							prompt: "Is there anything else you would like us to know? <br> (Can be a specific concern or general suggestion for improvement)",
							name: 'anything else'
						},
					],
							on_finish: function(data){

								var interaction_data = jsPsych.data.getInteractionData();
								data.screen = interaction_data.json();

								var dat4 = jsPsych.data.getLastTrialData().values()[0];
								var answer4 = JSON.parse(dat4.responses).Q0;
								if (answer4 == ''){
									jsPsych.data.addDataToLastTrial({
									fb_type: "suspicious",
									exp_stage:"feedback_other",
									fb_type: "suspicious",
									primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
									exp_part: "feedback"
								})
							} else {
								jsPsych.data.addDataToLastTrial({
									fb_type: "suspicious",
									fb_issue: 'other',
									fb_issue_txt: answer4,
									exp_stage:"feedback_other",
									primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
									exp_part: "feedback"
									})
								}
							}
					};

// conclusion
			var fb_end_exp_ss = {
				type: 'html-keyboard-response',
				stimulus: '<p>Thank you! This marks the end of the feeback survey.</p>' +
				'<p>Press any key to return to the dashboard where you may take a pause before the next game.</p>',
				on_finish: function(data) {

					var interaction_data = jsPsych.data.getInteractionData();
					data.screen = interaction_data.json();

					jsPsych.data.addDataToLastTrial({
						fb_type: "suspicious",
						exp_stage:"exp_end",
						primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
						exp_part: "feedback"
					})
				}
			};


// not suspicious

var fb_warning_ns = {
		type: 'instructions',
		pages: [
			"<p align='left'> This task has several built in alarms that signal when a worker may be trying to 'trick' at a task" +
			"<p align='left'> (i.e. by selecting the same answer every time, or never answering at all). " +
			"<p align='left'> Your responses will be manually reviewed by a researcher, however it appears you have performed the task with sincere effort. Thank you!" ,

			"<p align='left'>  In the following feedback survey, you will have the chance to explain anything that may have made your answers appear irregular. " +
			"<p align='left'>  In the event that an honest mistake was made or our code was incorrect, you will receive your bonus as planned" +
			"<p align='left'>  However, if in review it appears that you tried to 'trick' the system, we reserve the right to withold your bonus, and if cheating behavior continues you will be asked to leave the study."
				],
		 show_clickable_nav: true,
		 on_finish: function(data) {
			jsPsych.data.addDataToLastTrial({
				fb_type: "nonsuspicious",
				exp_stage:"feedback_warning",
				primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
				exp_part: "feedback"
			})
		}
	};

// first question - tech problems
		var fb_q1_ns = {
				type: 'survey-multi-choice',
				preamble: '<h4> Feedback Survey 1/4 </h4>' +
									"<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
				questions: [
					{prompt: "Did you experience any technological issues during this task?   (i.e. experiment glitch, accidentally closed window, mixed up keys, etc.) <br>  If you answer 'Yes' or 'I am unsure' you will have the opportunity to explain",
						options: [" Yes", " No", " I am unsure"],
						// horizontal: true,
						required: true,
						name: 'tech problems'},
						],
						on_finish: function(data){
							var dat1 = jsPsych.data.getLastTrialData().values()[0];
							var answer1 = JSON.parse(dat1.responses).Q0;
							if(answer1.includes('Yes') == true || answer1.includes('unsure')) {
								jsPsych.data.addDataToLastTrial({
									fb_type: "nonsuspicious",
									fb_issue:'tech',
									exp_stage:"feedback_tech",
									primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
									exp_part: "feedback"
								})
							} else {
								jsPsych.data.addDataToLastTrial({
									fb_type: "nonsuspicious",
									exp_stage:"feedback_tech",
									primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
									exp_part: "feedback"
								})
							}
						}
				};

		// first question - tech problems - if yes, please explain
		var fb_q1_follow_ns = {
				type: 'survey-text',
				preamble: '<h4> Feedback Survey 1/4 </h4>' +
									"<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
				questions: [
					{prompt: "Please tell us about the technical difficulties you experienced: ",
						required: true,
						name: 'tech problems follow up'},
						],
						on_finish: function(data){
							var dat1 = jsPsych.data.getLastTrialData().values()[0];
							var answer1 = JSON.parse(dat1.responses).Q0;
							jsPsych.data.addDataToLastTrial({
								fb_type: "nonsuspicious",
								fb_issue: 'tech',
								fb_issue_txt: answer1,
								exp_stage:"feedback_tech_followup",
								primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
								exp_part: "feedback"
							})
						}
				};

		// determines if subject answered yes, and explanation is required
		var fb_q1_eval_ns = {
				timeline: [fb_q1_follow_ns],
				conditional_function:   function() {
						var dat1 = jsPsych.data.getLastTrialData().values()[0];
						var answer1 = JSON.parse(dat1.responses).Q0;
						if(answer1.includes('Yes') == true || answer1.includes('unsure')) {
								return true;
						} else {
								return false;
						}
					},
			};


// second question - distractions
		var fb_q2_ns = {
				type: 'survey-multi-choice',
				preamble: '<h4> Feedback Survey 2/4 </h4>' +
									"<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
				questions: [{
						prompt: "Did you experience any major distractions or interruptions during this task? <br> If you answer 'Yes' you will have the opportunity to explain",
						options: [" Yes", " No"],
						required: true,
						name: 'distractions'
					},
				],
				on_finish: function(data){
					var dat2 = jsPsych.data.getLastTrialData().values()[0];
					var answer2 = JSON.parse(dat2.responses).Q0;
					if(answer2.includes('Yes') == true) {
						jsPsych.data.addDataToLastTrial({
							fb_type: "nonsuspicious",
							fb_issue:'distraction',
							exp_stage:"feedback_distraction",
							primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
							exp_part: "feedback"
						})
					} else {
						jsPsych.data.addDataToLastTrial({
							fb_type: "nonsuspicious",
							exp_stage:"feedback_distraction",
							primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
							exp_part: "feedback"
						})
					}
				}
			};

		// second question - distractions - if yes, please explain
		var fb_q2_follow_ns = {
				type: 'survey-text',
				preamble: '<h4> Feedback Survey 2/4 </h4>' +
									"<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
				questions: [
					{prompt: "Please describe how the distraction may have effected your performance, and if possible, at what point in the task this distraction occured:",
						name: 'tech problems follow up'},
						],
						on_finish: function(data){
							var dat2 = jsPsych.data.getLastTrialData().values()[0];
							var answer2 = JSON.parse(dat2.responses).Q0;
							jsPsych.data.addDataToLastTrial({
								fb_type: "nonsuspicious",
								fb_issue: 'distraction',
								fb_issue_txt: answer2,
								exp_stage:"feedback_distraction_followup",
								primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
								exp_part: "feedback"
							})
						}
				};

		// determines if subject answered yes, and explanation is required
		var fb_q2_eval_ns = {
				timeline: [fb_q2_follow_ns],
				conditional_function:   function() {
						var dat2 = jsPsych.data.getLastTrialData().values()[0];
						var answer2 = JSON.parse(dat2.responses).Q0;
						if(answer2.includes('Yes') == true) {
								return true;
						} else {
								return false;
						}
					},
			};


// third question: engagement
		var fb_q3_ns = {
				type: 'survey-multi-choice',
				preamble: '<h4> Feedback Survey 3/4 </h4>' +
									"<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
				questions: [{
						prompt: "On the following scale from 1 to 4, how engaging (attention holding) did you find this task?",
						options: [" 1 - Not at all engaging", " 2 - Somewhat not engaging", " 3 - Somewhat engaging", " 4 - Very engaging"],
						required: true,
						name: 'engagement'
					},
				],
						on_finish: function(data){
							var dat3 = jsPsych.data.getLastTrialData().values()[0];
							var answer3 = JSON.parse(dat3.responses).Q0;
							jsPsych.data.addDataToLastTrial({
								fb_type: "nonsuspicious",
								fb_engagement: answer3,
								exp_stage:"feedback_engaged",
								primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
								exp_part: "feedback"
							})
						}
				};

// fourth question: anything else
		var fb_q4_ns = {
				type: 'survey-text',
				preamble: '<h4> Feedback Survey 4/4 </h4>' +
									"<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
				questions: [{
						prompt: "Is there anything else you would like us to know? <br> (Can be a specific concern or general suggestion for improvement)",
						name: 'anything else'
					},
				],
						on_finish: function(data){

							var interaction_data = jsPsych.data.getInteractionData();
							data.screen = interaction_data.json();

							var dat4 = jsPsych.data.getLastTrialData().values()[0];
							var answer4 = JSON.parse(dat4.responses).Q0;
							if (answer4 == ''){
								jsPsych.data.addDataToLastTrial({
								fb_type: "nonsuspicious",
								exp_stage:"feedback_other",
								primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
								exp_part: "feedback"
							})
						} else {
							jsPsych.data.addDataToLastTrial({
								fb_type: "nonsuspicious",
								fb_issue: 'other',
								fb_issue_txt: answer4,
								exp_stage:"feedback_other",
								primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
								exp_part: "feedback"
								})
							}
						}
				};

// conclusion
		var fb_end_exp_ns = {
			type: 'html-keyboard-response',
			stimulus: '<p>Thank you! This marks the end of the feeback survey.</p>' +
			'<p>Press any key to return to the dashboard where you may take a pause before the next game.</p>',
			on_finish: function(data) {

				var interaction_data = jsPsych.data.getInteractionData();
				data.screen = interaction_data.json();

				jsPsych.data.addDataToLastTrial({
					exp_stage:"exp_end",
					primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
					exp_part: "feedback"
				})
			}
		};


// evaluate whether any of the responses were suspicious and provide appropriate quiz
//

		var eval_ss_timeline = {
			timeline: [fb_warning_ss, fb_q1_ss, fb_q1_eval_ss, fb_q2_ss, fb_q2_eval_ss, fb_q3_ss, fb_q4_ss, fb_end_exp_ss],
			// timeline: [fb_warning_ss, fb_q1_ss, fb_q1_eval_ss, fb_q2_ss, fb_q2_eval_ss, fb_q3_ss, fb_q4_ss],
			conditional_function: function(data) {
				sus_dat = jsPsych.data.get().filter({exp_part: 'main', suspicious: true}).count()
				if (sus_dat >= 1) {
					return true;
				} else {
					return false;
				}
			},
		};
		timeline.push(eval_ss_timeline);

		var eval_ns_timeline = {
			timeline: [fb_warning_ns, fb_q1_ns, fb_q1_eval_ns, fb_q2_ns, fb_q2_eval_ns, fb_q3_ns, fb_q4_ns, fb_end_exp_ns],
			// timeline: [fb_warning_ns, fb_q1_ns, fb_q1_eval_ns, fb_q2_ns, fb_q2_eval_ns, fb_q3_ns, fb_q4_ns],
			conditional_function: function(data) {
				sus_dat = jsPsych.data.get().filter({exp_part: 'main', suspicious: true}).count()
        if (sus_dat == 0) {
					return true;
				} else {
					return false;
				}
			},
		};
		timeline.push(eval_ns_timeline);


// Save data to CSV
						function saveData_csv(name, data){
							var xhr = new XMLHttpRequest();
							xhr.open('POST', 'save_data.php');
							xhr.setRequestHeader('Content-Type', 'application/json');
							xhr.send(JSON.stringify({filename: name, filedata: data}));
						}

						/* grab data before the end of the experiment */

						var save_data = {
							type: 'call-function',
							func: function(){ saveData_csv(subjectId + '_' + weekId + '_' + expId, jsPsych.data.get().csv());
							},
							timing_post_trial: 0,
							on_finish: function(data) {
								jsPsych.data.addDataToLastTrial({
									exp_stage:"save_CSV",
									primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
									exp_part: "save"
								})
							}
						};
						timeline.push(save_data);
						console.log('csv save successful')

// "dashboard"

						var dash_to_task = {
							type: "html-button-response",
							stimulus:
								'<div id="blue"> ' +
								'<div id="title">' +
								"<h1>DASHBOARD</h1>" +
								"<h3>If you need to take a brief rest between tasks please do so now.</h3>" +
								"<h2>Click the button below to proceed to the next task.</h2>" +
								"<h4>Note: you will not be paid for the time you spend on this page.</h4>" +
								"</div> " +
								"</div>",
							button_html: '<button style="height:75px;width:400px;background-color:powderblue">%choice%</button>',
							choices: ["<h1>" + nextTask_name + "</h1>"],
							on_finish: function(data) {

								var interaction_data = jsPsych.data.getInteractionData();
								data.screen = interaction_data.json();

								jsPsych.data.addDataToLastTrial({
									exp_stage:"dashboard",
									primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
									task_selected: nextTask_Id,
									exp_part: "dash"
								})
							}
						}
						timeline.push(dash_to_task)

// // database save

						function saveData() {
							var xhr = new XMLHttpRequest();
							xhr.open('POST', 'write_data_nc.php'); // change 'write_data.php' to point to php script.
							xhr.setRequestHeader('Content-Type', 'application/json');
							xhr.onload = function() {
								console.log('xhr response text coming up')
								console.log(xhr.responseText);
								if(xhr.status == 200){
									var response = JSON.parse(xhr.responseText);
									console.log(xhr.responseText);
									console.log(response.success);
								}
							};
							xhr.send(jsPsych.data.get().json());
							console.log('function finished well')
						};

						var db_save = {
						type: 'call-function',
						func: saveData,
						on_finish: function(data) {
							// jsPsych.data.get().localSave('csv','nc_0.csv');
							jsPsych.data.addDataToLastTrial({
								exp_stage:"save_database",
								primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
								exp_part: "save"
								})
							}
						};
						timeline.push(db_save)

						// data saving + compensation code
							var save_wait_1 = {
								type: 'html-keyboard-response',
								stimulus: "<p> You're doing great!</p>" +
								'<p> Please wait about 30 seconds while we save your data and load the next game.</p>' +
								'<p> You will be automatically redirected to the next page momentarily.</p>',
								choices: [jsPsych.NO_KEYS],
								trial_duration: 30000,
								response_ends_trial: false,
								on_finish: function(data) {
									jsPsych.data.addDataToLastTrial({
										exp_stage:"data_saving",
										primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
										exp_part: "save"
									})
								}
							};
							timeline.push(save_wait_1)


							// var save_wait_2 = {
							// 	type: 'html-button-response',
							// 	stimulus: '<p> Your data has been saved!</p>' +
							// 	'<p> You may click the button below to proceed to your compensation code. </p>',
							// 	choices: ['Ready'],
							// 	response_ends_trial: true,
							// 	on_finish: function(data) {
							// 		jsPsych.data.addDataToLastTrial({
							// 			exp_stage:"data_saved",
							// 			primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
							// 		})
							// 	}
							// };

							// var comp_code = {
							// 	type: 'html-keyboard-response',
							// 	stimulus: '<p> Your compensation code is</p>' + comp_code + '<p> Press any key to finish the experiment </p>',
							// 	response_ends_trial: true,
							// 	on_finish: function(data) {
							// 		jsPsych.data.addDataToLastTrial({
							// 			exp_stage:"comp_code",
							// 			primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
							// 		})
							// 	}
							// };
							//
							// timeline.push(save_wait_1)

// init experiment


				jsPsych.init({
					timeline: timeline,
					// on_finish: function() {
					// 	jsPsych.data.get().localSave('csv','nc_0.csv');
					// 	jsPsych.data.displayData();
					// }
					on_finish: function() {window.location.href = "lt.html" + '?workerId=' + subjectId + '&hitId=' + hitId + '&assignmentId=' + assignmentId}
				});
		</script>

</html>
