<!DOCTYPE html>
<html>
    <head>
        <title>Lottery Ticket Game</title>
        <script src="jspsych-6.0.5/jspsych.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-fullscreen.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-instructions.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-survey-multi-choice.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-html-button-response.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-survey-text.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-external-html.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-call-function.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>
        <link rel="stylesheet" href="jspsych-6.0.5/css/jspsych.css"></link>
        <link rel='stylesheet' type='text/css' href='jspsych-6.0.5/css/jspsych.css'>
        <link rel="stylesheet" href="jspsych-6.0.5/css/style.css"></link>
        <link rel="stylesheet" href="jspsych-6.0.5/css/jspsych.css"></link>

    </head>
    <body></body>
    <script>

//quick change variables

          comp_code = "AJFHBG897"
          read_time = 1500 // num of milliseconds that subject must wait before they can submit an answer

          // // 3 blocks: small, med, high $

          // var mean_block_1_lo_wide_ = 0.10
          var block_1_min = 0.01
          var block_1_max = 0.20
          var block_1_step = 0.01

          // var mean_block_2_lo_wide_ = 2.5
          var block_2_min = 1
          var block_2_max = 5
          var block_2_step = 0.25

          // var mean_block_3_lo_wide_ = 10
          var block_3_min = 5
          var block_3_max = 15
          var block_3_step = 0.50

          var percents = [[10, 90], [20, 80], [30, 70], [40, 60], [50, 50], [60, 40], [70, 30], [80, 20], [90, 10], [100, 0]]
          var bonus_zero = 0
          var bonus_fraction = 6/percents.length // 6 per block = 21 possible total


// start timeline
          timeline = []

// // add identifying information for primary key

          // weeks of participation, 0=pilot
          var weekId = "1"; // change weekly
          jsPsych.data.addProperties({
            weekId: weekId
          });

          // experiment Id
          // lottery ticket task  (formerly "gambling") = lt
          var expId = "lt_" + jsPsych.randomization.randomID(8);
          var eId = "lt";
          jsPsych.data.addProperties({
            expId: eId
          });

          // url
          var fullurl = window.location.href;
          jsPsych.data.addProperties({
            url: fullurl
          });

          // subject Id from url
          var subjectId = jsPsych.data.getURLVariable('workerId');
          jsPsych.data.addProperties({
            subjectId: subjectId
          });

          // assignment Id from url
          var assignmentId = jsPsych.data.getURLVariable('assignmentId');
          jsPsych.data.addProperties({
            assignmentId: assignmentId
          });

          // hit Id from url
          var hitId = jsPsych.data.getURLVariable('hitId');
          jsPsych.data.addProperties({
            hitId: hitId
          });

// // fullscreen mode

          var fullscreen_intro = {
              type: 'instructions',
              pages: [
                "<p>On the next screen you will be asked to put your browser in full screen mode.</p>" +
                "<p>After entering full screen mode it is very important that you do not exit, switch tabs, minimize, or adjust the browser for the remainder of the game.</p>" +
                "<p>Doing so changes the display of the game and the game does not pause once started.</p>" +
                "<p>We can detect if you exit fullscreen, minimize the window, or switch to another tab, and we reserve the right to withold bonus/payment if this is indicated.</p>",
                ],
             show_clickable_nav: true,
             on_finish: function(data) {
              jsPsych.data.addDataToLastTrial({
                exp_stage:"fullscreen",
                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                exp_part: "fullscreen"
              })
            }
          };
          timeline.push(fullscreen_intro)

          var fullscreen = {
            type: 'fullscreen',
            fullscreen_mode: true,
            on_finish: function(data) {
              jsPsych.data.addDataToLastTrial({
                exp_stage:"fullscreen",
                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                exp_part: "fullscreen"
              })
            }
          }
          timeline.push(fullscreen)


// // instructions block
        var instructions = {
            type: 'instructions',
            pages: [
              '<p>Welcome to the <b>Lottery Task</b>!</p> <p>This task will take approximately 5 minutes to complete. </p> <p> Click the <q>Next</q> button to continue.</p>',
                "<p align='left'> For this task, you will be presented with a series of lottery tickets. </p>"+
                "<p align='left'> <b>Tickets have different pay out amounts (monetary) and different percent chances of winning that pay out. </b></p> " +
                "<p align='left'> You will be shown two lottery tickets at a time. It is your job is to indicate which of the options you would prefer.</p>",
                "<p align='left'> You choose between the two lottery tickets by pressing keys on your keyboard.</p>" +
                "<p align='left'> Press <b>left arrow key</b> on your keyboard if you would prefer the ticket on the left. </p>" +
                "<p align='left'> Press <b>right arrow key</b> on your keyboard if you would prefer the ticket on the right.</p>" +
                "<p align='left'> You will play a total of 10 rounds.</p>",
                "<p align='left'> You should indicate your true preference because you will receive a <b>bonus payment</b> proportional to your choices.</p>" +
                "<p align='left'> (Each <q>dollar</q> amount corresponds to the points which determine your session bonus across tasks)</p>" +
                "<p align='left'> Please note that if you respond randomly, we reserve the right to withold your bonus. </p>",
                "<p align='left'> Next, you will answer some questions about this task.</p>" +
                "<p align='left'> There is no practice trial for this task </p> " +
                "<p align='left'> Press the <q>Next</q> button to answer the instruction comprehension questions.</p>"
               ],
            show_clickable_nav: true,
            on_finish: function(data) {
              jsPsych.data.addDataToLastTrial({
                exp_stage:"instructions",
                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                exp_part: "instructions"
              })
            }
        };
        timeline.push(instructions)


// instruction comprehension questions

        // instruction questions
        var instruction_questions = {
            type:'survey-multi-choice',
            questions: [
              {prompt: "What are you choosing between in this task?",
                options: ["Tickets that have different point values",
                        "Tickets that have different monetary values",
                        "Tickets that have different numbers of coins",
                        "Tickets that have different numbers of objects"]},
              {prompt: "How do you indicate what your choice is?",
                options: ["I click my preferred choice on the screen",
                        "I press the '1' or '2' keys on my keyboard to indicate my choice of the first or second option",
                        "I press the left or right arrow keys on my keyboard to indicate my choice of the left or right option",
                        "I press the 'Q' or 'P' keys on my keyboard to indicate my choice of the left or right option, respectively" ]}
              ],
            required: true,
            on_finish: function(data) {
              jsPsych.data.addDataToLastTrial({
                exp_stage:"instruction_questions",
                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                exp_part: "instructions"
              })
            }
        };
        timeline.push(instruction_questions);

        // what they see if they answered one or both questions incorrectly the first time
        var redo_instructions = {
            type: 'instructions',
            pages: [
              "<p> Hmm...Based on one or more of your answers to the previous questions, it looks as if you may not fully understand the task. </p>" +
              "<p> If you are unable to answer the questions correctly again, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
              "<p> Please click 'Next' to return to the instructions. </p>"
            ],
            show_clickable_nav: true,
            on_finish: function(data) {
              jsPsych.data.addDataToLastTrial({
                exp_stage:"instruction_fail_first",
                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                exp_part: "instructions"
              })
            },
        };

        // what they see if they answered one or both of the questions incorrectly more than once
        var failed_instructions = {
            type: 'instructions',
            pages: [
              "<p> We're sorry, it appears as if you have failed to answer one or both of the instruction comprehension questions twice. </p>" +
              "<p> You may not receive a bonus payment for this task </p>" +
              "<p> <b> If you fail to answer the instruction comprehension questions a third time you may be asked to leave the study. </b></p>"
            ],
            show_clickable_nav: true,
            on_finish: function(data) {
              jsPsych.data.addDataToLastTrial({
                exp_stage:"instruction_fail_again",
                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                exp_part: "instructions"
              })
            },
        };


        // evaluates question responses and loops timeline if questions are incorrect (part 3)
        // Note: you need all three parts (next two follow) for this function to work
        var instructions_understood3 = {
            timeline: [failed_instructions, instructions, instruction_questions],
            conditional_function:   function() {
                var dat = jsPsych.data.getLastTrialData().values()[0];
                var dat1 = jsPsych.data.getLastTrialData().values()[1];
                var answer1 = JSON.parse(dat.responses).Q0;
                var answer2 = JSON.parse(dat.responses).Q1;
                if(answer1.includes('monetary') == true && answer2.includes('arrow') == true) {
                    return false;
                } else {
                    return true;
                }
              },
          };
        // evaluates question responses and loops timeline if questions are incorrect (part 2)
        var instructions_understood2 = {
            timeline: [failed_instructions, instructions, instruction_questions, instructions_understood3],
            conditional_function:   function() {
                var dat = jsPsych.data.getLastTrialData().values()[0];
                var dat1 = jsPsych.data.getLastTrialData().values()[1];
                var answer1 = JSON.parse(dat.responses).Q0;
                var answer2 = JSON.parse(dat.responses).Q1;
                if(answer1.includes('monetary') == true && answer2.includes('arrow') == true) {
                    return false;
                } else {
                    return true;
                }
              },
          };
        // evaluates question responses and loops timeline if questions are incorrect (part 1)
        var instructions_understood = {
            timeline: [redo_instructions, instructions, instruction_questions, instructions_understood2],
            conditional_function:   function() {
                var dat = jsPsych.data.getLastTrialData().values()[0];
                var dat1 = jsPsych.data.getLastTrialData().values()[1];
                var answer1 = JSON.parse(dat.responses).Q0;
                var answer2 = JSON.parse(dat.responses).Q1;
                if(answer1.includes('monetary') == true && answer2.includes('arrow') == true) {
                    return false;
                } else {
                    return true;
                }
              },
          };
        timeline.push(instructions_understood);

// helper functions

        // box mueller function adapted from: https://stackoverflow.com/questions/25582882/javascript-math-random-normal-distribution-gaussian-bell-curve
        function randn_bm(min, max, skew) {
            var u = 0, v = 0;
            while(u === 0) u = Math.random(); //Converting [0,1) to (0,1)
            while(v === 0) v = Math.random();
            let num = Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );

            num = num / 10.0 + 0.5; // Translate to 0 -> 1
            if (num > 1 || num < 0) num = randn_bm(min, max, skew); // resample between 0 and 1 if out of range
            num = Math.pow(num, skew); // Skew
            num *= max - min; // Stretch to fill range
            num += min; // offset to min
            return num;
        }

        function near_step(num, step_size) { // nearest step function
            num2 = (Math.round(num/step_size))*step_size;
            return num2.toFixed(2);
        }

        // generates stimulus based on input

        function gen_block_n_lo_wide(block_min, block_max, block_step) {
          num_trials = percents.length;
          bnlw_num_gen = [];
          block_n_lo_wide = [];
          block_n_hi_wide = [];
          block_n_lo_narr = [];
          block_n_hi_narr = [];
          for (i = 0; i < num_trials; i++) { //generates the numbers for the low wide condition
            bnlw_num_gen[i] = randn_bm(block_min,block_max,1);
          }
          for (i = 0; i < num_trials; i++) { //rounds them to the nearest step
            block_n_lo_wide[i] = near_step(bnlw_num_gen[i], block_step)
          }
          return block_n_lo_wide
        }

        function gen_block_n_hi_wide(bnlw, block_step) {
          block_n_hi_wide = []
          for (i = 0; i < num_trials; i++) { //calculates the high wide condition & rounds
            block_n_hi_wide[i] = near_step((bnlw[i]/0.026), block_step)
          }
          return block_n_hi_wide
        }

        function gen_block_n_lo_narr(bnlw, block_step) {
          block_n_hi_wide = []
          for (i = 0; i < num_trials; i++) { //calculates the high wide condition & rounds
            block_n_hi_wide[i] = near_step((bnlw[i]/0.0625), block_step)
          }
          return block_n_hi_wide
        }

        function gen_block_n_hi_narr(bnlw, block_step) {
          block_n_hi_wide = []
          for (i = 0; i < num_trials; i++) { //calculates the high wide condition & rounds
            block_n_hi_wide[i] = near_step((bnlw[i]/0.05), block_step)
          }
          return block_n_hi_wide
        }

// //generate block stimulus

  // block data

        // block_1
        block_1_lo_wide = gen_block_n_lo_wide(block_1_min, block_1_max, block_1_step)
        block_1_hi_wide = gen_block_n_hi_wide(block_1_lo_wide, block_1_step)
        block_1_lo_narr = gen_block_n_lo_narr(block_1_lo_wide, block_1_step)
        block_1_hi_narr = gen_block_n_hi_narr(block_1_lo_wide, block_1_step)


        // block_2
        block_2_lo_wide = gen_block_n_lo_wide(block_2_min, block_2_max, block_2_step)
        block_2_hi_wide = gen_block_n_hi_wide(block_2_lo_wide, block_2_step)
        block_2_lo_narr = gen_block_n_lo_narr(block_2_lo_wide, block_2_step)
        block_2_hi_narr = gen_block_n_hi_narr(block_2_lo_wide, block_2_step)

        // block_3
        block_3_lo_wide = gen_block_n_lo_wide(block_3_min, block_3_max, block_3_step)
        block_3_hi_wide = gen_block_n_hi_wide(block_3_lo_wide, block_3_step)
        block_3_lo_narr = gen_block_n_lo_narr(block_3_lo_wide, block_3_step)
        block_3_hi_narr = gen_block_n_hi_narr(block_3_lo_wide, block_3_step)


        var bonus_list = []
        var info_b1 = []
        var info_b2 = []
        var info_b3 = []
        var stim_html_b1 = []
        var stim_html_b2 = []
        var stim_html_b3 = []

  // block format - block 1:
        for (var i = 0; i < percents.length; i++) {
          stim_html_b1[i] =
            "<div class = centerbox id='container'><p class = center-block-text>"+
            "Please select the option that you would prefer by pressing <strong>'left arrow key'</strong> for left <strong>'right arrow key'</strong> for right:</p>"+
            "<div class='table'><div class='row'><div id = 'option'><center><font color='green'>" +
            percents[i][0] + "% chance of $" + block_1_hi_narr[i] + "<br>" +
            percents[i][1] + "% chance of $" + block_1_lo_narr[i] +
            "</font></center></div>"+
            "<div id = 'option'><center><font color='green'>" +
            percents[i][0] + "% chance of $" + block_1_hi_wide[i] + "<br>" +
            percents[i][1] + "% chance of $" + block_1_lo_wide[i] +
            "</font></center></div></div></div></div>"
            var t1ev = ((block_1_hi_narr[i]*percents[i][0] + block_1_lo_narr[i]*percents[i][1])/100).toFixed(4)
            var t2ev = ((block_1_hi_wide[i]*percents[i][0] + block_1_lo_wide[i]*percents[i][1])/100).toFixed(4)
            var diffEv = (t1ev - t2ev).toFixed(4)
              info_b1.push({
                block: "block_1",
                top_p: percents[i][0],
                low_p: percents[i][1],
                hi_narr: block_1_hi_narr[i],
                lo_narr: block_1_lo_narr[i],
                hi_wide: block_1_hi_wide[i],
                lo_wide: block_1_lo_wide[i],
                ticket1_EV: t1ev,
                ticket2_EV: t2ev,
                difference: diffEv,

              })
            }

          var trials_b1 = []
          //used new features to include the stimulus properties in recorded data
          for (var i = 0; i < stim_html_b1.length; i++) {
            trials_b1.push({
              stimulus: stim_html_b1[i],
              data: info_b1[i],
            });
          }

      // block format - block 2:
          for (var i = 0; i < percents.length; i++) {
            stim_html_b2[i] =
              "<div class = centerbox id='container'><p class = center-block-text>"+
              "Please select the option that you would prefer by pressing <strong>'left arrow key'</strong> for left <strong>'right arrow key'</strong> for right:</p>"+
              "<div class='table'><div class='row'><div id = 'option'><center><font color='green'>" +
              percents[i][0] + "% chance of $" + block_2_hi_narr[i] + "<br>" +
              percents[i][1] + "% chance of $" + block_2_lo_narr[i] +
              "</font></center></div>"+
              "<div id = 'option'><center><font color='green'>" +
              percents[i][0] + "% chance of $" + block_2_hi_wide[i] + "<br>" +
              percents[i][1] + "% chance of $" + block_2_lo_wide[i] +
              "</font></center></div></div></div></div>"
              var t1ev = ((block_2_hi_narr[i]*percents[i][0] + block_2_lo_narr[i]*percents[i][1])/100).toFixed(4)
              var t2ev = ((block_2_hi_wide[i]*percents[i][0] + block_2_lo_wide[i]*percents[i][1])/100).toFixed(4)
              var diffEv = (t1ev - t2ev).toFixed(4)
                info_b2.push({
                  block: "block_2",
                  top_p: percents[i][0],
                  low_p: percents[i][1],
                  hi_narr: block_2_hi_narr[i],
                  lo_narr: block_2_lo_narr[i],
                  hi_wide: block_2_hi_wide[i],
                  lo_wide: block_2_lo_wide[i],
                  ticket1_EV: t1ev,
                  ticket2_EV: t2ev,
                  difference: diffEv,

                })
            }

            var trials_b2 = []
            //used new features to include the stimulus properties in recorded data
            for (var i = 0; i < stim_html_b2.length; i++) {
              trials_b2.push({
                stimulus: stim_html_b2[i],
                data: info_b2[i]
              });
            }

      // block format - block 3:
            for (var i = 0; i < percents.length; i++) {
              stim_html_b3[i] =
                "<div class = centerbox id='container'><p class = center-block-text>"+
                "Please select the option that you would prefer by pressing <strong>'left arrow key'</strong> for left <strong>'right arrow key'</strong> for right:</p>"+
                "<div class='table'><div class='row'><div id = 'option'><center><font color='green'>" +
                percents[i][0] + "% chance of $" + block_3_hi_narr[i] + "<br>" +
                percents[i][1] + "% chance of $" + block_3_lo_narr[i] +
                "</font></center></div>"+
                "<div id = 'option'><center><font color='green'>" +
                percents[i][0] + "% chance of $" + block_3_hi_wide[i] + "<br>" +
                percents[i][1] + "% chance of $" + block_3_lo_wide[i] +
                "</font></center></div></div></div></div>"
                var t1ev = ((block_3_hi_narr[i]*percents[i][0] + block_3_lo_narr[i]*percents[i][1])/100).toFixed(4)
                var t2ev = ((block_3_hi_wide[i]*percents[i][0] + block_3_lo_wide[i]*percents[i][1])/100).toFixed(4)
                var diffEv = (t1ev - t2ev).toFixed(4)
                  info_b3.push({
                    block: "block_3",
                    top_p: percents[i][0],
                    low_p: percents[i][1],
                    hi_narr: block_3_hi_narr[i],
                    lo_narr: block_3_lo_narr[i],
                    hi_wide: block_3_hi_wide[i],
                    lo_wide: block_3_lo_wide[i],
                    ticket1_EV: t1ev,
                    ticket2_EV: t2ev,
                    difference: diffEv,

                  })
              }

              var trials_b3 = []
              //used new features to include the stimulus properties in recorded data
              for (var i = 0; i < stim_html_b2.length; i++) {
                trials_b3.push({
                  stimulus: stim_html_b3[i],
                  data: info_b3[i]
                });
              }

// // run exp - block 1 - reading time
              var block_wait = {
                type: "html-keyboard-response",
                stimulus: jsPsych.timelineVariable('stimulus'),
                data: jsPsych.timelineVariable('data'),
                choices: jsPsych.NO_KEYS,
                post_trial_gap: 0,
                trial_duration: read_time,
                // response_ends_trial: false, // breaks it
                on_finish: function(data) {
                  console.log("trial_wait")
                  data.curr_bonus = (jsPsych.data.get().select('trial_bonus').sum()).toFixed(1)
                  jsPsych.data.addDataToLastTrial({
                    exp_stage: "main_read",
                    primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                    exp_part: "main"
                  });
                }
              }

// run exp - block 1
              var block_1_run = {
                type: "html-keyboard-response",
                stimulus: jsPsych.timelineVariable('stimulus'),
                data: jsPsych.timelineVariable('data'),
                choices: [37, 39],
                post_trial_gap: 200,
                // response_ends_trial: false, // breaks it
                on_finish: function(data) {
                  console.log("trial_run")
                  if (data.key_press == 37) { // Chose ticket1
                    data.choice = 'ticket1'
                    top_reward = block_1_hi_narr[i]
                    bottom_reward = block_1_lo_narr[i]
                    if (data.difference <= 0){ //ticket1 had a greater expected value
                      EV_chosen = 'less'
                      data.EV_chosen = 'less';
                      data.correct_choice = 'ticket2'
                      data.correct = false
                    }
                    else{
                      EV_chosen = 'more'
                      data.EV_chosen = 'more';
                      data.correct_choice = 'ticket1'
                      data.correct = true
                    }
                  }
                   else if (data.key_press == 39) { // Chose ticket 2
                    data.choice = 'ticket2'
                    top_reward = block_1_hi_wide[i]
                    bottom_reward = block_1_lo_wide[i]
                    if(data.difference >=0) { //and ticket2 had a greater expected value
                      EV_chosen = 'less';
                      data.EV_chosen = 'less';
                      data.correct_choice = 'ticket1'
                      data.correct = false
                    }
                    else{
                      EV_chosen = 'more';
                      data.EV_chosen = 'more';
                      data.correct_choice = 'ticket2'
                      data.correct = true
                    }
                  }
                  if (EV_chosen == 'more') {
                    data.trial_bonus = bonus_zero + bonus_fraction
                  } else if (EV_chosen == 'less') {
                    data.trial_bonus = bonus_zero
                  }
                  data.curr_bonus = (jsPsych.data.get().select('trial_bonus').sum()).toFixed(1)

                  if (data.top_p == 100 && data.choice != 'ticket2'){
                      data.suspicious = true
                      data.suspicious_type = 'one_off'
                    }
                  jsPsych.data.addDataToLastTrial({
                    exp_stage: "main_choice",
                    primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                    exp_part: "main"
                  });
                }
              }

// bonus update
              var bonus_update = {
                type: "html-keyboard-response",
                stimulus: function(){
                  var bonus = jsPsych.data.get().filter({exp_stage: 'main_choice'}).last(1).values()[0].curr_bonus;
                  var rounded_bonus = Math.round(bonus)
                  return "<p>Feel free to take a short break, but not too long. This will time out after 1 minute.</p>" +
                  "<p>Press any key to resume the task.</p>"},
                trial_duration: 60000,
                response_ends_trial: true,
                  on_finish: function(data) {
                    data.num_ticket1 = jsPsych.data.get().last(percents.length*2).filter({choice: 'ticket1'}).count()
                    num_ticket1 = jsPsych.data.get().last(percents.lengt*2).filter({choice: 'ticket1'}).count()
                    data.num_ticket2 = jsPsych.data.get().last(percents.length*2).filter({choice: 'ticket2'}).count()
                    num_ticket2 = jsPsych.data.get().last(percents.length*2).filter({choice: 'ticket2'}).count()
                    num_one_off = jsPsych.data.get().last(10).filter({suspicious_type: 'one_off'}).count()
                    if (data.num_ticket1 == percents.length || data.num_ticket2 == percents.length){
                      data.suspicious_type = 'all_one'
                      data.suspicious = true
                    }
                    else if (num_one_off !== 0) {
                      data.suspicious_type = 'one_off'
                      data.suspicious = true
                    }
                    else {
                      data.suspicious = false
                    }

                    data.block = jsPsych.data.get().last(2).values()[0].block

                    jsPsych.data.addDataToLastTrial({
                      exp_stage:"between_block",
                      primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                      exp_part: "main"
                    })
                  }
                }

        // push block 1 + bonus update to timeline
                        var test_procedure_block_1 = {
                          timeline: [block_wait, block_1_run],
                          // timeline: [block_1_run],
                          timeline_variables: trials_b1,
                          randomize_order: true
                        }
                        timeline.push(test_procedure_block_1, bonus_update)

        // run exp - block 2
                        var block_2_run = {
                          type: "html-keyboard-response",
                          stimulus: jsPsych.timelineVariable('stimulus'),
                          data: jsPsych.timelineVariable('data'),
                          choices: [37, 39],
                          post_trial_gap: 200,
                          on_finish: function(data) {
                            if (data.key_press == 37) { // Chose ticket1
                              data.choice = 'ticket1'
                              top_reward = block_1_hi_narr[i]
                              bottom_reward = block_1_lo_narr[i]
                              if (data.difference <= 0){ //ticket1 had a greater expected value
                                EV_chosen = 'less'
                                data.EV_chosen = 'less';
                                data.correct_choice = 'ticket2'
                                data.correct = false
                              }
                              else{
                                EV_chosen = 'more'
                                data.EV_chosen = 'more';
                                data.correct_choice = 'ticket1'
                                data.correct = true
                              }
                            }
                             else if (data.key_press == 39) { // Chose ticket 2
                              data.choice = 'ticket2'
                              top_reward = block_1_hi_wide[i]
                              bottom_reward = block_1_lo_wide[i]
                              if(data.difference >=0) { //and ticket2 had a greater expected value
                                EV_chosen = 'less';
                                data.EV_chosen = 'less';
                                data.correct_choice = 'ticket1'
                                data.correct = false
                              }
                              else{
                                EV_chosen = 'more';
                                data.EV_chosen = 'more';
                                data.correct_choice = 'ticket2'
                                data.correct = true
                              }
                            }
                            if (EV_chosen == 'more') {
                              data.trial_bonus = bonus_zero + bonus_fraction
                            } else if (EV_chosen == 'less') {
                              data.trial_bonus = bonus_zero
                            }
                            data.curr_bonus = (jsPsych.data.get().select('trial_bonus').sum()).toFixed(1)

                            if (data.top_p == 100 && data.choice != 'ticket2'){
                                data.suspicious = true
                                data.suspicious_type = 'one_off'
                              }
                            jsPsych.data.addDataToLastTrial({
                              exp_stage: "main_choice",
                              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                              exp_part: "main"
                          })
                        }
                      }

                        var test_procedure_block_2 = {
                          timeline: [block_wait, block_2_run],
                          timeline_variables: trials_b2,
                          randomize_order: true
                        }
                        timeline.push(test_procedure_block_2, bonus_update)

        // run exp - block 3
                        var block_3_run = {
                          type: "html-keyboard-response",
                          stimulus: jsPsych.timelineVariable('stimulus'),
                          data: jsPsych.timelineVariable('data'),
                          choices: [37, 39],
                          post_trial_gap: 500,
                          on_finish: function(data) {
                            if (data.key_press == 37) { // Chose ticket1
                              data.choice = 'ticket1'
                              top_reward = block_1_hi_narr[i]
                              bottom_reward = block_1_lo_narr[i]
                              if (data.difference <= 0){ //ticket1 had a greater expected value
                                EV_chosen = 'less'
                                data.EV_chosen = 'less';
                                data.correct_choice = 'ticket2'
                                data.correct = false
                              }
                              else{
                                EV_chosen = 'more'
                                data.EV_chosen = 'more';
                                data.correct_choice = 'ticket1'
                                data.correct = true
                              }
                            }
                             else if (data.key_press == 39) { // Chose ticket 2
                              data.choice = 'ticket2'
                              top_reward = block_1_hi_wide[i]
                              bottom_reward = block_1_lo_wide[i]
                              if(data.difference >=0) { //and ticket2 had a greater expected value
                                EV_chosen = 'less';
                                data.EV_chosen = 'less';
                                data.correct_choice = 'ticket1'
                                data.correct = false
                              }
                              else{
                                EV_chosen = 'more';
                                data.EV_chosen = 'more';
                                data.correct_choice = 'ticket2'
                                data.correct = true
                              }
                            }
                            if (EV_chosen == 'more') {
                              data.trial_bonus = bonus_zero + bonus_fraction
                            } else if (EV_chosen == 'less') {
                              data.trial_bonus = bonus_zero
                            }
                            data.curr_bonus = (jsPsych.data.get().select('trial_bonus').sum()).toFixed(1)

                            if (data.top_p == 100 && data.choice != 'ticket2'){
                                data.suspicious = true
                                data.suspicious_type = 'one_off'
                              }
                            jsPsych.data.addDataToLastTrial({
                              exp_stage: "main_choice",
                              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                              exp_part: "main"
                            });
                          }
                        }

                        var test_procedure_block_3 = {
                          timeline: [block_wait, block_3_run],
                          timeline_variables: trials_b3,
                          randomize_order: true
                        }
                        timeline.push(test_procedure_block_3)

        //  bonus feedback
                        var end_bonus = {
                          type: 'instructions',
                          pages: function() {
                            bonus = jsPsych.data.get().last(1).values()[0].curr_bonus
                            rounded_bonus = Math.round(bonus)

                            return ['<p>This marks the end of the experiment.</p>' +
                            '<p>You earned <b>' + rounded_bonus + ' points </b>!</p>' +
                            '<p>Thank you so much for your participation.</p>' +
                            '<p>Press <q>Next</q> to continue to the feedback survey.</p>'];
                          },
                          show_clickable_nav: true,
                          on_finish: function(data) {
                              last_block = jsPsych.data.getLastTrialData().values()[0].block
                              data.num_ticket1 = jsPsych.data.get().last(percents.length*2).filter({choice: 'ticket1'}).count()
                              num_ticket1 = jsPsych.data.get().last(percents.length*2).filter({choice: 'ticket1'}).count()
                              data.num_ticket2 = jsPsych.data.get().last(percents.length*2).filter({choice: 'ticket2'}).count()
                              num_ticket2 = jsPsych.data.get().last(percents.length*2).filter({choice: 'ticket2'}).count()
                              num_one_off = jsPsych.data.get().filter({suspicious_type: 'one_off'}).count()
                              if (data.num_ticket1 == percents.length || data.num_ticket2 == percents.length){
                                data.suspicious_type = 'all_one'
                                data.suspicious = true
                              }
                              else if (num_one_off !== 0) {
                                data.suspicious_type = 'one_off'
                                data.suspicious = true
                              }
                              else {
                                data.suspicious = false
                              }
                              data.block = jsPsych.data.get().last(2).values()[0].block


                            jsPsych.data.addDataToLastTrial({
                              exp_stage:"end_bonus",
                              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                              exp_part: "main"
                            })
                          }
                        }
                        timeline.push(end_bonus)

// feedback timelines
// suspicious

                var fb_warning_ss = {
                  type: 'instructions',
                  pages: [
                    "<p align='left'> This task has several built in alarms that signal when a worker may be trying to 'trick' at a task" +
                    "<p align='left'> (i.e. by selecting the same answer every time, or never answering at all). " +
                    "<p align='left'>  Something about your responses for part or all of this task has triggered one of these alarms." ,

                    "<p align='left'>  Your bonus will be witheld until an experimenter can manually review your answers to check if there was a mistake on our end, or if you did try to 'trick' the task." +
                    "<p align='left'>  In the following feedback survey, you will have the chance to explain anything that may have made your answers appear irregular. " +
                    "<p align='left'>  In the event that an honest mistake was made or our code was incorrect, you will receive your bonus as planned" +
                    "<p align='left'>  However, if it appears that you tried to 'trick' the system, we reserve the right to withold your bonus, and if cheating behavior continues you will be asked to leave the study."
                      ],
                   show_clickable_nav: true,
                   on_finish: function(data) {
                    jsPsych.data.addDataToLastTrial({
                      fb_type: "suspicious",
                      exp_stage:"feedback_warning",
                      primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                      exp_part: "feedback"
                    })
                  }
                };

                // first question - tech problems
                    var fb_q1_ss = {
                        type: 'survey-multi-choice',
                        preamble: '<h4> Feedback Survey 1/4 </h4>' , //+
                        questions: [
                          {prompt: "Did you experience any technological issues during this task?   (i.e. experiment glitch, accidentally closed window, mixed up keys, etc.) <br>  If you answer 'Yes' or 'I am unsure' you will have the opportunity to explain",
                            options: [" Yes", " No", " I am unsure"],
                            required: true,
                            name: 'tech problems'},
                            ],
                            on_finish: function(data){
                              var dat1 = jsPsych.data.getLastTrialData().values()[0];
                              var answer1 = JSON.parse(dat1.responses).Q0;
                              if(answer1.includes('Yes') == true || answer1.includes('unsure')) {
                                jsPsych.data.addDataToLastTrial({
                                  fb_type: "suspicious",
                                  fb_issue:'tech',
                                  exp_stage:"feedback_tech",
                                  primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                                  exp_part: "feedback"
                                })
                              } else {
                                jsPsych.data.addDataToLastTrial({
                                  fb_type: "suspicious",
                                  exp_stage:"feedback_tech",
                                  primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                                  exp_part: "feedback"
                                })
                              }
                            }
                        };

                  // first question - tech problems - if yes, please explain
                    var fb_q1_follow_ss = {
                        type: 'survey-text',
                        preamble: '<h4> Feedback Survey 1/4 </h4>' , //+
                        questions: [
                          {prompt: "Please tell us about the technical difficulties you experienced: ",
                            required: true,
                            name: 'tech problems follow up'},
                            ],
                            on_finish: function(data){
                              var dat1 = jsPsych.data.getLastTrialData().values()[0];
                              var answer1 = JSON.parse(dat1.responses).Q0;
                              jsPsych.data.addDataToLastTrial({
                                fb_type: "suspicious",
                                fb_issue: 'tech',
                                fb_issue_txt: answer1,
                                exp_stage:"feedback_tech_followup",
                                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                                exp_part: "feedback"
                              })
                            }
                        };

                  // determines if subject answered yes, and explanation is required
                    var fb_q1_eval_ss = {
                        timeline: [fb_q1_follow_ss],
                        conditional_function:   function() {
                            var dat1 = jsPsych.data.getLastTrialData().values()[0];
                            var answer1 = JSON.parse(dat1.responses).Q0;
                            if(answer1.includes('Yes') == true || answer1.includes('unsure')) {
                                return true;
                            } else {
                                return false;
                            }
                          },
                      };


                // second question - distractions
                    var fb_q2_ss = {
                        type: 'survey-multi-choice',
                        preamble: '<h4> Feedback Survey 2/4 </h4>', // +
                        questions: [{
                            prompt: "Did you experience any major distractions or interruptions during this task? <br> If you answer 'Yes' you will have the opportunity to explain",
                            options: [" Yes", " No"],
                            required: true,
                            name: 'distractions'
                          },
                        ],
                        on_finish: function(data){
                          var dat2 = jsPsych.data.getLastTrialData().values()[0];
                          var answer2 = JSON.parse(dat2.responses).Q0;
                          if(answer2.includes('Yes') == true) {
                            jsPsych.data.addDataToLastTrial({
                              fb_type: "suspicious",
                              fb_issue:'distraction',
                              exp_stage:"feedback_distraction",
                              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                              exp_part: "feedback"
                            })
                          } else {
                            jsPsych.data.addDataToLastTrial({
                              fb_type: "suspicious",
                              exp_stage:"feedback_distraction",
                              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                              exp_part: "feedback"
                            })
                          }
                        }
                      };

                  // second question - distractions - if yes, please explain
                    var fb_q2_follow_ss = {
                        type: 'survey-text',
                        preamble: '<h4> Feedback Survey 2/4 </h4>', // +
                        questions: [
                          {prompt: "Please describe how the distraction may have effected your performance, and if possible, at what point in the task this distraction occured:",
                            name: 'tech problems follow up'},
                            ],
                            on_finish: function(data){
                              var dat2 = jsPsych.data.getLastTrialData().values()[0];
                              var answer2 = JSON.parse(dat2.responses).Q0;
                              jsPsych.data.addDataToLastTrial({
                                fb_type: "suspicious",
                                fb_issue: 'distraction',
                                fb_issue_txt: answer2,
                                exp_stage:"feedback_distraction_followup",
                                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                                exp_part: "feedback"
                              })
                            }
                        };

                  // determines if subject answered yes, and explanation is required
                    var fb_q2_eval_ss = {
                        timeline: [fb_q2_follow_ss],
                        conditional_function:   function() {
                            var dat2 = jsPsych.data.getLastTrialData().values()[0];
                            var answer2 = JSON.parse(dat2.responses).Q0;
                            if(answer2.includes('Yes') == true) {
                                return true;
                            } else {
                                return false;
                            }
                          },
                      };


                // third question: engagement
                    var fb_q3_ss = {
                        type: 'survey-multi-choice',
                        preamble: '<h4> Feedback Survey 3/4 </h4>', // +
                        questions: [{
                            prompt: "On the following scale from 1 to 4, how engaging (attention holding) did you find this task?",
                            options: [" 1 - Not at all engaging", " 2 - Somewhat not engaging", " 3 - Somewhat engaging", " 4 - Very engaging"],
                            required: true,
                            name: 'engagement'
                          },
                        ],
                            on_finish: function(data){
                              var dat3 = jsPsych.data.getLastTrialData().values()[0];
                              var answer3 = JSON.parse(dat3.responses).Q0;
                              jsPsych.data.addDataToLastTrial({
                                fb_type: "suspicious",
                                fb_engagement: answer3,
                                exp_stage:"feedback_engaged",
                                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                                exp_part: "feedback"
                              })
                            }
                        };

                // fourth question: anything else
                    var fb_q4_ss = {
                        type: 'survey-text',
                        preamble: '<h4> Feedback Survey 4/4 </h4>', // +
                        questions: [{
                            prompt: "Is there anything else you would like us to know? <br> (Can be a specific concern or general suggestion for improvement)",
                            name: 'anything else'
                          },
                        ],
                            on_finish: function(data){

                              var interaction_data = jsPsych.data.getInteractionData();
                              data.screen = interaction_data.json();

                              var dat4 = jsPsych.data.getLastTrialData().values()[0];
                              var answer4 = JSON.parse(dat4.responses).Q0;
                              if (answer4 == ''){
                                jsPsych.data.addDataToLastTrial({
                                fb_type: "suspicious",
                                exp_stage:"feedback_other",
                                fb_type: "suspicious",
                                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                                exp_part: "feedback"
                              })
                            } else {
                              jsPsych.data.addDataToLastTrial({
                                fb_type: "suspicious",
                                fb_issue: 'other',
                                fb_issue_txt: answer4,
                                exp_stage:"feedback_other",
                                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                                exp_part: "feedback"
                                })
                              }
                            }
                        };

                // conclusion
                    // var fb_end_exp_ss = {
                    //   type: 'html-keyboard-response',
                    //   stimulus: '<p>Thank you! This marks the end of the feeback survey.</p> <p>Press any key to return to the home page.</p>',
                    //   on_finish: function(data) {
                    //     jsPsych.data.addDataToLastTrial({
                    //       fb_type: "suspicious",
                    //       exp_stage:"exp_end",
                    //       primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                    //       exp_part: "feedback"
                    //     })
                    //   }
                    // };


                // not suspicious

                var fb_warning_ns = {
                  type: 'instructions',
                  pages: [
                    "<p align='left'> This task has several built in alarms that signal when a worker may be trying to 'trick' at a task" +
                    "<p align='left'> (i.e. by selecting the same answer every time, or never answering at all). " +
                    "<p align='left'> Your responses will be manually reviewed by a researcher, however it appears you have performed the task with sincere effort. Thank you!" ,

                    "<p align='left'>  In the following feedback survey, you will have the chance to explain anything that may have made your answers appear irregular. " +
                    "<p align='left'>  In the event that an honest mistake was made or our code was incorrect, you will receive your bonus as planned" +
                    "<p align='left'>  However, if in review it appears that you tried to 'trick' the system, we reserve the right to withold your bonus, and if cheating behavior continues you will be asked to leave the study."
                      ],
                   show_clickable_nav: true,
                   on_finish: function(data) {
                    jsPsych.data.addDataToLastTrial({
                      fb_type: "nonsuspicious",
                      exp_stage:"feedback_warning",
                      primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                      exp_part: "feedback"
                    })
                  }
                };

                // first question - tech problems
                  var fb_q1_ns = {
                      type: 'survey-multi-choice',
                      preamble: '<h4> Feedback Survey 1/4 </h4>' +
                                "<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
                      questions: [
                        {prompt: "Did you experience any technological issues during this task?   (i.e. experiment glitch, accidentally closed window, mixed up keys, etc.) <br>  If you answer 'Yes' or 'I am unsure' you will have the opportunity to explain",
                          options: [" Yes", " No", " I am unsure"],
                          // horizontal: true,
                          required: true,
                          name: 'tech problems'},
                          ],
                          on_finish: function(data){
                            var dat1 = jsPsych.data.getLastTrialData().values()[0];
                            var answer1 = JSON.parse(dat1.responses).Q0;
                            if(answer1.includes('Yes') == true || answer1.includes('unsure')) {
                              jsPsych.data.addDataToLastTrial({
                                fb_type: "nonsuspicious",
                                fb_issue:'tech',
                                exp_stage:"feedback_tech",
                                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                                exp_part: "feedback"
                              })
                            } else {
                              jsPsych.data.addDataToLastTrial({
                                fb_type: "nonsuspicious",
                                exp_stage:"feedback_tech",
                                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                                exp_part: "feedback"
                              })
                            }
                          }
                      };

                  // first question - tech problems - if yes, please explain
                  var fb_q1_follow_ns = {
                      type: 'survey-text',
                      preamble: '<h4> Feedback Survey 1/4 </h4>' +
                                "<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
                      questions: [
                        {prompt: "Please tell us about the technical difficulties you experienced: ",
                          required: true,
                          name: 'tech problems follow up'},
                          ],
                          on_finish: function(data){
                            var dat1 = jsPsych.data.getLastTrialData().values()[0];
                            var answer1 = JSON.parse(dat1.responses).Q0;
                            jsPsych.data.addDataToLastTrial({
                              fb_type: "nonsuspicious",
                              fb_issue: 'tech',
                              fb_issue_txt: answer1,
                              exp_stage:"feedback_tech_followup",
                              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                              exp_part: "feedback"
                            })
                          }
                      };

                  // determines if subject answered yes, and explanation is required
                  var fb_q1_eval_ns = {
                      timeline: [fb_q1_follow_ns],
                      conditional_function:   function() {
                          var dat1 = jsPsych.data.getLastTrialData().values()[0];
                          var answer1 = JSON.parse(dat1.responses).Q0;
                          if(answer1.includes('Yes') == true || answer1.includes('unsure')) {
                              return true;
                          } else {
                              return false;
                          }
                        },
                    };


                // second question - distractions
                  var fb_q2_ns = {
                      type: 'survey-multi-choice',
                      preamble: '<h4> Feedback Survey 2/4 </h4>' +
                                "<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
                      questions: [{
                          prompt: "Did you experience any major distractions or interruptions during this task? <br> If you answer 'Yes' you will have the opportunity to explain",
                          options: [" Yes", " No"],
                          required: true,
                          name: 'distractions'
                        },
                      ],
                      on_finish: function(data){
                        var dat2 = jsPsych.data.getLastTrialData().values()[0];
                        var answer2 = JSON.parse(dat2.responses).Q0;
                        if(answer2.includes('Yes') == true) {
                          jsPsych.data.addDataToLastTrial({
                            fb_type: "nonsuspicious",
                            fb_issue:'distraction',
                            exp_stage:"feedback_distraction",
                            primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                            exp_part: "feedback"
                          })
                        } else {
                          jsPsych.data.addDataToLastTrial({
                            fb_type: "nonsuspicious",
                            exp_stage:"feedback_distraction",
                            primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                            exp_part: "feedback"
                          })
                        }
                      }
                    };

                  // second question - distractions - if yes, please explain
                  var fb_q2_follow_ns = {
                      type: 'survey-text',
                      preamble: '<h4> Feedback Survey 2/4 </h4>' +
                                "<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
                      questions: [
                        {prompt: "Please describe how the distraction may have effected your performance, and if possible, at what point in the task this distraction occured:",
                          name: 'tech problems follow up'},
                          ],
                          on_finish: function(data){
                            var dat2 = jsPsych.data.getLastTrialData().values()[0];
                            var answer2 = JSON.parse(dat2.responses).Q0;
                            jsPsych.data.addDataToLastTrial({
                              fb_type: "nonsuspicious",
                              fb_issue: 'distraction',
                              fb_issue_txt: answer2,
                              exp_stage:"feedback_distraction_followup",
                              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                              exp_part: "feedback"
                            })
                          }
                      };

                  // determines if subject answered yes, and explanation is required
                  var fb_q2_eval_ns = {
                      timeline: [fb_q2_follow_ns],
                      conditional_function:   function() {
                          var dat2 = jsPsych.data.getLastTrialData().values()[0];
                          var answer2 = JSON.parse(dat2.responses).Q0;
                          if(answer2.includes('Yes') == true) {
                              return true;
                          } else {
                              return false;
                          }
                        },
                    };


                // third question: engagement
                  var fb_q3_ns = {
                      type: 'survey-multi-choice',
                      preamble: '<h4> Feedback Survey 3/4 </h4>' +
                                "<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
                      questions: [{
                          prompt: "On the following scale from 1 to 4, how engaging (attention holding) did you find this task?",
                          options: [" 1 - Not at all engaging", " 2 - Somewhat not engaging", " 3 - Somewhat engaging", " 4 - Very engaging"],
                          required: true,
                          name: 'engagement'
                        },
                      ],
                          on_finish: function(data){
                            var dat3 = jsPsych.data.getLastTrialData().values()[0];
                            var answer3 = JSON.parse(dat3.responses).Q0;
                            jsPsych.data.addDataToLastTrial({
                              fb_type: "nonsuspicious",
                              fb_engagement: answer3,
                              exp_stage:"feedback_engaged",
                              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                              exp_part: "feedback"
                            })
                          }
                      };

                // fourth question: anything else
                  var fb_q4_ns = {
                      type: 'survey-text',
                      preamble: '<h4> Feedback Survey 4/4 </h4>' +
                                "<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
                      questions: [{
                          prompt: "Is there anything else you would like us to know? <br> (Can be a specific concern or general suggestion for improvement)",
                          name: 'anything else'
                        },
                      ],
                          on_finish: function(data){

                            var interaction_data = jsPsych.data.getInteractionData();
                            data.screen = interaction_data.json();

                            var dat4 = jsPsych.data.getLastTrialData().values()[0];
                            var answer4 = JSON.parse(dat4.responses).Q0;
                            if (answer4 == ''){
                              jsPsych.data.addDataToLastTrial({
                              fb_type: "nonsuspicious",
                              exp_stage:"feedback_other",
                              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                              exp_part: "feedback"
                            })
                          } else {
                            jsPsych.data.addDataToLastTrial({
                              fb_type: "nonsuspicious",
                              fb_issue: 'other',
                              fb_issue_txt: answer4,
                              exp_stage:"feedback_other",
                              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                              exp_part: "feedback"
                              })
                            }
                          }
                      };

// conclusion
                  // var fb_end_exp_ns = {
                  //   type: 'html-keyboard-response',
                  //   stimulus: '<p>Thank you! This marks the end of the feeback survey.</p> <p>Press any key to return to the home page.</p>',
                  //   on_finish: function(data) {
                  //     jsPsych.data.addDataToLastTrial({
                  //       exp_stage:"exp_end",
                  //       primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                  //        exp_part: "feedback"
                  //     })
                  //   }
                  // };


                // evaluate whether any of the responses were suspicious and provide appropriate quiz

                  var eval_ss_timeline = {
                    timeline: [fb_warning_ss, fb_q1_ss, fb_q1_eval_ss, fb_q2_ss, fb_q2_eval_ss, fb_q3_ss, fb_q4_ss],
                    // timeline: [fb_warning_ss, fb_q1_ss, fb_q1_eval_ss, fb_q2_ss, fb_q2_eval_ss, fb_q3_ss, fb_q4_ss, fb_end_exp_ss],
                    conditional_function: function(data) {
                      sus_dat = jsPsych.data.get().filter({exp_part: 'main', suspicious: true}).count()
              				if (sus_dat >= 1) {
                        return true;
                      } else {
                        return false;
                      }
                    },
                  };
                  timeline.push(eval_ss_timeline);

                  var eval_ns_timeline = {
                    timeline: [fb_warning_ns, fb_q1_ns, fb_q1_eval_ns, fb_q2_ns, fb_q2_eval_ns, fb_q3_ns, fb_q4_ns],
                    // timeline: [fb_warning_ns, fb_q1_ns, fb_q1_eval_ns, fb_q2_ns, fb_q2_eval_ns, fb_q3_ns, fb_q4_ns, fb_end_exp_ns],
                    conditional_function: function(data) {
                      if (sus_dat == 0) {
                        return true;
                      } else {
                        return false;
                      }
                    },
                  };
                  timeline.push(eval_ns_timeline);

// Save data to CSV
              						function saveData_csv(name, data){
              							var xhr = new XMLHttpRequest();
              							xhr.open('POST', 'save_data.php');
              							xhr.setRequestHeader('Content-Type', 'application/json');
              							xhr.send(JSON.stringify({filename: name, filedata: data}));
              						}

              						/* grab data before the end of the experiment */

              						var save_data = {
              							type: 'call-function',
              							func: function(){ saveData_csv(subjectId + '_' + weekId + '_' + expId, jsPsych.data.get().csv());
              							},
              							timing_post_trial: 0,
              							on_finish: function(data) {
              								jsPsych.data.addDataToLastTrial({
              									exp_stage:"save_CSV",
              									primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                                exp_part: "save"
              								})
              							}
              						};
              						timeline.push(save_data);
              						console.log('csv save successful')

// // database save

            						function saveData() {
            							var xhr = new XMLHttpRequest();
            							xhr.open('POST', 'write_data_lt.php'); // change 'write_data.php' to point to php script.
            							xhr.setRequestHeader('Content-Type', 'application/json');
            							xhr.onload = function() {
            								console.log('xhr response text coming up')
            								console.log(xhr.responseText);
            								if(xhr.status == 200){
            									var response = JSON.parse(xhr.responseText);
            									console.log(xhr.responseText);
            									console.log(response.success);
            								}
            							};
            							xhr.send(jsPsych.data.get().json());
            							console.log('function finished well')
            						};

                        var db_save = {
            						type: 'call-function',
            						func: saveData,
            						on_finish: function(data) {
            							// jsPsych.data.get().localSave('csv','lt_0.csv');
            							jsPsych.data.addDataToLastTrial({
            								exp_stage:"save_database",
            								primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                            exp_part: "save"
            								})
            							}
            						};
            						timeline.push(db_save)


// data saving + compensation code
                    var save_wait_1 = {
                      type: 'html-keyboard-response',
                      stimulus: '<p> Thank you for your participation! This marks the end of your session.</p>' +
                      '<p> Please wait several moments while your data saves. </p>',
                      choices: [jsPsych.NO_KEYS],
                      trial_duration: 7000,
                      response_ends_trial: false,
                      on_finish: function(data) {
                        jsPsych.data.addDataToLastTrial({
                          exp_stage:"data_saving",
                          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                          exp_part: "save"
                        })
                      }
                    };


                    var save_wait_2 = {
                      type: 'html-button-response',
                      stimulus: '<p> Your data has been saved!</p>' +
                      '<p> You may click the button below to proceed to your compensation code. </p>',
                      choices: ['Ready'],
                      response_ends_trial: true,
                      on_finish: function(data) {
                        jsPsych.data.addDataToLastTrial({
                          exp_stage:"data_saved",
                          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                          exp_part: "save"
                        })
                      }
                    };

                    var comp_code = {
                      type: 'html-keyboard-response',
                      stimulus: '<p> Your completion code is</p>' + comp_code + '<p> No action is necessary and you may exit the window. </p>',
                      response_ends_trial: true,
                      on_finish: function(data) {
                        jsPsych.data.addDataToLastTrial({
                          exp_stage:"comp_code",
                          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                          exp_part: "save"
                        })
                      }
                    };

                    timeline.push(save_wait_1, save_wait_2, comp_code)

// init experiment
                jsPsych.init({
                      timeline: timeline,
                      // on_finish: saveData
                      // console.log('db save successful')
                      // on_finish: function(){
                      //   jsPsych.data.displayData();
                      //   jsPsych.data.get().localSave('csv','lt_0.csv');
                      // }
                });
            </script>
        </html>
