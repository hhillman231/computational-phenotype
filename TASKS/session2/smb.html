<!DOCTYPE html>
<html>
    <head>
        <title>Slot Machine Game</title>
        <script src="jspsych-6.0.5/jspsych.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-fullscreen.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-instructions.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-html-button-response.js"></script>
        <script src='jspsych-6.0.5/plugins/jspsych-survey-multi-choice.js'></script>
        <script src="jspsych-6.0.5/plugins/jspsych-survey-text.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-external-html.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-call-function.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>
        <link href="jspsych-6.0.5/css/bandit.css" rel="stylesheet" type="text/css"></link>
        <link href="jspsych-6.0.5/css/change-detection.css" rel="stylesheet" type="text/css"></link>
        <link rel="stylesheet" href="jspsych-6.0.5/css/jspsych.css"></link>
        <link rel='stylesheet' type='text/css' href='jspsych-6.0.5/css/jspsych.css'>
        <link rel="stylesheet" href="jspsych-6.0.5/css/style.css"></link>
    </head>
    <body></body>
    <script>

// quick change variables

        nextTask_name = "More or Less Game";
        nextTask_Id = "nc";

        starting_coins = 250
        n_games =  30 // 30
        n_trials = 10 // 10
        min_bonus = 0
        bonus_scaler = 20/(n_games*n_trials)
        error_rate_cap = 0.4
        colors = ['Tomato', 'Coral', 'Yellow', 'DarkSeaGreen', 'DeepSkyBlue', 'Aquamarine' , 'MediumPurple']

        trial_coins = starting_coins
        main_coins = starting_coins
        trial_points = 0
        main_points = 0

// start timeline

        timeline = []

// add identifying information for primary key

        // weeks of participation
        var weekId = "1"; // changed weekly
        jsPsych.data.addProperties({
          weekId: weekId
        });

        // experiment Id
        // Slot Machine task (formerly "bandit task") = smb
        var expId = "smb_" + jsPsych.randomization.randomID(8);
        var eId = "smb";
        jsPsych.data.addProperties({
          expId: eId
        });

        // url
        var fullurl = window.location.href;
        jsPsych.data.addProperties({
          url: fullurl
        });

        // subject Id taken from URL
        var subjectId = jsPsych.data.getURLVariable('workerId');
        jsPsych.data.addProperties({
          subjectId: subjectId
        });

        // assignment Id taken from URL
        var assignmentId = jsPsych.data.getURLVariable('assignmentId');
        jsPsych.data.addProperties({
          assignmentId: assignmentId
        });

        // hit Id taken from URL
        var hitId = jsPsych.data.getURLVariable('hitId');
        jsPsych.data.addProperties({
          hitId: hitId
        });

// for testing
        // var subjectId = "hannatest"
        // jsPsych.data.addProperties({
        //   subjectId: subjectId
        // });
        //
        // var assignmentId = "abc"
        // jsPsych.data.addProperties({
        //   assignmentId: assignmentId
        // });
        //
        // var hitId = "123"
        // jsPsych.data.addProperties({
        //   hitId: hitId
        // });



// fullscreen mode

        var fullscreen_intro = {
            type: 'instructions',
            pages: [
              "<p>On the next screen you will be asked to put your browser in full screen mode.</p>" +
              "<p>After entering full screen mode it is very important that you do not exit, switch tabs, minimize, or adjust the browser for the remainder of the game.</p>" +
              "<p>Doing so changes the display of the game and the game does not pause once started.</p>" +
              "<p>We can detect if you exit fullscreen, minimize the window, or switch to another tab, and we reserve the right to withold bonus/payment if this is indicated.</p>",
              ],
           show_clickable_nav: true,
           on_finish: function(data) {
            jsPsych.data.addDataToLastTrial({
              exp_stage:"fullscreen",
              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
              exp_part: "fullscreen"
            })
          }
        };
        timeline.push(fullscreen_intro)

        var fullscreen = {
          type: 'fullscreen',
          fullscreen_mode: true,
          on_finish: function(data) {
            data.exp_stage = 'fullscreen'
            trial_index = jsPsych.data.get().last(1).values()[0].trial_index
            data.primary_key = subjectId + '_' + weekId + '_' + expId + '_' + trial_index,
            data.exp_part =  "fullscreen"
          }
        };

        timeline.push(fullscreen)


// instructions block

        var instructions = {
            type: 'instructions',
            pages: [
                "<p align='left'> Welcome to the <b>Slot Machines</b>!</p>" +
                "<p align='left'>This task will take approximately 10 minutes to complete. </p>" +
                "<p align='left'> Click the <q>Next</q> button to continue.</p>",

                "<p align='left'> During this task, you will choose between two <q>slot machines</q>.</p>" +
                "<p> Playing the same slot machine will not always give you the same number of coins. One slot machine is always better than the other. </p>" +
                "<p align='left'> You will start out with <b>" + starting_coins + "</b> coins. Your goal is to win the most total coins by choosing to play the best slot machines. </p>",

                "<p align='left'> In this game slot machines are represented as colored buttons. </p>" +
                "<p align='left'> You play a machine  <i>by clicking with your mouse or trackpad on its button. </i></p> " +
                "<p> After each play, you will see if you won coins, lost coins, or if nothing happened. </p>",

                "<p> As you can see below, the <q>slot machines</q> are labeled <q>safe</q> or <q>risky</q>. </p>" +
                "<p><img src='img/bandit_example_slots_colored.png'></img> </p> " +
                "<p>For the <b>safe</b> machines you will get the same outcome every time. </p> <p> For the <b>risky</b> machines your reward or loss will vary. </p>" +
                "<p>You will see how many coins you won or lost after each play. </p>" +
                "<p align='left'><b> Note that the color of the machine is independent of how many coins it gives. Also, you cannot predict how good a machine is based on whether it is safe or risky.  A risky machine may deliver more coins on average than a safe machine, or vice versa. </b></p>",

                "<p align='left'> You will complete <b>" + n_games + " rounds</b>, <b>each round has a different pair of slot machines.</b> </p> " +
                "<p align='left'> You may not always be choosing between a risky and safe machine, you may be choosing between 2 risky machines, or 2 safe machines. </p> " +
                "<p align='left'> The outcome of playing a certain slot machine in one round does not effect the slot machines in other rounds </p> " +
                "<p align='left'><b> Each round will consist of " + n_trials + " plays. </b> </p> ",

                "<p align='left'> You should indicate your true preference because you will receive <b>bonus points</b> proportional to the number of coins you win in the game.</p>" +
                "<p align='left'> Please note that if you randomly <q>play</q> the machines, we reserve the right to withold your bonus. </p>",

                "<p align='left'> Next, you will answer some questions to make sure you understand the task. </p> " +
                "<p align='left'>Then you will do a practice round to gain familiarity with the task. </p>" +
                "<p align='left'>Press the <q>Next</q> button to answer the comprehension questions.</p>"

               ],
            show_clickable_nav: true,
            on_finish: function(data) {
              data.exp_stage = 'instructions'
              trial_index = jsPsych.data.get().last(1).values()[0].trial_index
              data.primary_key = subjectId + '_' + weekId + '_' + expId + '_' + trial_index,
              data.exp_part = "instructions"
            }
        };
        timeline.push(instructions)

// instruction comprehension questions


        var instruction_questions = {
            type:'survey-multi-choice',
            questions: [
              {prompt: "How do you <q>play</q> a machine?",
                options: ["I click my preferred choice on the screen",
                        "I press the '1' or '2' keys on my keyboard to indicate my choice of the first or second option",
                        "I press the left or right arrow keys on my keyboard to indicate my choice of the left or right option",
                        "I press the 'Q' or 'P' keys on my keyboard to indicate my choice of the left or right option, respectively" ]},
              {prompt: "What is the difference between safe and risky machines?",
                options: [
                        "Playing a safe machine always leads to winning more coins than a risky machine.",
                        "Playing a risky machine always leads to winning less coins than a safe machine.",
                        "Playing a safe machine always leads to the same outcome. Playing a risky machine leads to a different outcome each time.",
                        "Playing a safe machine always lead to winning coins. Playing a risky machine may lead to winning or losing coins."]},
              ],
            required: true,
            on_finish: function(data) {
              jsPsych.data.addDataToLastTrial({
                exp_stage:"instruction_questions",
                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                exp_part: "instructions"
              })
            }
        };
        timeline.push(instruction_questions);

        // what they see if they answered one or both questions incorrectly the first time
        var redo_instructions = {
            type: 'instructions',
            pages: [
              "<p> Hmm...Based on one or more of your answers to the previous questions, it looks as if you may not fully understand the task. </p>" +
              "<p> If you are unable to answer the questions correctly again, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
              "<p> Please click 'Next' to return to the instructions. </p>"

            ],
            show_clickable_nav: true,
            on_finish: function(data) {
              jsPsych.data.addDataToLastTrial({
                exp_stage:"instruction_fail_first",
                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                exp_part: "instructions"
              })
            },
        };

        // what they see if they answered one or both of the questions incorrectly more than once
        var failed_instructions = {
            type: 'instructions',
            pages: [
              "<p> We're sorry, it appears as if you have failed to answer one or both of the instruction comprehension questions twice. </p>" +
              "<p> You may not receive a bonus payment for this task </p>" +
              "<p> <b> If you fail to answer the instruction comprehension questions a third time you may be asked to leave the study. </b></p>"
            ],
            show_clickable_nav: true,
            on_finish: function(data) {
              jsPsych.data.addDataToLastTrial({
                exp_stage:"instruction_fail_again",
                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                exp_part: "instructions"
              })
            },
        };

        // evaluates question responses and loops timeline if questions are incorrect (part 3)
        // Note: you need all three parts (next two follow) for this function to work
        var instructions_understood3 = {
            timeline: [failed_instructions, instructions, instruction_questions],
            conditional_function:   function() {
                var dat = jsPsych.data.getLastTrialData().values()[0];
                var dat1 = jsPsych.data.getLastTrialData().values()[1];
                var answer1 = JSON.parse(dat.responses).Q0;
                var answer2 = JSON.parse(dat.responses).Q1;
                if(answer1.includes('click') == true && answer2.includes('outcome') == true) {
                    return false;
                } else {
                    return true;
                }
              },
          };

        // evaluates question responses and loops timeline if questions are incorrect (part 2)
        var instructions_understood2 = {
            timeline: [failed_instructions, instructions, instruction_questions, instructions_understood3],
            conditional_function:   function() {
                var dat = jsPsych.data.getLastTrialData().values()[0];
                var dat1 = jsPsych.data.getLastTrialData().values()[1];
                var answer1 = JSON.parse(dat.responses).Q0;
                var answer2 = JSON.parse(dat.responses).Q1;
                if(answer1.includes('click') == true && answer2.includes('outcome') == true) {
                    return false;
                } else {
                    return true;
                }
              },
          };

        // evaluates question responses and loops timeline if questions are incorrect (part 1)
        var instructions_understood = {
            timeline: [redo_instructions, instructions, instruction_questions, instructions_understood2],
            conditional_function:   function() {
                var dat = jsPsych.data.getLastTrialData().values()[0];
                var dat1 = jsPsych.data.getLastTrialData().values()[1];
                var answer1 = JSON.parse(dat.responses).Q0;
                var answer2 = JSON.parse(dat.responses).Q1;
                if(answer1.includes('click') == true && answer2.includes('outcome') == true) {
                    return false;
                } else {
                    return true;
                }
              },
          };

        timeline.push(instructions_understood);



// helper functions

      //randomize function
        function nrand(m,sd){
            if (sd == 0) {
                return m;
            } else {
            var x1, x2, rad, y1;
            do {
                x1 = 2 * Math.random() - 1;
                x2 = 2 * Math.random() - 1;
                rad = x1 * x1 + x2 * x2;
            } while(rad >= 1 || rad == 0);

            var c = Math.sqrt(-2 * Math.log(rad) / rad);
            var y = Math.round((x1 * c * (sd^2))+m);
            return y;
            }
        };

        // generate parameters for each trial
        function gen_params(){
            var k1 = Math.floor(Math.random()*2); // machine: safe/risky
            var sd_options = [0, Math.sqrt(16)];
            var label = ["Safe", "Risky"]; // button labels
            var sd0 = Math.sqrt(100);

            var mu = nrand(0,sd0); // mean outcome
            var sd = sd_options[k1]; // 0 or 4 for sd
            var text = label[k1]; // safe or risky

            return [mu, sd, text]
        }

        // determine the colors for buttons
        function get_colors() {
            var j, x, i;
            for (i = colors.length - 1; i > 0; i--) {
                j = Math.floor(Math.random() * (i + 1));
                x = colors[i];
                colors[i] = colors[j];
                colors[j] = x;
            }
            return colors.slice(0,2);
        }

// practice trial run


        var trial_start = {
            type: 'html-button-response',
            stimulus: '<p class = "click_prompt"> Practice Trial </p>',
            choices: ['Start'],
            on_finish: function(data) {
              data.exp_stage = 'practice_start'
              trial_index =  jsPsych.data.get().last(1).values()[0].trial_index
              data.primary_key = subjectId + '_' + weekId + '_' + expId + '_' + trial_index,
              data.exp_part = "practice"
            }
        }
        timeline.push(trial_start)

        var machine1 = [0,0,0]
        var machine2 = [0,0,0]
        while (machine1[0] === machine2[0]){
          var machine1 = [nrand(0,10), 0, "Safe"]
          var machine2 = [nrand(0,10), 4, "Risky"]
        }

        colors_oi = get_colors()

        trial_procedure = []
        for (var j = 0; j < n_trials; j++){
            var stimulus = {
                type: 'html-button-response',
                button_html: ['<button class="jspsych-btn-machine", style = "background-color:' + colors_oi[0] + '">%choice%</button>',
                                '<button class="jspsych-btn-machine", style = "background-color:' + colors_oi[1] + '">%choice%</button>'],
                stimulus: '<p class ="click_prompt">Choose the slot machine you want to play! </p>',
                choices: [machine1[2], machine2[2]],
                prompt: '',
                data: {
                    machine1_type:machine1[2],
                    mean1: machine1[0],
                    reward1: nrand(machine1[0],machine1[1]),
                    machine2_type:machine2[2],
                    reward2: nrand(machine2[0],machine2[1]),
                    mean2: machine2[0],
                    block: 'block_p'
                  },
                on_finish: function(data){

                  if (data.machine1_type == "Risky" && data.machine2_type == "Safe") {
                    data.cond = 1
                  } else if (data.machine1_type == "Safe" && data.machine2_type == "Risky"){
                    data.cond = 2
                  } else if (data.machine1_type == "Risky" && data.machine2_type == "Risky") {
                    data.cond = 3
                  } else if (data.machine1_type == "Safe" && data.machine2_type == "Safe") {
                    data.cond = 4
                  }


                  data.exp_stage = 'practice_choice'
                  trial_index = jsPsych.data.get().last(1).values()[0].trial_index
                  data.primary_key = subjectId + '_' + weekId + '_' + expId + '_' + trial_index,
                  data.exp_part = "practice"

                  if (data.button_pressed == 0) {
                    chosen_machine = "machine1"
                  } else if (data.button_pressed == 1) {
                    chosen_machine = "machine2"
                  }
                  data.chosen_machine = chosen_machine

                  if (chosen_machine == "machine1") {
                    reward = data.reward1
                    data.reward = reward
                  } else if (chosen_machine = "machine2") {
                    reward = data.reward2
                    data.reward = reward
                  }

                  if (data.reward1 > data.reward2 & chosen_machine == "machine1") {
                    correct = true
                    data.correct = true
                  } else if (data.reward2 > data.reward1 & chosen_machine == "machine2") {
                    correct = true
                    data.correct = true
                  } else {
                    data.correct = false
                  }

                    curr_bonus = trial_points*bonus_scaler
                    trial_coins = trial_coins + data.reward

                    if (data.mean1 > data.mean2){
                      data.correct_choice = 'machine1'
                    }
                    else {
                      data.correct_choice = 'machine2'
                    }
                }
            };

            // feedback function
            var feedback = {
              type: 'html-keyboard-response',
              choices: jsPsych.NO_KEYS,
              trial_duration: 1000,
              stimulus: function(){
                reward = jsPsych.data.get().last(1).values()[0].reward

                if (reward > 0){
                  return '<p class="reward"><font color="green"> + '+reward+'</font></p>' + '<p> Current Coins: ' + trial_coins + '</p>'
                } else if (reward < 0){
                  return '<p class="reward"><font color="red"> - '+Math.abs(reward)+'</font></p>' + '<p> Current Coins: ' + trial_coins + '</p>'
                }
                else{
                  return '<p class="reward"><font color="dimgray"> '+reward+'</font></p>' + '<p> Current Coins: ' + trial_coins + '</p>'
                }
              },
              on_finish: function(data) {

                if (jsPsych.data.get().last(2).values()[0].machine1_type == "Risky" && jsPsych.data.get().last(2).values()[0].machine2_type == "Safe") {
                  data.cond = 1
                } else if (jsPsych.data.get().last(2).values()[0].machine1_type == "Safe" && jsPsych.data.get().last(2).values()[0].machine2_type == "Risky"){
                  data.cond = 2
                } else if (jsPsych.data.get().last(2).values()[0].machine1_type == "Risky" && jsPsych.data.get().last(2).values()[0].machine2_type == "Risky") {
                  data.cond = 3
                } else if (jsPsych.data.get().last(2).values()[0].machine1_type == "Safe" && jsPsych.data.get().last(2).values()[0].machine2_type == "Safe") {
                  data.cond = 4
                }

                data.block = "block_p"
                data.exp_stage = 'practice_feedback'
                trial_index = jsPsych.data.get().last(1).values()[0].trial_index
                data.primary_key = subjectId + '_' + weekId + '_' + expId + '_' + trial_index
                data.exp_part = "practice"

              }
            };

            trial_procedure.push(stimulus,feedback)
            timeline.push(stimulus,feedback)
            }


        var end_trial = {
          type: 'html-keyboard-response',
          stimulus: '<p>This marks the end of the Practice Trial.</p> <p>Press any key to continue to the main experiment.</p>',
          on_finish: function(data) {
            num_corr = jsPsych.data.get().last(2*n_trials+1).filter({exp_stage: 'practice_choice', correct: true}).count()
            data.error_block = 1 - (num_corr/n_trials)

            jsPsych.data.addDataToLastTrial({
              exp_stage:"practice_end",
              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
              suspicious: false,
              block: 'block_p',
              exp_part: "practice"
            })
          }
        }

        // evaluates if there was any suspicious behavior - clicking all one thing, or getting a low score - now we're adjusting it so that it's only that they have to click at least each button once
        // (getting rid of error rate) - 9/24/19

        var no_sus = {
          timeline: [end_trial],
          conditional_function:   function(data) {
              num_machine1 = jsPsych.data.get().last(2*n_trials+1).filter({exp_stage: 'practice_choice', chosen_machine: 'machine1'}).count()
              correct_oi = jsPsych.data.get().last(2*n_trials+1).filter({exp_stage: 'practice_choice', correct: true}).count()
              error_rate = 1 - (correct_oi/(n_trials))

              if (num_machine1 == n_trials || num_machine1 == 0){
                return false;
              }
              // else
              // if (error_rate >= error_rate_cap){
              //   return false;
              // }
              else{
                return true
              }
            }
        };
        timeline.push(no_sus);

        // First warning for suspicious trial
        var sus_1 = {
          type: 'instructions',
          pages: function(data){
            num_machine1 = jsPsych.data.get().last(2*n_trials+1).filter({chosen_machine: 'machine1'}).count()

            if (num_machine1 == n_trials || num_machine1 == 0){
              return [
                "<p align='left'> Hmm... You only ever played one machine. It looks as if you may not fully understand the task. </p>" +
                "<p align='left'> If you are unable to better perform in the practice trial a second time, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
                "<p align='left'> Please click 'Next' to return to the instructions. </p>"
              ]
            }
            else {
              return [
                "<p align='left'> Hmm... Your choices of machines to play indicates that you may not fully understand the task at hand. </p>" +
                "<p align='left'> If you are unable to better perform in the practice trial a second time, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
                "<p align='left'> Please click 'Next' to return to the instructions. </p>"
              ]
            }

          },
          show_clickable_nav: true,
          on_finish: function(data){
            data.primary_key =  subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
            data.suspicious = true
            data.block = 'block_p'
            data.exp_part = 'practice'

            num_corr = jsPsych.data.get().last(2*n_trials+1).filter({exp_stage: 'practice_choice', correct: true}).count()
            data.error_block = 1 - (num_corr/n_trials)

            data.exp_stage = "practice_suspicion_flag"
            if (num_machine1 == n_trials || num_machine1 == 0){
              data.suspicious_type = 'all_one'
            }
            else {
              data.suspicious_type = 'error_rate'
            }

          }
        }

        // second warning for suspicious trial
        var sus_2 = {
          type: 'instructions',
          pages: function(data){
            num_machine1 = jsPsych.data.get().last(2*n_trials+1).filter({chosen_machine: 'machine1'}).count()

            if (num_machine1 == n_trials || num_machine1 == 0){
              return [
                "<p align='left'> Hmm... You only ever played one machine. It looks as if you may not fully understand the task. </p>" +
                "<p align='left'> If you are unable to better perform in the practice trial a third time, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
                "<p align='left'> Please click 'Next' to return to the instructions. </p>"
              ]
            }
            else {
              return [
                "<p align='left'> Hmm... Your choices of machines to play indicates that you may not fully understand the task at hand. </p>" +
                "<p align='left'> If you are unable to better perform in the practice trial a third time, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
                "<p align='left'> Please click 'Next' to return to the instructions. </p>"
              ]
            }

          },
          show_clickable_nav: true,
          on_finish: function(data){
            data.primary_key =  subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
            data.suspicious = true
            data.block = 'block_p'
            data.exp_part = 'practice'

            num_corr = jsPsych.data.get().last(2*n_trials+1).filter({exp_stage: 'practice_choice', correct: true}).count()
            data.error_block = 1 - (num_corr/n_trials)

            data.exp_stage = "practice_suspicion_flag"
            if (num_machine1 == n_trials || num_machine1 == 0){
              data.suspicious_type = 'all_one'
            }
            else {
              data.suspicious_type = 'error_rate'
            }

          }
        }

        // third and final warning for suspicious trial
        var final_bad = {
          type: 'instructions',
          pages: function(data){
            num_machine1 = jsPsych.data.get().last(2*n_trials+1).filter({chosen_machine: 'machine1'}).count()
            return [
              "<p align='left'> We're sorry, it appears as if you still do not fully understand the task. </p>" +
              "<p align='left'> We reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
              "<p align='left'> Please click 'Next' to begin the main task. </p>"
            ]

          },
          show_clickable_nav: true,
          on_finish: function(data){
            data.primary_key =  subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
            data.suspicious = true
            data.block = 'block_p'
            data.exp_part = 'practice'

            num_corr = jsPsych.data.get().last(2*n_trials+1).filter({exp_stage: 'practice_choice', correct: true}).count()
            data.error_block = 1 - (num_corr/n_trials)

            data.exp_stage = "practice_suspicion_flag"
            if (num_machine1 == n_trials || num_machine1 == 0){
              data.suspicious_type = 'all_one'
            }
            else {
              data.suspicious_type = 'error_rate'
            }

          }
        }

        // evaluates if third warning/redo trial is necessary based on if they chose all the same thing (or if the error rate was high - removed)
        var sus_procedure3 = {
          timeline: [final_bad],
          data: {exp_part: 'practice'},
          conditional_function:   function() {
            num_machine1 = jsPsych.data.get().last(2*n_trials+1).filter({chosen_machine: 'machine1'}).count()
            correct_oi = jsPsych.data.get().last(2*n_trials+1).filter({correct: true}).count()
            error_rate = 1 - (correct_oi/(2*n_trials))

            if (num_machine1 == n_trials || num_machine1 == 0){
              return true;
            }
            else if (error_rate >= error_rate_cap){
              return true;
            }
            else{
              return false
            }
            },

        }

        todo2 = [sus_2].concat(trial_procedure)
        todo2 = todo2.concat([no_sus, sus_procedure3])

        var sus_procedure2 = {
            timeline: todo2,
            data: {exp_part: 'practice'},
            conditional_function:   function() {
              num_machine1 = jsPsych.data.get().last(2*n_trials+1).filter({chosen_machine: 'machine1'}).count()
              correct_oi = jsPsych.data.get().last(2*n_trials+1).filter({correct: true}).count()
              error_rate = 1 - (correct_oi/(2*n_trials))

              if (num_machine1 == n_trials || num_machine1 == 0){
                return true;
              }
              // else if (error_rate >= error_rate_cap){
              //   return true;
              // }
              else{
                return false
              }
              },
          };

        todo1 = [sus_1].concat(trial_procedure)
        todo1 = todo1.concat([no_sus, sus_procedure2])

        var sus_procedure = {
            timeline: todo1,
            data: {exp_part: 'practice'},
            conditional_function:   function() {
              num_machine1 = jsPsych.data.get().last(2*n_trials+1).filter({chosen_machine: 'machine1'}).count()
              correct_oi = jsPsych.data.get().last(2*n_trials+1).filter({correct: true}).count()
              error_rate = 1 - (correct_oi/(2*n_trials))

              if (num_machine1 == n_trials || num_machine1 == 0){
                return true;
              }
              // else
              // if (error_rate >= error_rate_cap){
              //   return true;
              // }
              else{
                return false;
                // timeline: [end_trial]
              }
              },
          };

        timeline.push(sus_procedure);


// main experiment

        for (var i = 1; i < n_games+1; i++){
            var new_game = {
                type: 'html-button-response',
                stimulus: '<p class = "click_prompt"> Game ' + i + ' out of ' + n_games + '</p>',
                choices: ['Start'],
                on_finish: function(data) {
                  data.exp_stage = 'block_start'
                  trial_index = jsPsych.data.get().last(1).values()[0].trial_index
                  data.primary_key = subjectId + '_' + weekId + '_' + expId + '_' + trial_index
                  data.exp_part = 'main'

                }
            }
            timeline.push(new_game)

            var machine1 = [0,0,0]
            var machine2 = [0,0,0]
            while (machine1[0] === machine2[0]){
              var machine1 = gen_params()
              var machine2 = gen_params()
            }

            colors_oi = get_colors()

            for (var j = 0; j < n_trials; j++){
                var stimulus = {
                    type: 'html-button-response',
                    button_html: ['<button class="jspsych-btn-machine", style = "background-color:' + colors_oi[0] + '">%choice%</button>',
                                '<button class="jspsych-btn-machine", style = "background-color:' + colors_oi[1] + '">%choice%</button>'],
                    stimulus: '<p class="click_prompt"> Choose one by clicking </p>',
                    choices: [machine1[2], machine2[2]],
                    prompt: "",
                    data: {
                      machine1_type:machine1[2],
                      mean1: machine1[0],
                      reward1: nrand(machine1[0],machine1[1]),
                      machine2_type:machine2[2],
                      mean2: machine2[0],
                      reward2: nrand(machine2[0],machine2[1]),
                      block:"block_"+i
                      },
                    on_finish: function(data){

                        if (data.machine1_type == "Risky" && data.machine2_type == "Safe") {
                          data.cond = 1
                        } else if (data.machine1_type == "Safe" && data.machine2_type == "Risky"){
                          data.cond = 2
                        } else if (data.machine1_type == "Risky" && data.machine2_type == "Risky") {
                          data.cond = 3
                        } else if (data.machine1_type == "Safe" && data.machine2_type == "Safe") {
                          data.cond = 4
                        }

                        data.exp_stage = 'main_choice'
                        trial_index = jsPsych.data.get().last(1).values()[0].trial_index
                        data.primary_key = subjectId + '_' + weekId + '_' + expId + '_' + trial_index
                        data.exp_part = 'main'

                        if (data.button_pressed == 0) {
                          chosen_machine = "machine1"
                        } else if (data.button_pressed == 1) {
                          chosen_machine = "machine2"
                        }
                        data.chosen_machine = chosen_machine

                        if (chosen_machine == "machine1") {
                          reward = data.reward1
                          data.reward = reward
                        } else if (chosen_machine = "machine2") {
                          reward = data.reward2
                          data.reward = reward
                        }

                        if (data.reward1 > data.reward2 & chosen_machine == "machine1") {
                          correct = true
                          data.correct = true
                          main_points = main_points + 1
                        } else if (data.reward2 > data.reward1 & chosen_machine == "machine2") {
                          correct = true
                          data.correct = true
                          main_points = main_points + 1
                        } else {
                          data.correct = false
                        }

                        data.curr_bonus = main_points*bonus_scaler
                        main_coins = main_coins + data.reward

                        if (data.mean1 > data.mean2){
                          data.correct_choice = 'machine1'
                        }
                        else {
                          data.correct_choice = 'machine2'
                        }

                        if (data.chosen_machine == data.correct_choice){
                          data.trial_bonus = bonus_scaler
                        } else {
                          data.trial_bonus = "0"
                        }
                    }
                };


                var feedback = {
                  type: 'html-keyboard-response',
                  choices: jsPsych.NO_KEYS,
                  trial_duration: 500,
                  stimulus: function(){
                    reward = jsPsych.data.get().last(1).values()[0].reward
                    fb_block = jsPsych.data.getLastTrialData().values()[0].block
                    if (reward > 0){
                      return '<p class="reward"><font color="green"> + '+reward+'</font></p>' + '<p> Current Coins: ' + main_coins + '</p>'
                    } else if (reward < 0){
                      return '<p class="reward"><font color="red"> - '+Math.abs(reward)+'</font></p>' + '<p> Current Coins: ' + main_coins + '</p>'
                    }
                    else{
                      return '<p class="reward"><font color="dimgray"> '+reward+'</font></p>' + '<p> Current Coins: ' + main_coins + '</p>'
                    }
                  },
                  data: {block:"block_"+i},
                  on_finish: function(data) {

                    if (jsPsych.data.get().last(2).values()[0].machine1_type == "Risky" && jsPsych.data.get().last(2).values()[0].machine2_type == "Safe") {
                      data.cond = 1
                    } else if (jsPsych.data.get().last(2).values()[0].machine1_type == "Safe" && jsPsych.data.get().last(2).values()[0].machine2_type == "Risky"){
                      data.cond = 2
                    } else if (jsPsych.data.get().last(2).values()[0].machine1_type == "Risky" && jsPsych.data.get().last(2).values()[0].machine2_type == "Risky") {
                      data.cond = 3
                    } else if (jsPsych.data.get().last(2).values()[0].machine1_type == "Safe" && jsPsych.data.get().last(2).values()[0].machine2_type == "Safe") {
                      data.cond = 4
                    }
                    data.exp_stage = 'main_feedback'
                    trial_index = jsPsych.data.get().last(1).values()[0].trial_index
                    data.primary_key = subjectId + '_' + weekId + '_' + expId + '_' + trial_index
                    data.exp_part = 'main'


                  }
                }
                timeline.push(stimulus,feedback)
            }
            var end_game = {
                type: 'html-button-response',
                stimulus: '<p class = "click_prompt"> End of Game ' + i + '</p> <p> Generating new machines for the next game! </p>',
                choices: ['Continue'],
                on_finish: function(data) {
                  block_oi = jsPsych.data.get().last(3).values()[0].block
                  num_machine1 = jsPsych.data.get().filter({chosen_machine: 'machine1', block: block_oi}).count()

                  ttl_correct = jsPsych.data.get().filter({chosen_machine: 'machine1', correct_choice: 'machine1', block: block_oi}).count()
                  ttl_correct = ttl_correct + jsPsych.data.get().filter({chosen_machine: 'machine2', correct_choice: 'machine2', block: block_oi}).count()
                  error_rate = 1 - (ttl_correct/n_trials)

                  data.error_block = error_rate

                  if (num_machine1 == n_trials || num_machine1 == 0){
                    data.suspicious = true
                    data.suspicious_type = 'all_one'
                  }
                  else if (error_rate >= error_rate_cap){
                    data.suspicious = true
                    data.suspicious_type = 'error_rate'
                  }
                  else{
                    data.suspicious = 'false'
                  }

                  data.exp_stage = 'between_block'
                  trial_index = jsPsych.data.get().last(1).values()[0].trial_index
                  data.primary_key = subjectId + '_' + weekId + '_' + expId + '_' + trial_index
                  data.exp_part = 'main'


                }
            }
            // }
        }

// end of task - bonus feedback

        var bonus_block = {
          type: 'html-keyboard-response',
          stimulus: function(data){
                    rounded_bonus = Math.round(jsPsych.data.get().last(2).values()[0].curr_bonus)
                    if (rounded_bonus < min_bonus){
                      rounded_bonus = min_bonus
                    }
                    return '<p>This marks the end of the experiment.</p>' +
                    '<p>You earned <b>' + rounded_bonus + ' points </b>!</p>' +
                    '<p>Thank you so much for your participation.</p>' +
                    '<p>Press any key to continue to the feedback survey.</p>'
                  },
          on_finish: function(data) {
            block_oi = jsPsych.data.get().last(3).values()[0].block
            num_machine1 = jsPsych.data.get().filter({chosen_machine: 'machine1', block: block_oi}).count()

            ttl_correct = jsPsych.data.get().filter({chosen_machine: 'machine1', correct_choice: 'machine1', block: block_oi}).count()
            ttl_correct = ttl_correct + jsPsych.data.get().filter({chosen_machine: 'machine2', correct_choice: 'machine2', block: block_oi}).count()
            error_rate = 1 - (ttl_correct/n_trials)

            data.error_block = error_rate

            if (num_machine1 == n_trials || num_machine1 == 0){
              data.suspicious = true
              data.suspicious_type = 'all_one'
            }
            else if (error_rate >= error_rate_cap){
              data.suspicious = true
              data.suspicious_type = 'error_rate'
            }
            else{
              data.suspicious = 'false'
            }

            data.exp_stage = 'end_bonus'
            trial_index = jsPsych.data.get().last(1).values()[0].trial_index
            data.primary_key = subjectId + '_' + weekId + '_' + expId + '_' + trial_index
            data.exp_part = 'main'


          }
        }

        timeline.push(bonus_block);
// feedback timelines

        // suspicious

        var fb_warning_ss = {
            type: 'instructions',
            pages: [
              "<p align='left'> This task has several built in alarms that signal when a worker may be trying to 'trick' at a task" +
              "<p align='left'> (i.e. by selecting the same answer every time, or never answering at all). " +
              "<p align='left'>  Something about your responses for part or all of this task has triggered one of these alarms." ,

              "<p align='left'>  Your bonus will be witheld until an experimenter can manually review your answers to check if there was a mistake on our end, or if you did try to 'trick' the task." +
              "<p align='left'>  In the following feedback survey, you will have the chance to explain anything that may have made your answers appear irregular. " +
              "<p align='left'>  In the event that an honest mistake was made or our code was incorrect, you will receive your bonus as planned" +
              "<p align='left'>  However, if it appears that you tried to 'trick' the system, we reserve the right to withold your bonus, and if cheating behavior continues you will be asked to leave the study."
                ],
             show_clickable_nav: true,
             on_finish: function(data) {
              jsPsych.data.addDataToLastTrial({
                fb_type: "suspicious",
                exp_stage:"feedback_warning",
                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                exp_part: "feedback"
              })
            }
          };

        // first question - tech problems
              var fb_q1_ss = {
                  type: 'survey-multi-choice',
                  preamble: '<h4> Feedback Survey 1/4 </h4>', // +
                  questions: [
                    {prompt: "Did you experience any technological issues during this task?   (i.e. experiment glitch, accidentally closed window, mixed up keys, etc.) <br>  If you answer 'Yes' or 'I am unsure' you will have the opportunity to explain",
                      options: [" Yes", " No", " I am unsure"],
                      // horizontal: true,
                      required: true,
                      name: 'tech problems'},
                      ],
                      on_finish: function(data){
                        var dat1 = jsPsych.data.getLastTrialData().values()[0];
                        var answer1 = JSON.parse(dat1.responses).Q0;
                        if(answer1.includes('Yes') == true || answer1.includes('unsure')) {
                          jsPsych.data.addDataToLastTrial({
                            fb_type: "suspicious",
                            fb_issue:'tech',
                            exp_stage:"feedback_tech",
                            primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                            exp_part: "feedback"
                          })
                        } else {
                          jsPsych.data.addDataToLastTrial({
                            fb_type: "suspicious",
                            exp_stage:"feedback_tech",
                            primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                            exp_part: "feedback"
                          })
                        }
                      }
                  };

            // first question - tech problems - if yes, please explain
              var fb_q1_follow_ss = {
                  type: 'survey-text',
                  preamble: '<h4> Feedback Survey 1/4 </h4>', // +
                  questions: [
                    {prompt: "Please tell us about the technical difficulties you experienced: ",
                      required: true,
                      name: 'tech problems follow up'},
                      ],
                      on_finish: function(data){
                        var dat1 = jsPsych.data.getLastTrialData().values()[0];
                        var answer1 = JSON.parse(dat1.responses).Q0;
                        jsPsych.data.addDataToLastTrial({
                          fb_type: "suspicious",
                          fb_issue: 'tech',
                          fb_issue_txt: answer1,
                          exp_stage:"feedback_tech_followup",
                          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                          exp_part: "feedback"
                        })
                      }
                  };

            // determines if subject answered yes, and explanation is required
              var fb_q1_eval_ss = {
                  timeline: [fb_q1_follow_ss],
                  conditional_function:   function() {
                      var dat1 = jsPsych.data.getLastTrialData().values()[0];
                      var answer1 = JSON.parse(dat1.responses).Q0;
                      if(answer1.includes('Yes') == true || answer1.includes('unsure')) {
                          return true;
                      } else {
                          return false;
                      }
                    },
                };


        // second question - distractions
              var fb_q2_ss = {
                  type: 'survey-multi-choice',
                  preamble: '<h4> Feedback Survey 2/4 </h4>', // +
                  questions: [{
                      prompt: "Did you experience any major distractions or interruptions during this task? <br> If you answer 'Yes' you will have the opportunity to explain",
                      options: [" Yes", " No"],
                      required: true,
                      name: 'distractions'
                    },
                  ],
                  on_finish: function(data){
                    var dat2 = jsPsych.data.getLastTrialData().values()[0];
                    var answer2 = JSON.parse(dat2.responses).Q0;
                    if(answer2.includes('Yes') == true) {
                      jsPsych.data.addDataToLastTrial({
                        fb_type: "suspicious",
                        fb_issue:'distraction',
                        exp_stage:"feedback_distraction",
                        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                        exp_part: "feedback"
                      })
                    } else {
                      jsPsych.data.addDataToLastTrial({
                        fb_type: "suspicious",
                        exp_stage:"feedback_distraction",
                        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                        exp_part: "feedback"
                      })
                    }
                  }
                };

            // second question - distractions - if yes, please explain
              var fb_q2_follow_ss = {
                  type: 'survey-text',
                  preamble: '<h4> Feedback Survey 2/4 </h4>', // +
                  questions: [
                    {prompt: "Please describe how the distraction may have effected your performance, and if possible, at what point in the task this distraction occured:",
                      name: 'tech problems follow up'},
                      ],
                      on_finish: function(data){
                        var dat2 = jsPsych.data.getLastTrialData().values()[0];
                        var answer2 = JSON.parse(dat2.responses).Q0;
                        jsPsych.data.addDataToLastTrial({
                          fb_type: "suspicious",
                          fb_issue: 'distraction',
                          fb_issue_txt: answer2,
                          exp_stage:"feedback_distraction_followup",
                          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                          exp_part: "feedback"
                        })
                      }
                  };

            // determines if subject answered yes, and explanation is required
              var fb_q2_eval_ss = {
                  timeline: [fb_q2_follow_ss],
                  conditional_function:   function() {
                      var dat2 = jsPsych.data.getLastTrialData().values()[0];
                      var answer2 = JSON.parse(dat2.responses).Q0;
                      if(answer2.includes('Yes') == true) {
                          return true;
                      } else {
                          return false;
                      }
                    },
                };


        // third question: engagement
              var fb_q3_ss = {
                  type: 'survey-multi-choice',
                  preamble: '<h4> Feedback Survey 3/4 </h4>', // +
                  questions: [{
                      prompt: "On the following scale from 1 to 4, how engaging (attention holding) did you find this task?",
                      options: [" 1 - Not at all engaging", " 2 - Somewhat not engaging", " 3 - Somewhat engaging", " 4 - Very engaging"],
                      required: true,
                      name: 'engagement'
                    },
                  ],
                      on_finish: function(data){
                        var dat3 = jsPsych.data.getLastTrialData().values()[0];
                        var answer3 = JSON.parse(dat3.responses).Q0;
                        jsPsych.data.addDataToLastTrial({
                          fb_type: "suspicious",
                          fb_engagement: answer3,
                          exp_stage:"feedback_engaged",
                          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                          exp_part: "feedback"
                        })
                      }
                  };

        // fourth question: anything else
              var fb_q4_ss = {
                  type: 'survey-text',
                  preamble: '<h4> Feedback Survey 4/4 </h4>', // +
                  questions: [{
                      prompt: "Is there anything else you would like us to know? <br> (Can be a specific concern or general suggestion for improvement)",
                      name: 'anything else'
                    },
                  ],
                      on_finish: function(data){

                        var interaction_data = jsPsych.data.getInteractionData();
                        data.screen = interaction_data.json();

                        var dat4 = jsPsych.data.getLastTrialData().values()[0];
                        var answer4 = JSON.parse(dat4.responses).Q0;
                        if (answer4 == ''){
                          jsPsych.data.addDataToLastTrial({
                          fb_type: "suspicious",
                          exp_stage:"feedback_other",
                          fb_type: "suspicious",
                          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                          exp_part: "feedback"
                        })
                      } else {
                        jsPsych.data.addDataToLastTrial({
                          fb_type: "suspicious",
                          fb_issue: 'other',
                          fb_issue_txt: answer4,
                          exp_stage:"feedback_other",
                          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                          exp_part: "feedback"
                          })
                        }
                      }
                  };

        // conclusion
              var fb_end_exp_ss = {
                type: 'html-keyboard-response',
                stimulus: '<p>Thank you! This marks the end of the feeback survey.</p>' +
                          ' <p>Press any key to return to the dashboard where you may take a pause before the next game.</p>',
                on_finish: function(data) {

                  var interaction_data = jsPsych.data.getInteractionData();
                  data.screen = interaction_data.json();

                  jsPsych.data.addDataToLastTrial({
                    fb_type: "suspicious",
                    exp_stage:"exp_end",
                    primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                    exp_part: "feedback"
                  })
                }
              };


        // not suspicious

        var fb_warning_ns = {
            type: 'instructions',
            pages: [
              "<p align='left'> This task has several built in alarms that signal when a worker may be trying to 'trick' at a task" +
              "<p align='left'> (i.e. by selecting the same answer every time, or never answering at all). " +
              "<p align='left'> Your responses will be manually reviewed by a researcher, however it appears you have performed the task with sincere effort. Thank you!" ,

              "<p align='left'>  In the following feedback survey, you will have the chance to explain anything that may have made your answers appear irregular. " +
              "<p align='left'>  In the event that an honest mistake was made or our code was incorrect, you will receive your bonus as planned" +
              "<p align='left'>  However, if in review it appears that you tried to 'trick' the system, we reserve the right to withold your bonus, and if cheating behavior continues you will be asked to leave the study."
                ],
             show_clickable_nav: true,
             on_finish: function(data) {
              jsPsych.data.addDataToLastTrial({
                fb_type: "nonsuspicious",
                exp_stage:"feedback_warning",
                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                exp_part: "feedback"
              })
            }
          };

        // first question - tech problems
            var fb_q1_ns = {
                type: 'survey-multi-choice',
                preamble: '<h4> Feedback Survey 1/4 </h4>' +
                          "<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
                questions: [
                  {prompt: "Did you experience any technological issues during this task?   (i.e. experiment glitch, accidentally closed window, mixed up keys, etc.) <br>  If you answer 'Yes' or 'I am unsure' you will have the opportunity to explain",
                    options: [" Yes", " No", " I am unsure"],
                    // horizontal: true,
                    required: true,
                    name: 'tech problems'},
                    ],
                    on_finish: function(data){
                      var dat1 = jsPsych.data.getLastTrialData().values()[0];
                      var answer1 = JSON.parse(dat1.responses).Q0;
                      if(answer1.includes('Yes') == true || answer1.includes('unsure')) {
                        jsPsych.data.addDataToLastTrial({
                          fb_type: "nonsuspicious",
                          fb_issue:'tech',
                          exp_stage:"feedback_tech",
                          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                          exp_part: "feedback"
                        })
                      } else {
                        jsPsych.data.addDataToLastTrial({
                          fb_type: "nonsuspicious",
                          exp_stage:"feedback_tech",
                          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                          exp_part: "feedback"
                        })
                      }
                    }
                };

            // first question - tech problems - if yes, please explain
            var fb_q1_follow_ns = {
                type: 'survey-text',
                preamble: '<h4> Feedback Survey 1/4 </h4>' +
                          "<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
                questions: [
                  {prompt: "Please tell us about the technical difficulties you experienced: ",
                    required: true,
                    name: 'tech problems follow up'},
                    ],
                    on_finish: function(data){
                      var dat1 = jsPsych.data.getLastTrialData().values()[0];
                      var answer1 = JSON.parse(dat1.responses).Q0;
                      jsPsych.data.addDataToLastTrial({
                        fb_type: "nonsuspicious",
                        fb_issue: 'tech',
                        fb_issue_txt: answer1,
                        exp_stage:"feedback_tech_followup",
                        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                        exp_part: "feedback"
                      })
                    }
                };

            // determines if subject answered yes, and explanation is required
            var fb_q1_eval_ns = {
                timeline: [fb_q1_follow_ns],
                conditional_function:   function() {
                    var dat1 = jsPsych.data.getLastTrialData().values()[0];
                    var answer1 = JSON.parse(dat1.responses).Q0;
                    if(answer1.includes('Yes') == true || answer1.includes('unsure')) {
                        return true;
                    } else {
                        return false;
                    }
                  },
              };


        // second question - distractions
            var fb_q2_ns = {
                type: 'survey-multi-choice',
                preamble: '<h4> Feedback Survey 2/4 </h4>' +
                          "<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
                questions: [{
                    prompt: "Did you experience any major distractions or interruptions during this task? <br> If you answer 'Yes' you will have the opportunity to explain",
                    options: [" Yes", " No"],
                    required: true,
                    name: 'distractions'
                  },
                ],
                on_finish: function(data){
                  var dat2 = jsPsych.data.getLastTrialData().values()[0];
                  var answer2 = JSON.parse(dat2.responses).Q0;
                  if(answer2.includes('Yes') == true) {
                    jsPsych.data.addDataToLastTrial({
                      fb_type: "nonsuspicious",
                      fb_issue:'distraction',
                      exp_stage:"feedback_distraction",
                      primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                      exp_part: "feedback"
                    })
                  } else {
                    jsPsych.data.addDataToLastTrial({
                      fb_type: "nonsuspicious",
                      exp_stage:"feedback_distraction",
                      primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                      exp_part: "feedback"

                    })
                  }
                }
              };

            // second question - distractions - if yes, please explain
            var fb_q2_follow_ns = {
                type: 'survey-text',
                preamble: '<h4> Feedback Survey 2/4 </h4>' +
                          "<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
                questions: [
                  {prompt: "Please describe how the distraction may have effected your performance, and if possible, at what point in the task this distraction occured:",
                    name: 'tech problems follow up'},
                    ],
                    on_finish: function(data){
                      var dat2 = jsPsych.data.getLastTrialData().values()[0];
                      var answer2 = JSON.parse(dat2.responses).Q0;
                      jsPsych.data.addDataToLastTrial({
                        fb_type: "nonsuspicious",
                        fb_issue: 'distraction',
                        fb_issue_txt: answer2,
                        exp_stage:"feedback_distraction_followup",
                        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                        exp_part: "feedback"
                      })
                    }
                };

            // determines if subject answered yes, and explanation is required
            var fb_q2_eval_ns = {
                timeline: [fb_q2_follow_ns],
                conditional_function:   function() {
                    var dat2 = jsPsych.data.getLastTrialData().values()[0];
                    var answer2 = JSON.parse(dat2.responses).Q0;
                    if(answer2.includes('Yes') == true) {
                        return true;
                    } else {
                        return false;
                    }
                  },
              };


        // third question: engagement
            var fb_q3_ns = {
                type: 'survey-multi-choice',
                preamble: '<h4> Feedback Survey 3/4 </h4>' +
                          "<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
                questions: [{
                    prompt: "On the following scale from 1 to 4, how engaging (attention holding) did you find this task?",
                    options: [" 1 - Not at all engaging", " 2 - Somewhat not engaging", " 3 - Somewhat engaging", " 4 - Very engaging"],
                    required: true,
                    name: 'engagement'
                  },
                ],
                    on_finish: function(data){
                      var dat3 = jsPsych.data.getLastTrialData().values()[0];
                      var answer3 = JSON.parse(dat3.responses).Q0;
                      jsPsych.data.addDataToLastTrial({
                        fb_type: "nonsuspicious",
                        fb_engagement: answer3,
                        exp_stage:"feedback_engaged",
                        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                        exp_part: "feedback"
                      })
                    }
                };

        // fourth question: anything else
            var fb_q4_ns = {
                type: 'survey-text',
                preamble: '<h4> Feedback Survey 4/4 </h4>' +
                          "<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
                questions: [{
                    prompt: "Is there anything else you would like us to know? <br> (Can be a specific concern or general suggestion for improvement)",
                    name: 'anything else'
                  },
                ],
                    on_finish: function(data){

                      var interaction_data = jsPsych.data.getInteractionData();
                      data.screen = interaction_data.json();

                      var dat4 = jsPsych.data.getLastTrialData().values()[0];
                      var answer4 = JSON.parse(dat4.responses).Q0;
                      if (answer4 == ''){
                        jsPsych.data.addDataToLastTrial({
                        fb_type: "nonsuspicious",
                        exp_stage:"feedback_other",
                        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                        exp_part: "feedback"
                      })
                    } else {
                      jsPsych.data.addDataToLastTrial({
                        fb_type: "nonsuspicious",
                        fb_issue: 'other',
                        fb_issue_txt: answer4,
                        exp_stage:"feedback_other",
                        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                        exp_part: "feedback"
                        })
                      }
                    }
                };

        // conclusion
            var fb_end_exp_ns = {
              type: 'html-keyboard-response',
              stimulus: '<p>Thank you! This marks the end of the feeback survey.</p>' +
              ' <p>Press any key to return to the dashboard where you may take a pause before the next game.</p>',
              on_finish: function(data) {

                var interaction_data = jsPsych.data.getInteractionData();
                data.screen = interaction_data.json();

                jsPsych.data.addDataToLastTrial({
                  exp_stage:"exp_end",
                  primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                  exp_part: "feedback"
                })
              }
            };


    // evaluate whether any of the responses were suspicious and provide appropriate quiz
            var eval_ss_timeline = {
              timeline: [fb_warning_ss, fb_q1_ss, fb_q1_eval_ss, fb_q2_ss, fb_q2_eval_ss, fb_q3_ss, fb_q4_ss, fb_end_exp_ss],
              // timeline: [fb_warning_ss, fb_q1_ss, fb_q1_eval_ss, fb_q2_ss, fb_q2_eval_ss, fb_q3_ss, fb_q4_ss],
              conditional_function: function(data) {
                sus_dat = jsPsych.data.get().filter({exp_part: 'main', suspicious: true}).count()
                if (sus_dat >= 1) {
                  return true;
                } else {
                  return false;
                }
              },
            };
            timeline.push(eval_ss_timeline);

            var eval_ns_timeline = {
              timeline: [fb_warning_ns, fb_q1_ns, fb_q1_eval_ns, fb_q2_ns, fb_q2_eval_ns, fb_q3_ns, fb_q4_ns, fb_end_exp_ns],
              // timeline: [fb_warning_ns, fb_q1_ns, fb_q1_eval_ns, fb_q2_ns, fb_q2_eval_ns, fb_q3_ns, fb_q4_ns],
              conditional_function: function(data) {
                if (sus_dat == 0) {
                  return true;
                } else {
                  return false;
                }
              },
            };
            timeline.push(eval_ns_timeline);


// Save data to CSV
                    function saveData_csv(name, data){
                      var xhr = new XMLHttpRequest();
                      xhr.open('POST', 'save_data.php');
                      xhr.setRequestHeader('Content-Type', 'application/json');
                      xhr.send(JSON.stringify({filename: name, filedata: data}));
                    }

                    /* grab data before the end of the experiment */

                    var save_data = {
                      type: 'call-function',
                      func: function(){ saveData_csv(subjectId + '_' + weekId + '_' + expId, jsPsych.data.get().csv());
                      },
                      timing_post_trial: 0,
                      on_finish: function(data) {
                        jsPsych.data.addDataToLastTrial({
                          exp_stage:"save_CSV",
                          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                          exp_part: "save"
                        })
                      }
                    };
                    timeline.push(save_data);
                    console.log('csv save successful')

//  "dashboard"

                            var dash_to_task = {
                              type: "html-button-response",
                              stimulus:
                                '<div id="blue"> ' +
                                '<div id="title">' +
                                "<h1>DASHBOARD</h1>" +
                                "<h3>If you need to take a brief rest between tasks please do so now.</h3>" +
                                "<h2>Click the button below to proceed to the next task.</h2>" +
                                "<h4>Note: you will not be paid for the time you spend on this page.</h4>" +
                                "</div> " +
                                "</div>",
                              button_html: '<button style="height:75px;width:400px;background-color:powderblue">%choice%</button>',
                              choices: ["<h1>" + nextTask_name + "</h1>"],
                              on_finish: function(data) {

                                var interaction_data = jsPsych.data.getInteractionData();
                                data.screen = interaction_data.json();

                                jsPsych.data.addDataToLastTrial({
                                  exp_stage:"dashboard",
                                  primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                                  task_selected: nextTask_Id,
                                  exp_part: "dash"
                                })
                              }
                            }
                            timeline.push(dash_to_task)


// // database save

                      function saveData() {
                        var xhr = new XMLHttpRequest();
                        xhr.open('POST', 'write_data_smb.php'); // change 'write_data.php' to point to php script.
                        xhr.setRequestHeader('Content-Type', 'application/json');
                        xhr.onload = function() {
                          console.log('xhr response text coming up')
                          console.log(xhr.responseText);
                          if(xhr.status == 200){
                            var response = JSON.parse(xhr.responseText);
                            console.log(xhr.responseText);
                            console.log(response.success);
                          }
                        };
                        xhr.send(jsPsych.data.get().json());
                        console.log('function finished well')
                      };

                      var db_save = {
                      type: 'call-function',
                      func: saveData,
                      on_finish: function(data) {
                        // jsPsych.data.get().localSave('csv','smb_0.csv');
                        jsPsych.data.addDataToLastTrial({
                          exp_stage:"save_database",
                          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                          exp_part: "save"
                          })
                        }
                      };
                      timeline.push(db_save)

// saving time
                      var save_wait_1 = {
                        type: 'html-keyboard-response',
                        stimulus: "<p> You're doing great!</p>" +
                        '<p> Please wait about 30 seconds while we save your data and load the next game.</p>' +
                        '<p> You will be automatically redirected to the next page momentarily.</p>',
                        choices: [jsPsych.NO_KEYS],
                        trial_duration: 30000,
                        response_ends_trial: false,
                        on_finish: function(data) {
                          jsPsych.data.addDataToLastTrial({
                            exp_stage:"data_saving",
                            primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                            exp_part: "save"
                          })
                        }
                      };
                      timeline.push(save_wait_1)


                    // data saving + compensation code
                      // var save_wait_1 = {
                      //   type: 'html-keyboard-response',
                      //   stimulus: '<p> Thank you for your participation!</p>' +
                      //   '<p> Please wait several moments while your data is saving.</p>',
                      //   choices: [jsPsych.NO_KEYS],
                      //   trial_duration: 3000,
                      //   response_ends_trial: false,
                      //   on_finish: function(data) {
                      //     jsPsych.data.addDataToLastTrial({
                      //       exp_stage:"data_saving",
                      //       primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                      //       exp_part: "save"
                      //     })
                      //   }
                      // };
                      //
                      //
                      // var save_wait_2 = {
                      //   type: 'html-button-response',
                      //   stimulus: '<p> Your data has been saved!</p>' +
                      //   '<p> You may click the button below to proceed to your compensation code. </p>',
                      //   choices: ['Ready'],
                      //   response_ends_trial: true,
                      //   on_finish: function(data) {
                      //     jsPsych.data.addDataToLastTrial({
                      //       exp_stage:"data_saved",
                      //       primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
                      //     })
                      //   }
                      // };
                      //
                      // var comp_code = {
                      //   type: 'html-keyboard-response',
                      //   stimulus: '<p> Your compensation code is</p>' + comp_code + '<p> Press any key to finish the experiment </p>',
                      //   response_ends_trial: true,
                      //   on_finish: function(data) {
                      //     jsPsych.data.addDataToLastTrial({
                      //       exp_stage:"comp_code",
                      //       primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
                      //     })
                      //   }
                      // };
                      //
                      // timeline.push(save_wait_1, save_wait_2, comp_code)

// init experiment

        jsPsych.init({
          timeline: timeline,
          // on_finish: saveData
          // on_finish: function() {
          //   jsPsych.data.get().localSave('csv','smb_0.csv');
          //   jsPsych.data.displayData();
          // }
          on_finish: function() {window.location.href = "nc.html" + '?workerId=' + subjectId + '&hitId=' + hitId + '&assignmentId=' + assignmentId}
        });

    </script>

</html>
