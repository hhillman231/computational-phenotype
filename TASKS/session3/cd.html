<!DOCTYPE html>
<html>

  <head>
    <title>Spot the Difference Game</title>
    <script src="jspsych-6.0.5/jspsych.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-fullscreen.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-instructions.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-survey-text.js"></script>
    <script src="jspsych-6.0.5/plugins/change_detection_plugin.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-survey-multi-choice.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-external-html.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-call-function.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    <link href="jspsych-6.0.5/css/change-detection.css" rel="stylesheet" type="text/css"></link>
    <link rel="stylesheet" href="jspsych-6.0.5/css/jspsych_nc.css"></link>
    <link rel='stylesheet' type='text/css' href='jspsych-6.0.5/css/jspsych_nc.css'>
    <link rel="stylesheet" href="jspsych-6.0.5/css/style.css"></link>
  </head>

  <body></body>

  <script>

  // to do:


// quick change variables

        comp_code = "AJFHBG897"
        // nextTask_name = "Cash Out Now or Later Survey";
        // nextTask_Id = "itc";

        reps_in_trial = 1 // = 14 because: 1 (reps_in_trial) * 2 (change/no-change) * 7 (or whateverl all_conditions.length is) so 1 * 2 * 7 = 14
        reps_in_main =  20 //20 // = 40 because 1 (reps in main) * 2 (change/no-change) = 40
        error_rate_cap = 0.3

        durations = {stim_duration: 100, between_fixation_dur: 1500} // wilken & ma

        // parameters for n=3, t=1 stimulus
        var three_t1 = [
            Object.assign({ task_type: "same", num_squares: 3, num_targets: 1, condition: 'three_t1'}, durations),
            Object.assign({ task_type: "different", num_squares: 3, num_targets: 1, condition: 'three_t1'}, durations),
          ];

        // parameters for n=4, t=1 stimulus
        var four_t1 = [
            Object.assign({ task_type: "same", num_squares: 4, num_targets: 1, condition: 'four_t1'}, durations),
            Object.assign({ task_type: "different", num_squares: 4, num_targets: 1, condition: 'four_t1'}, durations),
          ];

        // parameters for n=6, t=1 stimulus
        var six_t1 = [
            Object.assign({ task_type: "same", num_squares: 6, num_targets: 1, condition: 'six_t1'}, durations),
            Object.assign({ task_type: "different", num_squares: 6, num_targets: 1, condition: 'six_t1'}, durations),
          ];

        // parameters for n=8, t=1 stimulus for experimental block, and for n=8, t=varied[1] for practice block
        var eight_t1 = [
            Object.assign({ task_type: "same", num_squares: 8, num_targets: 1, color_reps: 2, condition: 'eight_t1'}, durations),
            Object.assign({ task_type: "different", num_squares: 8, num_targets: 1, color_reps: 2, condition: 'eight_t1'}, durations),
          ];

        // parameters for n=8, t=varied[2] stimulus for practice block
        var eight_t2 = [
            Object.assign({ task_type: "same", num_squares: 8, num_targets: 2, color_reps: 2, condition: 'eight_t2'}, durations),
            Object.assign({ task_type: "different", num_squares: 8, num_targets: 2, color_reps: 2 ,condition: 'eight_t2'}, durations),
          ];

        // parameters for n=8, t=varied[3] stimulus for practice block
        var eight_t3 = [
            Object.assign({ task_type: "same", num_squares: 8, num_targets: 3, color_reps: 2, condition: 'eight_t3'}, durations),
            Object.assign({ task_type: "different", num_squares: 8, num_targets: 3, color_reps: 2 ,condition: 'eight_t3'}, durations),
          ];

        // parameters for n=8, t=varied[4] stimulus for practice block
        var eight_t4 = [
            Object.assign({ task_type: "same", num_squares: 8, num_targets: 4, color_reps: 2, condition: 'eight_t4'}, durations),
            Object.assign({ task_type: "different", num_squares: 8, num_targets: 4, color_reps: 2 ,condition: 'eight_t4'}, durations),
          ];

        // parameter for n=8, t=varied[1-4] stimulus for experimental block
        var eight_tvary = [
            Object.assign({ task_type: "same", num_squares: 8, num_targets: 1, color_reps: 2, condition: 'eight_tvary'}, durations),
            Object.assign({ task_type: "different", num_squares: 8, num_targets: 1, color_reps: 2 ,condition: 'eight_tvary'}, durations),
            Object.assign({ task_type: "same", num_squares: 8, num_targets: 2, color_reps: 2, condition: 'eight_tvary'}, durations),
            Object.assign({ task_type: "different", num_squares: 8, num_targets: 2, color_reps: 2 ,condition: 'eight_tvary' }, durations),
            Object.assign({ task_type: "same", num_squares: 8, num_targets: 3, color_reps: 2, condition: 'eight_tvary'}, durations),
            Object.assign({ task_type: "different", num_squares: 8, num_targets: 3, color_reps: 2 ,condition: 'eight_tvary'}, durations),
            Object.assign({ task_type: "same", num_squares: 8, num_targets: 4, color_reps: 2, condition: 'eight_tvary' }, durations),
            Object.assign({ task_type: "different", num_squares: 8, num_targets: 4, color_reps: 2 ,condition: 'eight_tvary'}, durations),
          ];


// experimental configurations and helper functions
        // practice block
        trial_conditions = [three_t1, four_t1, six_t1, eight_t1, eight_t2, eight_t3 , eight_t4]

        // experimental blocks
        all_conditions = [three_t1, four_t1, six_t1, eight_t1, eight_tvary]

        // bonus point allocation
        bonus_fraction = 20/(all_conditions.length*reps_in_main* 2)

        // helper - shuffle function
        function shuffle(array) {
          array.sort(() => Math.random() - 0.5);
        }

        // helper - repetition control
        function reppers(condition){ //makes it so that the tvary condition isn't 4 times as long as everything else
          stringy = JSON.stringify(condition)
          reps_tvary = reps_in_main/4
          if (stringy.includes("tvary")){
            return reps_tvary
          } else {
            return reps_in_main
          }
        }


// start timeline

        var timeline = [];

// add identifying information for primary key

        // week Id
        var weekId = "1"; // changed weekly
        jsPsych.data.addProperties({
          weekId: weekId
        });

        // experimental Id, cd = change detection
        var expId = "cd_" + jsPsych.randomization.randomID(8);
        var eId = "cd"; // experiment code, cd = change detection
        jsPsych.data.addProperties({
          expId: eId
        });

        // url
        var fullurl = window.location.href;
        jsPsych.data.addProperties({
          url: fullurl
        });

        // subject Id taken from url
        var subjectId = jsPsych.data.getURLVariable('workerId');
        jsPsych.data.addProperties({
          subjectId: subjectId
        });

        // assignment Id taken from url
        var assignmentId = jsPsych.data.getURLVariable('assignmentId');
        jsPsych.data.addProperties({
          assignmentId: assignmentId
        });

        // hit Id taken from url
        var hitId = jsPsych.data.getURLVariable('hitId');
        jsPsych.data.addProperties({
          hitId: hitId
        });

    // // for testing only
        // var subjectId = "hannatest"
        // jsPsych.data.addProperties({
        //   subjectId: subjectId
        // });
        //
        // var assignmentId = "abc"
        // jsPsych.data.addProperties({
        //   assignmentId: assignmentId
        // });
        //
        // var hitId = "123"
        // jsPsych.data.addProperties({
        //   hitId: hitId
        // });

//  fullscreen mode

          var fullscreen_intro = {
              type: 'instructions',
              pages: [
                "<p>On the next screen you will be asked to put your browser in full screen mode.</p>" +
                "<p>After entering full screen mode it is very important that you do not exit, switch tabs, minimize, or adjust the browser for the remainder of the game.</p>" +
                "<p>Doing so changes the display of the game and the game does not pause once started.</p>" +
                "<p>We can detect if you exit fullscreen, minimize the window, or switch to another tab, and we reserve the right to withold bonus/payment if this is indicated.</p>",
                ],
             show_clickable_nav: true,
             on_finish: function(data) {
              jsPsych.data.addDataToLastTrial({
                exp_stage:"fullscreen",
                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                exp_part: "fullscreen"
              })
            }
          };
          timeline.push(fullscreen_intro)

        var fullscreen = {
          type: 'fullscreen',
          fullscreen_mode: true,
          on_finish: function(data) {
            jsPsych.data.addDataToLastTrial({
              exp_stage:"fullscreen",
              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
              exp_part: "fullscreen"
            })
          }
        }

        timeline.push(fullscreen)


// instructions block

        var instructions = {
            type: 'instructions',
            pages: [
              '<p> Welcome to the <b>Spot the Difference Game</b>!</p> <p>This task will take approximately 20 minutes to complete. </p> <p> Click the <q>Next</q> button to continue.</p>',

              "<p align='left'> During this task you will be shown pairs of images with colored squares arranged in a circular way, similar to the image below.</p>" +
              "<p align='left'> You will be shown these images <b>one at a time</b> with a pause in between.</p>"+
              "<p align='left'> Your job will be to decide if you saw the same image, or if one or more of the squares changed their color </p>" +
              "<p align='left'> You do not need to report how many squares changed color, what color they changed to, or their location in the circle, <i> you only need to notice if there was any change. </i></p>" +
              "<p><img src='img/change_det_ex.jpg'></img> </p>",

              "<p align='left'> After each pair of images you will be asked to click with your computer mouse/touchpad </p>" +
              "<p align='left'> whether the images were the <b>Same</b> or <b>Different</b> and how confident you are in that choice<p>" +
              "<p align='left'> You will be prompted to rate your confidence as <b>Very confident</b>, <b>Somewhat confident</b>, <b>Somewhat unconfident</b>, or <b>Very unconfident</b>.</p>"+
              "<p align='left'> Please only choose one answer per question. If you choose multiple answers your data will be thrown out and you may not receive your bonus</p>",

              "<p align='left'> You will want to pay close attention, as you will only see the images briefly!</p>" +
              "<p align='left'> It is important to us in this task that you are accurate in your answer. As such, you will be given plenty of time to respond.</p>"+
              "<p align='left'> However, please do not take more time than you need, if you leave the task, your response period will time out and you may have to forfeit your bonus</p>" +
              "<p align='left'> There are " + all_conditions.length + " rounds, each with " + reps_in_main*2 + " pairs of images.</p>" +
              "<p align='left'> Note that the number of colored squares in an image may vary between rounds </p>",

              "<p align='left'> Please try your best to perform as accurately as you can. </p>" +
              "<p align='left'> You will receive feedback during the task. For each correct answer you will receive points, </p>" +
              "<p align='left'> and these points will be proportinal to a cash bonus at the end of each session.</p>",

              '<p>Next, you will answer some questions about this task and then do a practice trial to gain familiarity with the task. </p><p>Press the <q>Next</q> button to answer the instruction comprehension questions.</p>'
              ],
           show_clickable_nav: true,
           on_finish: function(data) {
            jsPsych.data.addDataToLastTrial({
              exp_stage:"instructions",
              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
              exp_part: "instructions"
            })
          }
        };
        timeline.push(instructions)

// instruction comprehension questions
        var instruction_questions = {
            type:'survey-multi-choice',
            questions: [
              {prompt: "What will you be asked after each pair of images?",
                options: ["The number of different squares, and what color they were", "How many squares changed color, and how confident you are that number is correct", "If there was any change in any of the square colors, and how confident you are that you are correct", "How many squares changed color, and what color they changed to"]},
              {prompt: "Which of the following is most important?",
                options: ["That I answer accurately", "That I answer quickly", "That I know which square changed", "That I know the colors of the squares" ]}
              ],
            required: true,
            on_finish: function(data) {
              jsPsych.data.addDataToLastTrial({
                exp_stage:"instruction_questions",
                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                exp_part: "instructions"
              })
            }
        };

        timeline.push(instruction_questions);

        // what they see if they answered one or both questions incorrectly the first time
        var redo_instructions = {
            type: 'instructions',
            pages: [
              "<p> Hmm...Based on one or more of your answers to the previous questions, it looks as if you may not fully understand the task. </p>" +
              "<p> If you are unable to answer the questions correctly again, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
              "<p> Please click 'Next' to return to the instructions. </p>"

            ],
            show_clickable_nav: true,
            on_finish: function(data) {
              jsPsych.data.addDataToLastTrial({
                exp_stage:"instruction_fail_first",
                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                exp_part:"instructions"
              })
            },
        };

        // what they see if they answered one or both of the questions incorrectly more than once
        var failed_instructions = {
            type: 'instructions',
            pages: [
              "<p> We're sorry, it appears as if you have failed to answer one or both of the instruction comprehension questions twice. </p>" +
              "<p> You may not receive a bonus payment for this task </p>" +
              "<p> <b> If you fail to answer the instruction comprehension questions a third time you may be asked to leave the study. </b></p>"
            ],
            show_clickable_nav: true,
            on_finish: function(data) {
              jsPsych.data.addDataToLastTrial({
                exp_stage:"instruction_fail_again",
                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                exp_part: "instructions"
              })
            },
        };

        // evaluates question responses and loops timeline if questions are incorrect (part 3)
        // Note: you need all three parts (next two follow) for this function to work
        var instructions_understood3 = {
            timeline: [failed_instructions, instructions, instruction_questions],
            conditional_function:   function() {
                var dat = jsPsych.data.getLastTrialData().values()[0];
                var dat1 = jsPsych.data.getLastTrialData().values()[1];
                var answer1 = JSON.parse(dat.responses).Q0;
                var answer2 = JSON.parse(dat.responses).Q1;
                if(answer1.includes('If') == true && answer2.includes('accurately') == true) {
                    return false;
                } else {
                    return true;
                }
              },
          };

        // evaluates question responses and loops timeline if questions are incorrect (part 2)
        var instructions_understood2 = {
            timeline: [failed_instructions, instructions, instruction_questions, instructions_understood3],
            conditional_function:   function() {
                var dat = jsPsych.data.getLastTrialData().values()[0];
                var dat1 = jsPsych.data.getLastTrialData().values()[1];
                var answer1 = JSON.parse(dat.responses).Q0;
                var answer2 = JSON.parse(dat.responses).Q1;
                if(answer1.includes('If') == true && answer2.includes('accurately') == true) {
                    return false;
                } else {
                    return true;
                }
              },
          };

        // evaluates question responses and loops timeline if questions are incorrect (part 1)
        var instructions_understood = {
            timeline: [redo_instructions, instructions, instruction_questions, instructions_understood2],
            conditional_function:   function() {
                var dat = jsPsych.data.getLastTrialData().values()[0];
                var dat1 = jsPsych.data.getLastTrialData().values()[1];
                var answer1 = JSON.parse(dat.responses).Q0;
                var answer2 = JSON.parse(dat.responses).Q1;
                if(answer1.includes('If') == true && answer2.includes('accurately') == true) {
                    return false;
                } else {
                    return true;
                }
              },
          };

        timeline.push(instructions_understood);

// practice block

        // stimulus
        var practice_stim = {
          type: 'change-detection-task',
          task_type: jsPsych.timelineVariable('task_type'),
          stim_duration: jsPsych.timelineVariable('stim_duration'),
          between_fixation_dur: jsPsych.timelineVariable('between_fixation_dur'),
          num_squares: jsPsych.timelineVariable('num_squares'),
          num_targets: jsPsych.timelineVariable('num_targets'),
          color_reps: jsPsych.timelineVariable('color_reps'),
          on_finish: function(data) {
            jsPsych.data.addDataToLastTrial({
              exp_stage:"practice_stimulus",
              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
              exp_part: "practice"
            })
          }
      };

        // post-stim choice of same or different
        var practice_same_diff = {
            type: 'html-button-response',
            button_html: ['<button class="jspsych-btn-same-diff">%choice%</button>',
                        '<button class="jspsych-btn-same-diff">%choice%</button>'],
            stimulus: '<p class="click_prompt"> Were these images the same or different? </p>',
            choices: ["Same", "Different"],
            on_finish: function(data){
              if (data.button_pressed == 0){
                data.choice = "same",
                trial_node_id = jsPsych.currentTimelineNodeID();
                jsPsych.data.addDataToLastTrial({
                  exp_stage:"practice_choice",
                  primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                  exp_part: "practice"
                })
              }
              else{
                data.choice = "different",
                trial_node_id = jsPsych.currentTimelineNodeID();
                jsPsych.data.addDataToLastTrial({
                  exp_stage:"practice_choice",
                  primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                  exp_part: "practice"
                })
              }
              last_task = jsPsych.data.get().last(2).values()[0].task_type
              if (last_task  === data.choice){
                data.correct = true
              }
              else {
                data.correct = false
              }
              data.curr_bonus = jsPsych.data.get().filter({correct: true, exp_stage: 'main'}).count() * bonus_fraction
            }
          }

          // post-stim choice of confidence rating
          var practice_confidence = {
              type: 'html-button-response',
              button_html: ['<button class="jspsych-btn-confidence">%choice%</button>',
                          '<button class="jspsych-btn-confidence">%choice%</button>',
                          '<button class="jspsych-btn-confidence">%choice%</button>',
                          '<button class="jspsych-btn-confidence">%choice%</button>'],
              stimulus: '<p class="click_prompt"> How confident are you that the images were the same/different?  </p>',
              choices: ["Very Unconfident", "Somewhat <br> Unconfident","Somewhat <br> Confident", "Very Confident"],
              on_finish: function(data){
                data.correct = jsPsych.data.get().last(2).values()[0].correct
                data.choice = jsPsych.data.get().last(2).values()[0].choice
                data.exp_stage = "practice_confidence"
                data.exp_part = "practice"
                trial_index = jsPsych.data.get().last(1).values()[0].trial_index
                data.primary_key = subjectId + '_' + weekId + '_' + expId + '_' + trial_index
                if (data.button_pressed == 3 ){
                  data.confidence = "very_c"//"Very Confident",
                }
                else if (data.button_pressed == 2 ){
                  data.confidence = "somewhat_c"//"Somewhat Confident",
                }
                else if (data.button_pressed == 1 ){
                  data.confidence = "somewhat_un"//"Somewhat Unconfident",
                }
                else if (data.button_pressed == 0 ){
                  data.confidence = "very_un"//"Very Unconfident",
                }
            }
        };

        // feedback
        var practice_feedback = {
              type: 'html-keyboard-response',
              choices: jsPsych.NO_KEYS,
              trial_duration: 500,
              stimulus: function(){
                var last_trial_correct = jsPsych.data.get().last(2).values()[0].correct;
                if(last_trial_correct){
                  return "<p><font size='5' color='green'>Correct</font></p></p>";
                }
                else {
                  return "<p><font size='5' color='red'>Incorrect</font></p>"
                }
              },
              on_finish: function(data) {
                jsPsych.data.addDataToLastTrial({
                  exp_stage:"practice_feedback",
                  primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                  exp_part: "practice"
                })
              }
          };

        // precursor
        var start_trial = {
          type: 'html-keyboard-response',
          stimulus: '<p>Practice Trial.</p> <p>Press any key to continue.</p>',
          on_finish: function(data) {
            jsPsych.data.addDataToLastTrial({
              exp_stage:"practice_start",
              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
              exp_part:"practice"
            })
          }
      };

        timeline.push(start_trial)

      // shuffle and run practice trial stimuli
        shuffle(trial_conditions)
        trial_procedure = [start_trial]
        for (i = 0; i < trial_conditions.length; i++){
          game = i+1
          var practice_block = {
              timeline: [practice_stim, practice_same_diff, practice_confidence, practice_feedback],
              timeline_variables: trial_conditions[i],
              repetitions: reps_in_trial,
              randomize_order: true,
              data: {block: 'block_p', task_type: jsPsych.timelineVariable('task_type'), block_condition: jsPsych.timelineVariable('condition')}
          }
          timeline.push(practice_block);
          trial_procedure.push(practice_block)
        }

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

      // end practice trial
      var end_trial = {
          type: 'html-keyboard-response',
          stimulus: '<p>This marks the end of the Practice Trial.</p> <p>Press any key to continue to the main experiment.</p>',
          on_finish: function(data) {

            p_block_size = trial_conditions.length*4*2
            data.num_same = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', choice: 'same'}).count()
            data.num_diff = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', choice: 'different'}).count()
            num_corr = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', correct:true}).count()
            num_choices = trial_conditions.length*2
            data.error_block = 1-(num_corr/num_choices)
            jsPsych.data.addDataToLastTrial({
              exp_stage:"practice_end",
              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
              suspicious: false,
              block: 'block_p',
              exp_part: 'practice'
            })
          }
        }

        // if no suspicion flags triggered
        var no_sus = {
          timeline: [end_trial],
          conditional_function:   function(data) {
            p_block_size = trial_conditions.length*4*2
            num_same = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', choice: 'same'}).count()
            num_diff = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', choice: 'different'}).count()
            num_corr = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', correct:true}).count()
            num_choices = trial_conditions.length*2
            error_block = 1-(num_corr/num_choices)
            console.log("num_same: " + num_same)
            console.log("num_diff: " + num_diff)
            console.log("num_choices: " + num_choices)
            console.log("error_block: " + error_block)

              if(num_same == num_choices || num_diff == num_choices) {
                  return false;
              } else if (error_block >= error_rate_cap){
                  return false
              }
              else {
                  return true;
              }
            }

        };
        timeline.push(no_sus);

        // if suspicion flags triggered
        var sus_1 = {
          type: 'instructions',
          pages: function(data){
            p_block_size = trial_conditions.length*4*2
            num_same = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', choice: 'same'}).count()
            num_diff = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', choice: 'different'}).count()
            num_corr = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', correct:true}).count()
            num_choices = trial_conditions.length*2
            error_block = 1-(num_corr/num_choices)

            if (num_same == num_choices){
              return [
                "<p align='left'> Hmm... You selected that the images were the same for every single set of images. It looks as if you may not fully understand the task. </p>" +
                "<p align='left'> If you are unable to better perform in the practice trial a second time, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
                "<p align='left'> Please click 'Next' to return to the instructions. </p>"
              ]
            }
            else if (num_diff == num_choices){
              return [
                "<p align='left'> Hmm... You selected that the images were different for every single set of images. It looks as if you may not fully understand the task. </p>" +
                "<p align='left'> If you are unable to better perform in the practice trial a second time, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
                "<p align='left'> Please click 'Next' to return to the instructions. </p>"
              ]
            }
            else {
              return [
                "<p align='left'> Hmm... Your choices of same and different indicates that you may not fully understand the task at hand. </p>" +
                "<p align='left'> If you are unable to better perform in the practice trial a second time, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
                "<p align='left'> Please click 'Next' to return to the instructions. </p>"
              ]
            }

          },
          show_clickable_nav: true,
          on_finish: function(data){
            data.primary_key =  subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
            data.suspicious = true
            data.block = 'block_p'
            data.num_same = num_same
            data.num_diff = num_diff
            data.error_block = error_block
            data.exp_stage = "practice_suspicion_flag"
            data.exp_part = "practice"
            if(num_same == reps_in_trial*2*trial_conditions.length) {
                data.suspicious_type = 'all_one';
            }
            else if (num_same = 0){
                data.suspicious_type = 'all_one';
            }
            else {
              data.suspicious_type = 'error_block'
            }
          }
        }

        var sus_2 = {
          type: 'instructions',
          pages: function(data){
            p_block_size = trial_conditions.length*4*2
            num_same = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', choice: 'same'}).count()
            num_diff = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', choice: 'different'}).count()
            num_corr = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', correct:true}).count()
            num_choices = trial_conditions.length*2
            error_block = 1-(num_corr/num_choices)
            if (num_same == reps_in_trial*2*trial_conditions.length){
              return [
                "<p align='left'> Hmm... You selected that the images were the same for every single set of images. It looks as if you may not fully understand the task. </p>" +
                "<p align='left'> If you are unable to better perform in the practice trial a second time, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
                "<p align='left'> Please click 'Next' to return to the instructions. </p>"
              ]
            }
            else if (num_same == 0){
              return [
                "<p align='left'> Hmm...  You selected that the images were different for every single set of images. It looks as if you may not fully understand the task. </p>" +
                "<p align='left'> If you are unable to better perform in the practice trial a second time, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
                "<p align='left'> Please click 'Next' to return to the instructions. </p>"
              ]
            }
            else {
              return [
                "<p align='left'> Hmm... Your choices of same and different indicates that you may not fully understand the task at hand. </p>" +
                "<p align='left'> If you are unable to better perform in the practice trial a second time, we reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
                "<p align='left'> Please click 'Next' to return to the instructions. </p>"
              ]
            }

          },
          show_clickable_nav: true,
          on_finish: function(data){
            data.primary_key =  subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
            data.suspicious = true
            data.block = 'block_p'
            data.num_same = num_same
            data.num_diff = num_diff
            data.error_block = error_block
            data.exp_stage = "practice_suspicion_flag"
            data.exp_part = "practice"
            if(num_same == num_choices) {
                data.suspicious_type = 'all_one';
            }
            else if (num_diff == num_choices){
                data.suspicious_type = 'all_one';
            }
            else {
                data.suspicious_type = 'error_block'
            }
          }
        }

        var final_bad = {
          type: 'instructions',
          pages: function(data){
            p_block_size = trial_conditions.length*4*2
            num_same = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', choice: 'same'}).count()
            num_diff = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', choice: 'different'}).count()
            num_corr = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', correct:true}).count()
            num_choices = trial_conditions.length*2
            error_block = 1-(num_corr/num_choices)
              return [
                "<p align='left'> We're sorry, it appears as if you still do not fully understand the task. </p>" +
                "<p align='left'> We reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
                "<p align='left'> Please click 'Next' to begin the main task. </p>"
              ]
          },
          show_clickable_nav: true,
          on_finish: function(data){
            data.primary_key =  subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
            data.suspicious = true
            data.block = 'block_p'
            data.num_same = num_same
            data.num_diff = num_diff
            data.error_block = error_block
            data.exp_stage = "practice_suspicion_flag"
            data.exp_part = "practice"
            if(num_same == reps_in_trial*2*trial_conditions.length || num_same == 0) {
                data.suspicious_type = 'all_one';
            }
            else {
                data.suspicious_type = 'error_block'
            }
          }
        }

        var sus_procedure3 = {
          timeline: [final_bad],
          data: {exp_part: 'practice'},
          conditional_function:   function() {
            p_block_size = trial_conditions.length*4*2
            num_same = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', choice: 'same'}).count()
            num_diff = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', choice: 'different'}).count()
            num_corr = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', correct:true}).count()
            num_choices = trial_conditions.length*2
            error_block = 1-(num_corr/num_choices)
            if(num_same == num_choices || num_diff == num_choices) {
                return true;
            } else if (error_block >= error_rate_cap){
                return true
            }
            else {
                return false;
            }
            },

        }

        todo2 = [sus_2].concat(trial_procedure)
        todo2 = todo2.concat([no_sus, sus_procedure3])
        var sus_procedure2 = {
            timeline: todo2,
            data: {exp_part: 'practice'},
            conditional_function:   function() {
              p_block_size = trial_conditions.length*4*2
              num_same = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', choice: 'same'}).count()
              num_diff = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', choice: 'different'}).count()
              num_corr = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', correct:true}).count()
              num_choices = trial_conditions.length*2
              error_block = 1-(num_corr/num_choices)
              if(num_same == num_choices || num_diff == num_choices){
                  return true;
              } else if (error_block >= error_rate_cap){
                  return true
              }
              else {
                  return false;
              }
              },
          };

        shuffle(trial_conditions)
        todo1 = [sus_1].concat(trial_procedure)
        todo1 = todo1.concat([no_sus, sus_procedure2])
        var sus_procedure = {
            timeline: todo1,
            data: {exp_part: 'practice'},
            conditional_function:   function() {
              p_block_size = trial_conditions.length*4*2
              num_same = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', choice: 'same'}).count()
              num_diff = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', choice: 'different'}).count()
              num_corr = jsPsych.data.get().last(p_block_size).filter({exp_stage:'practice_choice', correct:true}).count()
              num_choices = trial_conditions.length*2
              error_block = 1-(num_corr/num_choices)
              if(num_same == num_choices || num_diff == num_choices){
                  return true;
              } else if (error_block >= error_rate_cap){
                  return true
              }
              else {
                  return false;
              }
              },
          };

        shuffle(trial_conditions)
        timeline.push(sus_procedure);

// main experiment
      // shuffle block order
      shuffle(all_conditions)

      // create stimulus
        var stim = {
          type: 'change-detection-task',
          task_type: jsPsych.timelineVariable('task_type'),
          stim_duration: jsPsych.timelineVariable('stim_duration'),
          between_fixation_dur: jsPsych.timelineVariable('between_fixation_dur'),
          num_squares: jsPsych.timelineVariable('num_squares'),
          num_targets: jsPsych.timelineVariable('num_targets'),
          color_reps: jsPsych.timelineVariable('color_reps'),
          on_finish: function(data) {
            jsPsych.data.addDataToLastTrial({
              exp_stage:"main_stimulus",
              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
              exp_part: "main"
            })
          }
        };

        // same or different choice
        var same_diff = {
            type: 'html-button-response',
            button_html: ['<button class="jspsych-btn-same-diff">%choice%</button>',
                        '<button class="jspsych-btn-same-diff">%choice%</button>'],
            stimulus: '<p class="click_prompt"> Were these images the same or different? </p>',
            choices: ["Same", "Different"],
            // data: {block},
            on_finish: function(data){
              if (data.button_pressed == 0){
                data.choice = "same",
                jsPsych.data.addDataToLastTrial({
                  exp_stage:"main_choice",
                  primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                  exp_part: "main"
                })
              }
              else{
                data.choice = "different",
                jsPsych.data.addDataToLastTrial({
                  exp_stage:"main_choice",
                  primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                  exp_part: "main"
                })
              }
              last_task = jsPsych.data.get().last(2).values()[0].task_type
              if (last_task  === data.choice){
                data.correct = true
              }
              else {
                data.correct = false
              }
              data.curr_bonus = jsPsych.data.get().filter({correct: true, exp_stage:"main_choice"}).count() * bonus_fraction
              if (data.correct == true) {
                data.trial_bonus = bonus_fraction
              } else {
                data.trial_bonus = "0"
              }
            }
          }

          // confidence rating
          var confidence = {
              type: 'html-button-response',
              button_html: ['<button class="jspsych-btn-confidence">%choice%</button>',
                          '<button class="jspsych-btn-confidence">%choice%</button>',
                          '<button class="jspsych-btn-confidence">%choice%</button>',
                          '<button class="jspsych-btn-confidence">%choice%</button>'],
              stimulus: '<p class="click_prompt"> How confident are you that the images were the same/different?  </p>',
              choices: ["Very Unconfident", "Somewhat <br> Unconfident","Somewhat <br> Confident", "Very Confident"],
              // data: {response: jsPsych.data.getLastTrialData().select('response').values[0]},
              on_finish: function(data){
                data.correct = jsPsych.data.get().last(2).values()[0].correct
                data.choice = jsPsych.data.get().last(2).values()[0].choice
                data.exp_stage = "main_confidence"
                data.exp_part = "main"
                trial_index = jsPsych.data.get().last(1).values()[0].trial_index
                data.primary_key = subjectId + '_' + weekId + '_' + expId + '_' + trial_index
                if (data.button_pressed == 3 ){
                  data.confidence = "very_c"//"Very Confident",
                }
                else if (data.button_pressed == 2 ){
                  data.confidence = "somewhat_c"//"Somewhat Confident",
                }
                else if (data.button_pressed == 1 ){
                  data.confidence = "somewhat_un"//"Somewhat Unconfident",
                }
                else if (data.button_pressed == 0 ){
                  data.confidence = "very_un"//"Very Unconfident",
                }
            }
        };

        // trial feedback
        var feedback = {
              type: 'html-keyboard-response',
              choices: jsPsych.NO_KEYS,
              trial_duration: 500,
              stimulus: function(){
                var last_trial_correct = jsPsych.data.get().last(2).values()[0].correct;
                if(last_trial_correct){
                  return "<p><font size='5' color='green'>Correct</font></p></p>";
                }
                else {
                  return "<p><font size='5' color='red'>Incorrect</font></p>"
                }
              },
              on_finish: function(data) {
                jsPsych.data.addDataToLastTrial({
                  exp_stage:"main_feedback",
                  primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                  exp_part: "main"
                })
              }
          };

        // assemble and run block
        for (i = 0; i < all_conditions.length; i++){
          game = i+1;
          var new_block = {
            type: 'html-keyboard-response',
            stimulus: '<p>Block '+ game + ' out of ' + all_conditions.length + '</p> <p>Press any key to continue.</p>',
            // data: {condition: all_conditions[i]},
            on_finish: function(data) {
              jsPsych.data.addDataToLastTrial({
                exp_stage:"block_start",
                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                exp_part: "main"
              })
            }
        };

          timeline.push(new_block)

          var block = {
              timeline: [stim, same_diff, confidence, feedback],
              timeline_variables: all_conditions[i],
              repetitions: reppers(all_conditions[i]),
              randomize_order: true,
              data: {block: 'block_' + game, task_type: jsPsych.timelineVariable('task_type'), block_condition: jsPsych.timelineVariable('condition')}

          };

          timeline.push(block)

      // between block update
          var bonus_update = {
            type: "html-keyboard-response",
            stimulus: function(){
              var bonus = jsPsych.data.get().last(3).values()[0].curr_bonus;
              var rounded_bonus = Math.round(bonus)
              return "<p>You have earned <b>"+ rounded_bonus + "</b> bonus points in total!</p>"+
              "<p>Feel free to take a short break, but not too long. This will time out after 1 minute.</p>" +
              "<p>Press any key to resume the task.</p>"},
            trial_duration: 60000,
            response_ends_trial: true,
            on_finish: function(data) {
              data.block = jsPsych.data.get().last(2).values()[0].block
              data.block_condition = jsPsych.data.get().last(2).values()[0].block_condition
              data.num_same = jsPsych.data.get().filter({choice: 'same', block: data.block, exp_stage:'main_choice'}).count()
              data.num_diff = jsPsych.data.get().filter({choice: 'different', block: data.block, exp_stage:'main_choice'}).count()
              num_corr = jsPsych.data.get().filter({exp_stage: 'main_choice', block: data.block, correct: true}).count()
              num_trials = 2*reps_in_main
              error_block = 1 - (num_corr/num_trials)
              data.error_block = error_block

              if (num_same == num_trials || num_diff == num_trials){
                data.suspicious = true
                data.suspicious_type = 'all_one'
              }
              else if (error_block >= error_rate_cap){
                data.suspicious = true
                data.suspicious_type = 'error_block'
              }
              else{
                data.suspicious = 'false'
              }
              jsPsych.data.addDataToLastTrial({
                exp_stage:"between_block",
                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                exp_part: "main"
              })
            }
          };

          if (i < all_conditions.length - 1){
            timeline.push(bonus_update)
          }

        }

      // end of all blocks - bonus status
        var bonus_block = {
          type: 'instructions',
          pages: function() {

            var bonus = jsPsych.data.get().last(3).values()[0].curr_bonus;
            var rounded_bonus = Math.round(bonus)

            //jsPsych.data.addDataToLastTrial({"bonus": rounded_bonus});
            return ['<p>This marks the end of the experiment.</p>' +
            '<p>You earned <b>' + rounded_bonus + ' points </b>!</p>' +
            '<p>Thank you so much for your participation.</p>' +
            '<p>Press <q>Next</q> to continue to the feedback survey.</p>'];
          },
          show_clickable_nav: true,
          on_finish: function(data) {
            data.block = jsPsych.data.get().last(2).values()[0].block
            data.block_condition = jsPsych.data.get().last(2).values()[0].block_condition
            data.num_same = jsPsych.data.get().filter({choice: 'same', block: data.block, exp_stage:'main_choice'}).count()
            data.num_diff = jsPsych.data.get().filter({choice: 'different', block: data.block, exp_stage:'main_choice'}).count()
            num_corr = jsPsych.data.get().filter({exp_stage: 'main_choice', block: data.block, correct: true}).count()
            num_trials = 2*reps_in_main
            error_block = 1 - (num_corr/num_trials)
            data.error_block = error_block

            if (num_same == num_trials || num_diff == num_trials){
              data.suspicious = true
              data.suspicious_type = 'all_one'
            }
            else if (error_block >= error_rate_cap){
              data.suspicious = true
              data.suspicious_type = 'error_block'
            }
            else{
              data.suspicious = 'false'
            }

          jsPsych.data.addDataToLastTrial({
            exp_stage:"end_bonus",
            primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
            exp_part: "main"
          })
        }
    };
        timeline.push(bonus_block);

// post-task feedback questionss

    //suspicious

        var fb_warning_ss = {
            type: 'instructions',
            pages: [
              "<p align='left'> This task has several built in alarms that signal when a worker may be trying to 'trick' at a task" +
              "<p align='left'> (i.e. by selecting the same answer every time, or never answering at all). " +
              "<p align='left'>  Something about your responses for part or all of this task has triggered one of these alarms." ,

              "<p align='left'>  Your bonus will be witheld until an experimenter can manually review your answers to check if there was a mistake on our end, or if you did try to 'trick' the task." +
              "<p align='left'>  In the following feedback survey, you will have the chance to explain anything that may have made your answers appear irregular. " +
              "<p align='left'>  In the event that an honest mistake was made or our code was incorrect, you will receive your bonus as planned" +
              "<p align='left'>  However, if it appears that you tried to 'trick' the system, we reserve the right to withold your bonus, and if cheating behavior continues you will be asked to leave the study."
                ],
             show_clickable_nav: true,
             on_start: function() {
               document.querySelector('body').style.backgroundColor = 'white'
             },
             on_finish: function(data) {
              jsPsych.data.addDataToLastTrial({
                fb_type: "suspicious",
                exp_stage:"feedback_warning",
                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                exp_part: "feedback"
              })
            }
          };

        // first question - tech problems
              var fb_q1_ss = {
                  type: 'survey-multi-choice',
                  preamble: '<h4> Feedback Survey 1/4 </h4>', // +
                  questions: [
                    {prompt: "Did you experience any technological issues during this task?   (i.e. experiment glitch, accidentally closed window, mixed up keys, etc.) <br>  If you answer 'Yes' or 'I am unsure' you will have the opportunity to explain",
                      options: [" Yes", " No", " I am unsure"],
                      // horizontal: true,
                      required: true,
                      name: 'tech problems'},
                      ],
                      on_finish: function(data){
                        var dat1 = jsPsych.data.getLastTrialData().values()[0];
                        var answer1 = JSON.parse(dat1.responses).Q0;
                        if(answer1.includes('Yes') == true || answer1.includes('unsure')) {
                          jsPsych.data.addDataToLastTrial({
                            fb_type: "suspicious",
                            fb_issue:'tech',
                            exp_stage:"feedback_tech",
                            primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                            exp_part: "feedback"
                          })
                        } else {
                          jsPsych.data.addDataToLastTrial({
                            fb_type: "suspicious",
                            exp_stage:"feedback_tech",
                            primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                            exp_part: "feedback"
                          })
                        }
                      }
                  };

            // first question - tech problems - if yes, please explain
              var fb_q1_follow_ss = {
                  type: 'survey-text',
                  preamble: '<h4> Feedback Survey 1/4 </h4>', // +
                  questions: [
                    {prompt: "Please tell us about the technical difficulties you experienced: ",
                      required: true,
                      name: 'tech problems follow up'},
                      ],
                      on_finish: function(data){
                        var dat1 = jsPsych.data.getLastTrialData().values()[0];
                        var answer1 = JSON.parse(dat1.responses).Q0;
                        jsPsych.data.addDataToLastTrial({
                          fb_type: "suspicious",
                          fb_issue: 'tech',
                          fb_issue_txt: answer1,
                          exp_stage:"feedback_tech_followup",
                          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                          exp_part: "feedback"
                        })
                      }
                  };

            // determines if subject answered yes, and explanation is required
              var fb_q1_eval_ss = {
                  timeline: [fb_q1_follow_ss],
                  conditional_function:   function() {
                      var dat1 = jsPsych.data.getLastTrialData().values()[0];
                      var answer1 = JSON.parse(dat1.responses).Q0;
                      if(answer1.includes('Yes') == true || answer1.includes('unsure')) {
                          return true;
                      } else {
                          return false;
                      }
                    },
                };


        // second question - distractions
              var fb_q2_ss = {
                  type: 'survey-multi-choice',
                  preamble: '<h4> Feedback Survey 2/4 </h4>', // +
                  questions: [{
                      prompt: "Did you experience any major distractions or interruptions during this task? <br> If you answer 'Yes' you will have the opportunity to explain",
                      options: [" Yes", " No"],
                      required: true,
                      name: 'distractions'
                    },
                  ],
                  on_finish: function(data){
                    var dat2 = jsPsych.data.getLastTrialData().values()[0];
                    var answer2 = JSON.parse(dat2.responses).Q0;
                    if(answer2.includes('Yes') == true) {
                      jsPsych.data.addDataToLastTrial({
                        fb_type: "suspicious",
                        fb_issue:'distraction',
                        exp_stage:"feedback_distraction",
                        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                        exp_part: "feedback"
                      })
                    } else {
                      jsPsych.data.addDataToLastTrial({
                        fb_type: "suspicious",
                        exp_stage:"feedback_distraction",
                        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                        exp_part: "feedback"
                      })
                    }
                  }
                };

            // second question - distractions - if yes, please explain
              var fb_q2_follow_ss = {
                  type: 'survey-text',
                  preamble: '<h4> Feedback Survey 2/4 </h4>', // +
                  questions: [
                    {prompt: "Please describe how the distraction may have effected your performance, and if possible, at what point in the task this distraction occured:",
                      name: 'tech problems follow up'},
                      ],
                      on_finish: function(data){
                        var dat2 = jsPsych.data.getLastTrialData().values()[0];
                        var answer2 = JSON.parse(dat2.responses).Q0;
                        jsPsych.data.addDataToLastTrial({
                          fb_type: "suspicious",
                          fb_issue: 'distraction',
                          fb_issue_txt: answer2,
                          exp_stage:"feedback_distraction_followup",
                          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                          exp_part: "feedback"
                        })
                      }
                  };

            // determines if subject answered yes, and explanation is required
              var fb_q2_eval_ss = {
                  timeline: [fb_q2_follow_ss],
                  conditional_function:   function() {
                      var dat2 = jsPsych.data.getLastTrialData().values()[0];
                      var answer2 = JSON.parse(dat2.responses).Q0;
                      if(answer2.includes('Yes') == true) {
                          return true;
                      } else {
                          return false;
                      }
                    },
                };


        // third question: engagement
              var fb_q3_ss = {
                  type: 'survey-multi-choice',
                  preamble: '<h4> Feedback Survey 3/4 </h4>', // +
                  questions: [{
                      prompt: "On the following scale from 1 to 4, how engaging (attention holding) did you find this task?",
                      options: [" 1 - Not at all engaging", " 2 - Somewhat not engaging", " 3 - Somewhat engaging", " 4 - Very engaging"],
                      required: true,
                      name: 'engagement'
                    },
                  ],
                      on_finish: function(data){
                        var dat3 = jsPsych.data.getLastTrialData().values()[0];
                        var answer3 = JSON.parse(dat3.responses).Q0;
                        jsPsych.data.addDataToLastTrial({
                          fb_type: "suspicious",
                          fb_engagement: answer3,
                          exp_stage:"feedback_engaged",
                          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                          exp_part: "feedback"
                        })
                      }
                  };

        // fourth question: anything else
              var fb_q4_ss = {
                  type: 'survey-text',
                  preamble: '<h4> Feedback Survey 4/4 </h4>' , //+
                  questions: [{
                      prompt: "Is there anything else you would like us to know? <br> (Can be a specific concern or general suggestion for improvement)",
                      name: 'anything else'
                    },
                  ],
                      on_finish: function(data){

                        var interaction_data = jsPsych.data.getInteractionData();
                        data.screen = interaction_data.json();

                        var dat4 = jsPsych.data.getLastTrialData().values()[0];
                        var answer4 = JSON.parse(dat4.responses).Q0;
                        if (answer4 == ''){
                          jsPsych.data.addDataToLastTrial({
                          fb_type: "suspicious",
                          exp_stage:"feedback_other",
                          fb_type: "suspicious",
                          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                          exp_part: "feedback"
                        })
                      } else {
                        jsPsych.data.addDataToLastTrial({
                          fb_type: "suspicious",
                          fb_issue: 'other',
                          fb_issue_txt: answer4,
                          exp_stage:"feedback_other",
                          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                          exp_part: "feedback"
                          })
                        }
                      }
                  };

        // conclusion
              var fb_end_exp_ss = {
                type: 'html-keyboard-response',
                stimulus: '<p>Thank you! This marks the end of the feeback survey.</p> <p>Press any key to return to the home page.</p>',
                on_finish: function(data) {

                  var interaction_data = jsPsych.data.getInteractionData();
                  data.screen = interaction_data.json();

                  jsPsych.data.addDataToLastTrial({
                    fb_type: "suspicious",
                    exp_stage:"exp_end",
                    primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                    exp_part: "feedback"
                  })
                }
              };


        		// not suspicious

        		var fb_warning_ns = {
        		    type: 'instructions',
        		    pages: [
        		      "<p align='left'> This task has several built in alarms that signal when a worker may be trying to 'trick' at a task" +
        		      "<p align='left'> (i.e. by selecting the same answer every time, or never answering at all). " +
        					"<p align='left'> Your responses will be manually reviewed by a researcher, however it appears you have performed the task with sincere effort. Thank you!" ,

        		      "<p align='left'>  In the following feedback survey, you will have the chance to explain anything that may have made your answers appear irregular. " +
        		      "<p align='left'>  In the event that an honest mistake was made or our code was incorrect, you will receive your bonus as planned" +
        		      "<p align='left'>  However, if in review it appears that you tried to 'trick' the system, we reserve the right to withold your bonus, and if cheating behavior continues you will be asked to leave the study."
        		        ],
        		     show_clickable_nav: true,
                 on_start: function() {
                   document.querySelector('body').style.backgroundColor = 'white'
                 },
        		     on_finish: function(data) {
        		      jsPsych.data.addDataToLastTrial({
        		        fb_type: "nonsuspicious",
        		        exp_stage:"feedback_warning",
        		        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                    exp_part: "feedback"
        		      })
        		    }
        		  };

        		// first question - tech problems
        		    var fb_q1_ns = {
        		        type: 'survey-multi-choice',
        		        preamble: '<h4> Feedback Survey 1/4 </h4>' +
        		                  "<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
        		        questions: [
        		          {prompt: "Did you experience any technological issues during this task?   (i.e. experiment glitch, accidentally closed window, mixed up keys, etc.) <br>  If you answer 'Yes' or 'I am unsure' you will have the opportunity to explain",
        		            options: [" Yes", " No", " I am unsure"],
        		            // horizontal: true,
        		            required: true,
        		            name: 'tech problems'},
        		            ],
        		            on_finish: function(data){
        		              var dat1 = jsPsych.data.getLastTrialData().values()[0];
        		              var answer1 = JSON.parse(dat1.responses).Q0;
        		              if(answer1.includes('Yes') == true || answer1.includes('unsure')) {
        		                jsPsych.data.addDataToLastTrial({
        		                  fb_type: "nonsuspicious",
        		                  fb_issue:'tech',
        		                  exp_stage:"feedback_tech",
        		                  primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                              exp_part: "feedback"
        		                })
        		              } else {
        		                jsPsych.data.addDataToLastTrial({
        		                  fb_type: "nonsuspicious",
        		                  exp_stage:"feedback_tech",
        		                  primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                              exp_part: "feedback"
        		                })
        		              }
        		            }
        		        };

        		    // first question - tech problems - if yes, please explain
        		    var fb_q1_follow_ns = {
        		        type: 'survey-text',
        		        preamble: '<h4> Feedback Survey 1/4 </h4>' +
        		                  "<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
        		        questions: [
        		          {prompt: "Please tell us about the technical difficulties you experienced: ",
        		            required: true,
        		            name: 'tech problems follow up'},
        		            ],
        		            on_finish: function(data){
        		              var dat1 = jsPsych.data.getLastTrialData().values()[0];
        		              var answer1 = JSON.parse(dat1.responses).Q0;
        		              jsPsych.data.addDataToLastTrial({
        		                fb_type: "nonsuspicious",
        		                fb_issue: 'tech',
        		                fb_issue_txt: answer1,
        		                exp_stage:"feedback_tech_followup",
        		                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                            exp_part: "feedback"
        		              })
        		            }
        		        };

        		    // determines if subject answered yes, and explanation is required
        		    var fb_q1_eval_ns = {
        		        timeline: [fb_q1_follow_ns],
        		        conditional_function:   function() {
        		            var dat1 = jsPsych.data.getLastTrialData().values()[0];
        		            var answer1 = JSON.parse(dat1.responses).Q0;
        		            if(answer1.includes('Yes') == true || answer1.includes('unsure')) {
        		                return true;
        		            } else {
        		                return false;
        		            }
        		          },
        		      };


        		// second question - distractions
        		    var fb_q2_ns = {
        		        type: 'survey-multi-choice',
        		        preamble: '<h4> Feedback Survey 2/4 </h4>' +
        		                  "<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
        		        questions: [{
        		            prompt: "Did you experience any major distractions or interruptions during this task? <br> If you answer 'Yes' you will have the opportunity to explain",
        		            options: [" Yes", " No"],
        		            required: true,
        		            name: 'distractions'
        		          },
        		        ],
        		        on_finish: function(data){
        		          var dat2 = jsPsych.data.getLastTrialData().values()[0];
        		          var answer2 = JSON.parse(dat2.responses).Q0;
        		          if(answer2.includes('Yes') == true) {
        		            jsPsych.data.addDataToLastTrial({
        		              fb_type: "nonsuspicious",
        		              fb_issue:'distraction',
        		              exp_stage:"feedback_distraction",
        		              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                          exp_part: "feedback"
        		            })
        		          } else {
        		            jsPsych.data.addDataToLastTrial({
        		              fb_type: "nonsuspicious",
        		              exp_stage:"feedback_distraction",
        		              primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                          exp_part: "feedback"
        		            })
        		          }
        		        }
        		      };

        		    // second question - distractions - if yes, please explain
        		    var fb_q2_follow_ns = {
        		        type: 'survey-text',
        		        preamble: '<h4> Feedback Survey 2/4 </h4>' +
        		                  "<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
        		        questions: [
        		          {prompt: "Please describe how the distraction may have effected your performance, and if possible, at what point in the task this distraction occured:",
        		            name: 'tech problems follow up'},
        		            ],
        		            on_finish: function(data){
        		              var dat2 = jsPsych.data.getLastTrialData().values()[0];
        		              var answer2 = JSON.parse(dat2.responses).Q0;
        		              jsPsych.data.addDataToLastTrial({
        		                fb_type: "nonsuspicious",
        		                fb_issue: 'distraction',
        		                fb_issue_txt: answer2,
        		                exp_stage:"feedback_distraction_followup",
        		                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                            exp_part: "feedback"
        		              })
        		            }
        		        };

        		    // determines if subject answered yes, and explanation is required
        		    var fb_q2_eval_ns = {
        		        timeline: [fb_q2_follow_ns],
        		        conditional_function:   function() {
        		            var dat2 = jsPsych.data.getLastTrialData().values()[0];
        		            var answer2 = JSON.parse(dat2.responses).Q0;
        		            if(answer2.includes('Yes') == true) {
        		                return true;
        		            } else {
        		                return false;
        		            }
        		          },
        		      };


        		// third question: engagement
        		    var fb_q3_ns = {
        		        type: 'survey-multi-choice',
        		        preamble: '<h4> Feedback Survey 3/4 </h4>' +
        		                  "<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
        		        questions: [{
        		            prompt: "On the following scale from 1 to 4, how engaging (attention holding) did you find this task?",
        		            options: [" 1 - Not at all engaging", " 2 - Somewhat not engaging", " 3 - Somewhat engaging", " 4 - Very engaging"],
        		            required: true,
        		            name: 'engagement'
        		          },
        		        ],
        		            on_finish: function(data){
        		              var dat3 = jsPsych.data.getLastTrialData().values()[0];
        		              var answer3 = JSON.parse(dat3.responses).Q0;
        		              jsPsych.data.addDataToLastTrial({
        		                fb_type: "nonsuspicious",
        		                fb_engagement: answer3,
        		                exp_stage:"feedback_engaged",
        		                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                            exp_part: "feedback"
        		              })
        		            }
        		        };

        		// fourth question: anything else
        		    var fb_q4_ns = {
        		        type: 'survey-text',
        		        preamble: '<h4> Feedback Survey 4/4 </h4>' +
        		                  "<h5 align='left'> Please be honest, <u> your answers will not effect your bonus for this task. </u> </h5>",
        		        questions: [{
        		            prompt: "Is there anything else you would like us to know? <br> (Can be a specific concern or general suggestion for improvement)",
        		            name: 'anything else'
        		          },
        		        ],
        		            on_finish: function(data){

                          var interaction_data = jsPsych.data.getInteractionData();
                          data.screen = interaction_data.json();

        		              var dat4 = jsPsych.data.getLastTrialData().values()[0];
        		              var answer4 = JSON.parse(dat4.responses).Q0;
        		              if (answer4 == ''){
        		                jsPsych.data.addDataToLastTrial({
        		                fb_type: "nonsuspicious",
        		                exp_stage:"feedback_other",
        		                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                            exp_part: "feedback"
        		              })
        		            } else {
        		              jsPsych.data.addDataToLastTrial({
        		                fb_type: "nonsuspicious",
        		                fb_issue: 'other',
        		                fb_issue_txt: answer4,
        		                exp_stage:"feedback_other",
        		                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                            exp_part: "feedback"
        		                })
        		              }
        		            }
        		        };

        		// conclusion
        		    var fb_end_exp_ns = {
        		      type: 'html-keyboard-response',
        		      stimulus: '<p>Thank you! This marks the end of the feeback survey.</p> <p>Press any key to return to the home page.</p>',
        		      on_finish: function(data) {

                    var interaction_data = jsPsych.data.getInteractionData();
                    data.screen = interaction_data.json();

        		        jsPsych.data.addDataToLastTrial({
        		          exp_stage:"exp_end",
        		          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
        		        })
        		      }
        		    };

        		// timeline push


        		// evaluate whether any of the responses were suspicious and provide appropriate quiz
        //

      		    var eval_ss_timeline = {
      		      // timeline: [fb_warning_ss, fb_q1_ss, fb_q1_eval_ss, fb_q2_ss, fb_q2_eval_ss, fb_q3_ss, fb_q4_ss, fb_end_exp_ss],
                timeline: [fb_warning_ss, fb_q1_ss, fb_q1_eval_ss, fb_q2_ss, fb_q2_eval_ss, fb_q3_ss, fb_q4_ss],
      		      conditional_function: function(data) {
                  sus_dat = jsPsych.data.get().filter({exp_part: 'main', suspicious: true}).count()
                  if (sus_dat >= 1) {
      		          return true;
      		        } else {
      		          return false;
      		        }
      		      },
      		    };
      		    timeline.push(eval_ss_timeline);

      		    var eval_ns_timeline = {
      		      // timeline: [fb_warning_ns, fb_q1_ns, fb_q1_eval_ns, fb_q2_ns, fb_q2_eval_ns, fb_q3_ns, fb_q4_ns, fb_end_exp_ns],
                timeline: [fb_warning_ns, fb_q1_ns, fb_q1_eval_ns, fb_q2_ns, fb_q2_eval_ns, fb_q3_ns, fb_q4_ns],
      		      conditional_function: function(data) {
      		        if (sus_dat == 0) {
      		          return true;
      		        } else {
      		          return false;
      		        }
      		      },
      		    };
      		    timeline.push(eval_ns_timeline);

//// DATA SAVE AND CONCLUDE  ///////////////////////////////////////////////////////////////////////////////

  // Save data to CSV

                  function saveData_csv(name, data){
                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', 'save_data.php');
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.send(JSON.stringify({filename: name, filedata: data}));
                  }

                  /* grab data before the end of the experiment */

                  var save_data = {
                    type: 'call-function',
                    func: function(){ saveData_csv(subjectId + '_' + weekId + '_' + expId, jsPsych.data.get().csv());
                    },
                    timing_post_trial: 0,
                    on_finish: function(data) {
                      jsPsych.data.addDataToLastTrial({
                        exp_stage:"save_CSV",
                        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                        exp_part: "save"
                      })
                    }
                  };
                  timeline.push(save_data);
                  console.log('csv save successful')

                  // var dash_to_task = {
                  //   type: "html-button-response",
                  //   stimulus:
                  //     '<div id="blue"> ' +
                  //     '<div id="title">' +
                  //     "<h1>DASHBOARD</h1>" +
                  //     "<h3>If you need to take a brief rest between tasks please do so now.</h3>" +
                  //     "<h2>Click the button below to proceed to the next task.</h2>" +
                  //     "<h4>Note: you will not be paid for the time you spend on this page.</h4>" +
                  //     "</div> " +
                  //     "</div>",
                  //   button_html: '<button style="height:75px;width:400px;background-color:powderblue">%choice%</button>',
                  //   choices: ["<h1>" + nextTask_name + "</h1>"],
                  //   on_finish: function(data) {
                  //
                  //     var interaction_data = jsPsych.data.getInteractionData();
                  //     data.screen = interaction_data.json();
                  //
                  //     jsPsych.data.addDataToLastTrial({
                  //       exp_stage:"dashboard",
                  //       primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                  //       task_selected: nextTask_Id,
                  //       exp_part: "dash"
                  //     })
                  //   }
                  // }
                  // timeline.push(dash_to_task)

// // database save

    						function saveData() {
    							var xhr = new XMLHttpRequest();
    							xhr.open('POST', 'write_data_cd.php'); // change 'write_data.php' to point to php script.
    							xhr.setRequestHeader('Content-Type', 'application/json');
    							xhr.onload = function() {
    								console.log('xhr response text coming up')
    								console.log(xhr.responseText);
    								if(xhr.status == 200){
    									var response = JSON.parse(xhr.responseText);
    									console.log(xhr.responseText);
    									console.log(response.success);
    								}
    							};
    							xhr.send(jsPsych.data.get().json());
    							console.log('function finished well')
    						};

                var db_save = {
    						type: 'call-function',
    						func: saveData,
    						on_finish: function(data) {
    							jsPsych.data.addDataToLastTrial({
    								exp_stage:"save_database",
    								primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
    								exp_part: "save"
    								})
    							}
    						};
    						timeline.push(db_save)

                // var save_wait_1 = {
                //   type: 'html-keyboard-response',
                //   stimulus: "<p> You're doing great!</p>" +
                //   '<p> Please wait ~30 seconds while we save your data and load the next game.</p>' +
                //   '<p> You will be automatically redirected to the next page momentarily.</p>',
                //   choices: [jsPsych.NO_KEYS],
                //   trial_duration: 30000,
                //   response_ends_trial: false,
                //   on_finish: function(data) {
                //     jsPsych.data.addDataToLastTrial({
                //       exp_stage:"save_wait",
                //       primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                //       exp_part: "save"
                //     })
                //   }
                // };
                //
                // timeline.push(save_wait_1)


            // // data saving + compensation code
                          var save_wait_1 = {
                            type: 'html-keyboard-response',
                            stimulus: '<p> Thank you for your participation!</p>' +
                            '<p> Please wait about 30 seconds while your data is saving.</p>' +
                            '<p> You will be automatically redirected to the next page momentarily.</p>',
                            choices: [jsPsych.NO_KEYS],
                            trial_duration: 30000,
                            response_ends_trial: false,
                            on_finish: function(data) {
                              jsPsych.data.addDataToLastTrial({
                                exp_stage:"data_saving",
                                primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                                exp_part: "save"
                              })
                            }
                          };

                          var save_wait_2 = {
                          	type: 'html-button-response',
                          	stimulus: '<p> Your data has been saved!</p>' +
                          	'<p> You may click the button below to proceed to your compensation code. </p>',
                          	choices: ['Ready'],
                          	response_ends_trial: true,
                          	on_finish: function(data) {
                          		jsPsych.data.addDataToLastTrial({
                          			exp_stage:"data_saved",
                          			primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                                exp_part: "save"
                          		})
                          	}
                          };

                          var comp_code = {
                          	type: 'html-keyboard-response',
                          	stimulus: '<p> Your completion code is</p>' + comp_code + '<p> No action is necessary, you may exit this window anytime. </p>',
                          	response_ends_trial: true,
                          	on_finish: function(data) {
                          		jsPsych.data.addDataToLastTrial({
                          			exp_stage:"comp_code",
                          			primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
                                exp_part: "save"
                          		})
                          	}
                          };

                          timeline.push(save_wait_1, save_wait_2, comp_code)

                        jsPsych.init({
                          timeline: timeline,
                          // on_finish: function() {window.location.href = "itc.html" + '?workerId=' + subjectId + '&hitId=' + hitId + '&assignmentId=' + assignmentId}

                          // on_finish: function(){
                          //     jsPsych.data.displayData();
                          //     jsPsych.data.get().localSave('csv','cd_0.csv');
                          // }
                        });
              </script>

            </html>
